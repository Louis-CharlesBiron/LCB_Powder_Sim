//lcb-powder-sim ESM - v1.0.2
"undefined"==typeof window&&(self.window={},["DOMParser","IntersectionObserver","HTMLVideoElement","HTMLAudioElement","SVGImageElement","HTMLImageElement","HTMLCanvasElement","document"].forEach(t=>self[t]=class{constructor(){}}));export class CDEUtils{static DEFAULT_ACCEPTABLE_DIFFERENCE=1e-7;static CIRC=2*Math.PI;static TO_DEGREES=Math.PI/180;static getLast(t,e=0){return t[t.length-1-e]}static addAt(t,e,i=0){return t.slice(0,i).concat(e,t.slice(i))}static random(t,e,i=0){if(e+=i?0:1,i){const s=10**i;return Math.round((Math.random()*(e-t)+t)*s)/s}return Math.random()*(e-t)+t|0}static truncateDecimals(t,e=6){const i=10**e;return Math.trunc(t*i)/i}static clamp(t,e=-Infinity,i=Infinity){return t<e?e:t>i?i:t}static avg(t){let e=t.length,i=0;for(let s=0;s<e;s++)i+=t[s];return i/e}static normalize(t,e,i){return(t-e)/(i-e)}static ccw(t,e,i){return(i[1]-t[1])*(e[0]-t[0])>(e[1]-t[1])*(i[0]-t[0])}static ccw_coords(t,e,i,s,r,n){return(n-e)*(i-t)>(s-e)*(r-t)}static hasLinearIntersection(t,e,i,s){const r=CDEUtils.ccw_coords,n=t[0],a=t[1],o=e[0],l=e[1],h=i[0],_=i[1],c=s[0],u=s[1];return r(n,a,h,_,c,u)!=r(o,l,h,_,c,u)&&r(n,a,o,l,h,_)!=r(n,a,o,l,c,u)}static noDelayInterval(t,e){return e(),setInterval(e,t)}static isDefined(t){return null!=t}static isFunction(t){return"function"==typeof t}static round(t,e=0){const i=10**e;return Math.round(t*i)/i}static fade(t,e=0,i=0,s=5){return s-=i,e%2?i+s*(1-t):i+s*t}static getRatio(t,e,i=100){let s=t.pos||t,r=e.pos||e;return Math.min(1,CDEUtils.getDist(s[0],s[1],r[0],r[1])/i)}static getNearestDots(t,e=t.parent){let i=e.dots,s=i.length,r=t.x,n=t.y,a=[];for(let e=0;e<s;e++){const s=i[e];s.id!=t.id&&a.push([s,CDEUtils.getDist(r,n,s.pos[0],s.pos[1])])}return a.toSorted((t,e)=>t[1]-e[1])}static getRegulationCB(t,e=1e3){let i;return(...s)=>{clearTimeout(i),i=setTimeout(()=>t(...s),e)}}static noTimeoutInterval(t,e=1e3){return t(),setInterval(t,e)}static unlinkArr2(t){return[t[0],t[1]]}static unlinkArr3(t){return[t[0],t[1],t[2]]}static unlinkPositions(t){const e=Array.isArray,i=CDEUtils.unlinkArr2,s=t?.[0],r=t?.[1];return e(t)?[e(s)?i(s):s,e(r)?i(r):r]:t}static rotatePos(t=[0,0],e=0,i=[0,0]){const s=CDEUtils.toRad(e),r=Math.cos(s),n=Math.sin(s),a=t[0]-i[0],o=t[1]-i[1];return[a*r-o*n+i[0],a*n+o*r+i[1]]}static scalePos(t=[0,0],e=[1,1],i=[0,0]){const s=t[0]-i[0],r=t[1]-i[1];return[s*e[0]+i[0],r*e[1]+i[1]]}static getPositionsCenter(t){return[(t[0][0]+t[1][0])/2,(t[0][1]+t[1][1])/2]}static getDist(t,e,i,s){const r=t-i,n=e-s;return Math.sqrt(r*r+n*n)}static getDist_pos(t,e){const i=t[0]-e[0],s=t[1]-e[1];return Math.sqrt(i*i+s*s)}static getLinearFn(t,e){const i=(e[1]-t[1])/(e[0]-t[0]),s=-i*t[0]+t[1];return[i,s,t=>i*t+s,t]}static getLinearFn_coords(t,e,i,s){const r=(s-e)/(i-t),n=-r*t+e;return[r,n,t=>r*t+n,[t,e]]}static getPerpendicularLinearFn(t){const e=-1/t[0],i=t[3],s=-e*i[0]+i[1];return[e,s,t=>e*t+s,i]}static getValueFromRange(t){return Array.isArray(t)?CDEUtils.random(t[0],t[1]):t}static arrayEquals(t,e){return t.length===e.length&&t.every((t,i)=>t==e[i])}static addPos(t,e){return[(t[0]||0)+(e[0]||0),(t[1]||0)+(e[1]||0)]}static subPos(t,e){return[(t[0]||0)-(e[0]||0),(t[1]||0)-(e[1]||0)]}static mulPos(t,e){return[(t[0]||0)*(e[0]||0),(t[1]||0)*(e[1]||0)]}static divPos(t,e){return[(t[0]||0)/(e[0]||0),(t[1]||0)/(e[1]||0)]}static posEquals(t,e){return e&&t&&t[0]==e[0]&&t[1]==e[1]}static positionsEquals(t,e){return t&&e&&t[0][0]==e[0][0]&&t[0][1]==e[0][1]&&t[1][0]==e[1][0]&&t[1][1]==e[1][1]}static mod(t,e,i=t){return t-e*i-(i<0)*t}static toRad(t){return t*CDEUtils.TO_DEGREES}static toDeg(t){return t/CDEUtils.TO_DEGREES}static getAcceptableDiff(t,e=CDEUtils.DEFAULT_ACCEPTABLE_DIFFERENCE){const i=Math.round(t);return i-t<=e?i:t}static getMinMax(t,e=null){let i=Infinity,s=-Infinity,r=t.length;for(let n=0;n<r;n++){const r=e?+t[n][e]:t[n];r<i&&(i=r),r>s&&(s=r)}return[i,s]}static repeatedTimeout(t,e,i=5){let s=0;for(let r=0;r<t;r++)setTimeout(()=>e(r),s+=i)}static stackTraceLog(...t){try{throw new Error("stackTraceLog")}catch(e){console.log(e,...t)}}}export class FPSCounter{static COMMON_REFRESH_RATES=[30,60,75,90,120,144,165,240,360,480,500];static ABNORMAL_FLUCTUATION_THRESHOLD=20;constructor(t){this._averageSampleSize=t||10,this._times=[],this._averageSample=[],this._maxFps=0}getFpsRaw(){let t,e=performance.now();for(;this._times.length&&this._times[0]<=e-1e3;)this._times.shift();return t=this._times.push(e),this._maxFps<t&&(this._maxFps=t),t}getFps(){const t=this._averageSample;return t.push(this.getFpsRaw()),t.length>this._averageSampleSize&&t.shift(),0|Math.min(CDEUtils.avg(t),this._maxFps)}getApproximatedUserRefreshRate(t=this.maxFps){return performance.now()>1e3?FPSCounter.COMMON_REFRESH_RATES.reduce((e,i)=>e<t-1?i:e,null):null}getRecommendedFPS(t=!0,e=8){if(performance.now()>1e3){const i=FPSCounter.COMMON_REFRESH_RATES,s=this._averageSample.reduce((t,e)=>t+e,0)/this._averageSampleSize;return s&&t?i[i.indexOf(i.reduce((t,i)=>t<s+e?i:t,null))-1]||i[0]:this.getApproximatedUserRefreshRate(s)}return null}runRecommendedFPSEvaluation(t,e=1e4,i=10,s=!0,r=8){i=i?i|=0:10,e<i&&(e=i);const n=e/i,a=[];for(let i=n;i<=e;i+=n)setTimeout(()=>{if(a.push(this.getRecommendedFPS(s,r)),i>=e&&CDEUtils.isFunction(t)){const[e,i]=CDEUtils.getMinMax(a),s=CDEUtils.avg(a),n=this.getApproximatedUserRefreshRate(s-r);t({recommendedValue:n,stats:{rawResults:a,min:e,max:i,avg:s}})}},1e3+i)}[Symbol.toPrimitive](){return this.getFps()}*[Symbol.iterator](){const t=this._times,e=t.length;for(let i=0;i<e;i++)yield t[i]}get[Symbol.toStringTag](){return this.instanceOf}get instanceOf(){return"FPSCounter"}get maxFps(){return this._maxFps-1}get averageSampleSize(){return this._averageSampleSize}get fpsRaw(){return this._times.length}set averageSampleSize(t){this._averageSampleSize=t}}export class CanvasUtils{static SHOW_CENTERS_DOT_ID={};static toggleCenter(t,e,i=5,s=[255,0,0,1]){if(CanvasUtils.SHOW_CENTERS_DOT_ID[e.id])t.remove(CanvasUtils.SHOW_CENTERS_DOT_ID[e.id]),delete CanvasUtils.SHOW_CENTERS_DOT_ID[e.id];else{const r=new Dot([0,0],i,s,null,e);CanvasUtils.SHOW_CENTERS_DOT_ID[e.id]=r.id,t.add(r)}}static showIntersectionPoints(t,e){const i=new Dot(e[0][0],3,[255,0,0,1]),s=new Dot(e[0][1],3,[255,0,0,.45]),r=new Dot(e[1][1],3,[255,0,0,.45]),n=new Dot(e[1][0],3,[255,0,0,1]);t.add(i),t.add(s),t.add(r),t.add(n)}static firstDotOnly(t){return t.id==t.parent.firstDot.id}static drawOuterRing(t,e,i=1,s=!1){const r=e.colorObject??e,n=Color.OPACITY_VISIBILITY_THRESHOLD,a=e._filter;r[3]<n||r.a<n||(a&&-1!==a.indexOf("#")&&!s?t.render.stroke(Render.getArc(t.pos,(t.radius||1)*i),e):t.render.batchStroke(Render.getArc(t.pos,(t.radius||1)*i),e))}static drawLine(t,e,i,s=0,r=Render.getLine,n,a){const o=i.colorObject??i,l=Color.OPACITY_VISIBILITY_THRESHOLD,h=i._filter;if(!(o[3]<l||o.a<l))if(s){const o=t.getLinearIntersectPoints(e,Math.max(e.radius??_Obj.DEFAULT_RADIUS,.1)*s,t,Math.max(t.radius*s,.1));h&&-1!==h.indexOf("#")&&!a?t.render.stroke(r(o[0][0],o[1][0],n),i):t.render.batchStroke(r(o[0][0],o[1][0],n),i)}else h&&-1!==h.indexOf("#")&&!a?t.render.stroke(r(t.pos,e.pos??e,n),i):t.render.batchStroke(r(t.pos,e.pos??e,n),i)}static drawDotConnections(t,e,i=0,s=Render.getLine,r,n){const a=t.render,o=t.pos,l=t.connections,h=t.connections.length,_=e.colorObject??e,c=Color.OPACITY_VISIBILITY_THRESHOLD,u=e._filter,E=u&&-1!==u.indexOf("#");if(s||(s=Render.getLine),h){if(_[3]<c||_.a<c)return;if(i){const o=t.radius*i;for(let _=0;_<h;_++){const h=l[_],c=t.getLinearIntersectPoints(h,h.radius*i,t,o);E&&!n?a.stroke(s(c[0][0],c[1][0],r),e):a.batchStroke(s(c[0][0],c[1][0],r),e)}}else for(let t=0;t<h;t++)E&&!n?a.stroke(s(o,l[t].pos,r),e):a.batchStroke(s(o,l[t].pos,r),e)}}static getDraggableDotCB(t=!0){let e=!1,i=null;return t?(t,s,r,n,a=20)=>{const o=s.holdValue.draggedObjId;s.clicked&&(!o&&r<a||o==t.id)?(s.holdValue.draggedObjId=t.id,e=!0,t?.currentBacklogAnim?.id==i?.id&&i&&i.end(),s.valid&&(t.x=s.x,t.y=s.y)):e?(s.holdValue.draggedObjId=null,e=!1,i=t.addForce(Math.min(CDEUtils.mod(Math.min(s.speed,3e3),n)/4,300),s.dir,750+1200*n,Anim.easeOutQuad)):!s.clicked&&o&&(s.holdValue.draggedObjId=null)}:(t,s,r,n,a=50)=>{s.clicked&&r<a?(e=!0,t?.currentBacklogAnim?.id==i?.id&&i&&i.end(),s.valid&&(t.x=s.x,t.y=s.y)):e&&(e=!1,i=t.addForce(Math.min(CDEUtils.mod(Math.min(s.speed,3e3),n)/4,300),s.dir,750+1200*n,Anim.easeOutQuad))}}static getTrailEffectCB(t,e,i=8,s=null,r=!1){let n=[],a=new Array(i).fill(e.pos),o=null,l=CDEUtils.posEquals,h=!r;for(let s=0;s<i;s++){const i=e.duplicate();n.push(i),t.add(i)}return t=>{let r=CDEUtils.unlinkArr2(e.pos),_=!1;if(!l(o,r)){if(a.shift(),a.push(r),h)for(let t=0;t<i;t++)n[t].moveAt(a[t]);o=r,_=!0}if(s)for(let e=0;e<i;e++)s(n[e],(e+1)/i,_,t,a[e],e)}}static getMovementOscillatorCB(t,e=[100,100],i=!0){const s=e[0],r=e[1];if(i){let e;return(i,n)=>{const a=n%2?1-i:i;null==e&&(e=a);const o=a-e;s&&(t.x+=s*o),r&&(t.y+=r*o),e=a}}{const e=t.x,i=t.y;return(n,a)=>{const o=a%2?1-n:n;s&&(t.x=e+s*o),r&&(t.y=i+r*o)}}}static rotateGradient(t,e=1e3,i=1,s=!1){return t.playAnim(new Anim(e=>t[s?"fillColorRaw":"colorRaw"].rotation=360*-i*e,e))}static lookAt(t,e,i=0){const s=e?.pos??e;t.rotation=i-CDEUtils.toDeg(Math.atan2(t.pos[1]-s[1],-(t.pos[0]-s[0])))}static drawOutline(t,e,i=[255,0,0,1]){const s=e.getBounds();t.batchStroke(Render.getPositionsRect(s[0],s[1]),i?.color||i)}static drawOutlineAccurate(t,e,i=[0,50,255,1]){t.batchStroke(e.getBoundsAccurate(),i?.color||i)}static drawPos(t,e,i=[255,0,0,1],s){t.batchStroke(Render.getArc(e,s),i?.color||i)}static SHAPES={DEBUG_SHAPE:(t,e)=>new Shape(t||[100,100],e||[new Dot,new Dot([100]),new Dot([,100]),new Dot([100,100])]),THROWABLE_DOT:(t,e,i)=>{const s=CanvasUtils.getDraggableDotCB();return new Shape(t||[10,10],new Dot,e,i,null,(t,e,i,r,n,a,o)=>s(o.firstDot,n,a,i))}};static createDrawingBoard(t,e=[[0,0],t.size],i=[255,0,0,1],s=Math.min(1,(t.fpsLimit||60)/15),r=Color.DEFAULT_RGBA){let n=0,a=t.render,o=Canvas.STATIC,l=0,h=new Shape(null,[new Dot(e[0]),new Dot(e[1])],0,null,0,null,null,()=>[],()=>{for(let t=0;t<n;t++)a.batchStroke(h.setupResults[t],i);r&&(r.a||r[3])&&CanvasUtils.drawOutline(a,h,r)},null,!0);t.add(h);const _=t.mouse.addListener(h,Mouse.LISTENER_TYPES.DOWN,t=>{const e=new Path2D,s=t[0],r=t[1];e.moveTo(s,r),e.arc(s,r,(i.lineWidth||a.defaultProfile.lineWidth)/4,0,CDEUtils.CIRC),n=h.setupResults.push(e)}),c=t.mouse.addListener(h,Mouse.LISTENER_TYPES.ENTER,(t,e,i)=>{if(i.clicked){const e=new Path2D,i=t[0],s=t[1];e.moveTo(i,s),n=h.setupResults.push(e)}}),u=t.mouse.addListener(h,Mouse.LISTENER_TYPES.MOVE,(e,r,_)=>{if(++l==s){const s=_.lastPos,r=h.setupResults[n-1];if(r&&_.clicked&&h.isWithin(s)&&(r.lineTo(e[0],e[1],s[0],s[1]),t.fpsLimit==o))for(let t=0;t<n;t++)a.stroke(h.setupResults[t],i);l=0}});return{obj:h,mouseListeners:{click:_,enter:c,move:u}}}static createEmptyObj(t,e,i){const s=new Shape(null,null,0,null,0,null,void 0,e,i,null,!0);return t.add(s),s}static createButton(t,e="Button",i=t.getCenter(),s=null,r="aliceblue",n="black",a=[20,30],o=null,l=!1){const h=new TextDisplay(e,[0,0],n,null,null,null,e=>{const[n,h]=e.trueSize,_=n/2+a[1]/2,c=h/2+a[0]/2,u=t.add(new FilledShape(r,!0,i,[new Dot([-_,-c]),new Dot([_,-c]),new Dot([_,c]),new Dot([-_,c])],0,r,null,null,null,null,null,null,!0)),E=i=>{l||(u.fillColorObject.brightness=i?85:100,t.setCursorStyle(i?Canvas.CURSOR_STYLES.POINTER:Canvas.CURSOR_STYLES.DEFAULT)),CDEUtils.isFunction(o)&&o(i,u,e)},d=t=>{l||(u.fillColorObject.brightness=t?70:85),t&&CDEUtils.isFunction(s)&&s(u,e)};return t.mouse.addListener(u,Mouse.LISTENER_TYPES.DOWN,()=>d(!0)),t.mouse.addListener(u,Mouse.LISTENER_TYPES.UP,()=>d(!1)),t.mouse.addListener(u,Mouse.LISTENER_TYPES.ENTER,()=>E(!0)),t.mouse.addListener(u,Mouse.LISTENER_TYPES.LEAVE,()=>E(!1)),u},null,t=>t.setupResults);return t.add(h),[h.setupResults,h]}static getCollisionCB(t,e=null,i,s,r,n){const a=t instanceof _BaseObj?t.getBounds():t,o=CDEUtils.isFunction(i),l=CDEUtils.isFunction(s),h=CDEUtils.isFunction(r);e&&(e="number"==typeof e?[e,e,e,e]:[e[0],e[1]??e[0],e[2]??e[0],e[3]??e[1]],a[0][0]-=e[3],a[0][1]-=e[0],a[2][0]+=e[1],a[2][1]-=e[0],a[1][0]+=e[1],a[1][1]+=e[2],a[3][0]-=e[3],a[3][1]+=e[2]);let _=0,c=!1;return t=>{const e=t[0],u=t[1],E=(u>=a[0][1]&&1)+(e<=a[1][0]&&2)+(u<=a[1][1]&&4)+(e>=a[0][0]&&8);15==E?(l&&!c&&s(_),c=!0,o&&i(_)):(_=15^E,n&&(3==_||9==_?_=1:6!=_&&12!=_||(_=4)),h&&c&&r(_),c=!1)}}static FOLLOW_PATHS={INFINITY_SIGN:(t,e,i)=>(t??=100,e??=50,i??=0,[[0,s=>{const r=CDEUtils.CIRC*((s+i)%1);return[t*Math.sin(r),e*Math.sin(2*r)]}]]),CIRCLE:(t,e,i)=>(t??=100,e??=100,i??=0,[[0,s=>{const r=CDEUtils.CIRC*((s+i)%1);return[t*Math.cos(r),e*Math.sin(r)]}]]),RECTANGLE:(t,e,i)=>(t??=100,e??=100,i??=0,[[0,s=>{const r=(s+i)%1*2*(t+e);return r<t?[r,0]:r<t+e?[t,r-t]:r<2*t+e?[t-(r-(t+e)),e]:[0,e-(r-(2*t+e))]}]]),QUADRATIC:(t,e,i)=>{t??=100,e??=200;const s=Math.pow(t/2,2);return[[0,r=>{let n=(r-.5)*t,a=e*(Math.pow(n,2)/s);return i&&(a=e-a),[n,a]}]]},LINEAR:(t,e)=>(t??=100,e??=1,[[0,i=>{const s=i*t;return[s,e*s]}]]),SINE_WAVE:(t,e)=>(t??=100,e??=100,[[0,i=>{const s=i*t;return[s,e*Math.sin(CDEUtils.CIRC*s/t)]}]]),COSINE_WAVE:(t,e)=>(t??=100,e??=100,[[0,i=>{const s=i*t;return[s,e*Math.cos(CDEUtils.CIRC*s/t)]}]]),RELATIVE:(t,e)=>{t??=void 0,e??=void 0;let i=!1,s=!1;return Array.isArray(t)&&(t=t.flat()[1],i=!0),Array.isArray(e)&&(e=e.flat()[1],s=!0),[[0,r=>[i?t(r)[0]:t,s?e(r)[1]:t]]]}}}export class Color{static DEFAULT_COLOR="aliceblue";static DEFAULT_RGBA=[240,248,255,1];static DEFAULT_COLOR_VALUE="rgba(240, 248, 255, 1)";static CSS_COLOR_TO_RGBA_CONVERTIONS={transparent:[0,0,0,0],aliceblue:[240,248,255,1],antiquewhite:[250,235,215,1],aqua:[0,255,255,1],aquamarine:[127,255,212,1],azure:[240,255,255,1],beige:[245,245,220,1],bisque:[255,228,196,1],black:[0,0,0,1],blanchedalmond:[255,235,205,1],blue:[0,0,255,1],blueviolet:[138,43,226,1],brown:[165,42,42,1],burlywood:[222,184,135,1],cadetblue:[95,158,160,1],chartreuse:[127,255,0,1],chocolate:[210,105,30,1],coral:[255,127,80,1],cornflowerblue:[100,149,237,1],cornsilk:[255,248,220,1],crimson:[220,20,60,1],cyan:[0,255,255,1],darkblue:[0,0,139,1],darkcyan:[0,139,139,1],darkgoldenrod:[184,134,11,1],darkgray:[169,169,169,1],darkgreen:[0,100,0,1],darkkhaki:[189,183,107,1],darkmagenta:[139,0,139,1],darkolivegreen:[85,107,47,1],darkorange:[255,140,0,1],darkorchid:[153,50,204,1],darkred:[139,0,0,1],darksalmon:[233,150,122,1],darkseagreen:[143,188,143,1],darkslateblue:[72,61,139,1],darkslategray:[47,79,79,1],darkturquoise:[0,206,209,1],darkviolet:[148,0,211,1],deeppink:[255,20,147,1],deepskyblue:[0,191,255,1],dimgray:[105,105,105,1],dodgerblue:[30,144,255,1],firebrick:[178,34,34,1],floralwhite:[255,250,240,1],forestgreen:[34,139,34,1],fuchsia:[255,0,255,1],gainsboro:[220,220,220,1],ghostwhite:[248,248,255,1],gold:[255,215,0,1],goldenrod:[218,165,32,1],gray:[128,128,128,1],grey:[128,128,128,1],green:[0,128,0,1],greenyellow:[173,255,47,1],honeydew:[240,255,240,1],hotpink:[255,105,180,1],indianred:[205,92,92,1],indigo:[75,0,130,1],ivory:[255,255,240,1],khaki:[240,230,140,1],lavender:[230,230,250,1],lavenderblush:[255,240,245,1],lawngreen:[124,252,0,1],lemonchiffon:[255,250,205,1],lightblue:[173,216,230,1],lightcoral:[240,128,128,1],lightcyan:[224,255,255,1],lightgoldenrodyellow:[250,250,210,1],lightgray:[211,211,211,1],lightgreen:[144,238,144,1],lightpink:[255,182,193,1],lightsalmon:[255,160,122,1],lightseagreen:[32,178,170,1],lightskyblue:[135,206,250,1],lightslategray:[119,136,153,1],lightsteelblue:[176,224,230,1],lightyellow:[255,255,224,1],lime:[0,255,0,1],limegreen:[50,205,50,1],linen:[250,240,230,1],magenta:[255,0,255,1],maroon:[128,0,0,1],mediumaquamarine:[102,205,170,1],mediumblue:[0,0,205,1],mediumorchid:[186,85,211,1],mediumpurple:[147,112,219,1],mediumseagreen:[60,179,113,1],mediumslateblue:[123,104,238,1],mediumspringgreen:[0,250,154,1],mediumturquoise:[72,209,204,1],mediumvioletred:[199,21,133,1],midnightblue:[25,25,112,1],mintcream:[245,255,250,1],mistyrose:[255,228,225,1],moccasin:[255,228,181,1],navajowhite:[255,222,173,1],navy:[0,0,128,1],oldlace:[253,245,230,1],olive:[128,128,0,1],olivedrab:[107,142,35,1],orange:[255,165,0,1],orangered:[255,69,0,1],orchid:[218,112,214,1],palegoldenrod:[238,232,170,1],palegreen:[152,251,152,1],paleturquoise:[175,238,238,1],palevioletred:[219,112,147,1],papayawhip:[255,239,213,1],peachpuff:[255,218,185,1],peru:[205,133,63,1],pink:[255,192,203,1],plum:[221,160,221,1],powderblue:[176,224,230,1],purple:[128,0,128,1],rebeccapurple:[102,51,153,1],red:[255,0,0,1],rosybrown:[188,143,143,1],royalblue:[65,105,225,1],saddlebrown:[139,69,19,1],salmon:[250,128,114,1],sandybrown:[244,164,96,1],seagreen:[46,139,87,1],seashell:[255,245,238,1],sienna:[160,82,45,1],silver:[192,192,192,1],skyblue:[135,206,235,1],slateblue:[106,90,205,1],slategray:[112,128,144,1],snow:[255,250,250,1],springgreen:[0,255,127,1],steelblue:[70,130,180,1],tan:[210,180,140,1],teal:[0,128,128,1],thistle:[216,191,216,1],tomato:[255,99,71,1],turquoise:[64,224,208,1],violet:[238,130,238,1],wheat:[245,222,179,1],white:[255,255,255,1],whitesmoke:[245,245,245,1],yellow:[255,255,0,1],yellowgreen:[154,205,50,1]};static RGBA_TO_CSS_COLOR_CONVERTIONS={"0,0,0,0":"transparent","240,248,255,1":"aliceblue","250,235,215,1":"antiquewhite","0,255,255,1":"aqua","127,255,212,1":"aquamarine","240,255,255,1":"azure","245,245,220,1":"beige","255,228,196,1":"bisque","0,0,0,1":"black","255,235,205,1":"blanchedalmond","0,0,255,1":"blue","138,43,226,1":"blueviolet","165,42,42,1":"brown","222,184,135,1":"burlywood","95,158,160,1":"cadetblue","127,255,0,1":"chartreuse","210,105,30,1":"chocolate","255,127,80,1":"coral","100,149,237,1":"cornflowerblue","255,248,220,1":"cornsilk","220,20,60,1":"crimson","0,0,139,1":"darkblue","0,139,139,1":"darkcyan","184,134,11,1":"darkgoldenrod","169,169,169,1":"darkgray","0,100,0,1":"darkgreen","189,183,107,1":"darkkhaki","139,0,139,1":"darkmagenta","85,107,47,1":"darkolivegreen","255,140,0,1":"darkorange","153,50,204,1":"darkorchid","139,0,0,1":"darkred","233,150,122,1":"darksalmon","143,188,143,1":"darkseagreen","72,61,139,1":"darkslateblue","47,79,79,1":"darkslategray","0,206,209,1":"darkturquoise","148,0,211,1":"darkviolet","255,20,147,1":"deeppink","0,191,255,1":"deepskyblue","105,105,105,1":"dimgray","30,144,255,1":"dodgerblue","178,34,34,1":"firebrick","255,250,240,1":"floralwhite","34,139,34,1":"forestgreen","220,220,220,1":"gainsboro","248,248,255,1":"ghostwhite","255,215,0,1":"gold","218,165,32,1":"goldenrod","128,128,128,1":"gray","0,128,0,1":"green","173,255,47,1":"greenyellow","240,255,240,1":"honeydew","255,105,180,1":"hotpink","205,92,92,1":"indianred","75,0,130,1":"indigo","255,255,240,1":"ivory","240,230,140,1":"khaki","230,230,250,1":"lavender","255,240,245,1":"lavenderblush","124,252,0,1":"lawngreen","255,250,205,1":"lemonchiffon","173,216,230,1":"lightblue","240,128,128,1":"lightcoral","224,255,255,1":"lightcyan","250,250,210,1":"lightgoldenrodyellow","211,211,211,1":"lightgray","144,238,144,1":"lightgreen","255,182,193,1":"lightpink","255,160,122,1":"lightsalmon","32,178,170,1":"lightseagreen","135,206,250,1":"lightskyblue","119,136,153,1":"lightslategray","176,224,230,1":"lightsteelblue","255,255,224,1":"lightyellow","0,255,0,1":"lime","50,205,50,1":"limegreen","250,240,230,1":"linen","255,0,255,1":"magenta","128,0,0,1":"maroon","102,205,170,1":"mediumaquamarine","0,0,205,1":"mediumblue","186,85,211,1":"mediumorchid","147,112,219,1":"mediumpurple","60,179,113,1":"mediumseagreen","123,104,238,1":"mediumslateblue","0,250,154,1":"mediumspringgreen","72,209,204,1":"mediumturquoise","199,21,133,1":"mediumvioletred","25,25,112,1":"midnightblue","245,255,250,1":"mintcream","255,228,225,1":"mistyrose","255,228,181,1":"moccasin","255,222,173,1":"navajowhite","0,0,128,1":"navy","253,245,230,1":"oldlace","128,128,0,1":"olive","107,142,35,1":"olivedrab","255,165,0,1":"orange","255,69,0,1":"orangered","218,112,214,1":"orchid","238,232,170,1":"palegoldenrod","152,251,152,1":"palegreen","175,238,238,1":"paleturquoise","219,112,147,1":"palevioletred","255,239,213,1":"papayawhip","255,218,185,1":"peachpuff","205,133,63,1":"peru","255,192,203,1":"pink","221,160,221,1":"plum","128,0,128,1":"purple","102,51,153,1":"rebeccapurple","255,0,0,1":"red","188,143,143,1":"rosybrown","65,105,225,1":"royalblue","139,69,19,1":"saddlebrown","250,128,114,1":"salmon","244,164,96,1":"sandybrown","46,139,87,1":"seagreen","255,245,238,1":"seashell","160,82,45,1":"sienna","192,192,192,1":"silver","135,206,235,1":"skyblue","106,90,205,1":"slateblue","112,128,144,1":"slategray","255,250,250,1":"snow","0,255,127,1":"springgreen","70,130,180,1":"steelblue","210,180,140,1":"tan","0,128,128,1":"teal","216,191,216,1":"thistle","255,99,71,1":"tomato","64,224,208,1":"turquoise","238,130,238,1":"violet","245,222,179,1":"wheat","255,255,255,1":"white","245,245,245,1":"whitesmoke","255,255,0,1":"yellow","154,205,50,1":"yellowgreen"};static FORMATS={RGBA:"RGBA",TEXT:"TEXT",HEX:"HEX",GRADIENT:"GRADIENT",PATTERN:"PATTERN",COLOR:"COLOR",HSV:"HSVA"};static CONVERTABLE_FORMATS={RGBA:"RGBA",TEXT:"TEXT",HEX:"HEX",HSV:"HSVA"};static STRICT_FORMATS={RGBA:"RGBA",COLOR:"COLOR"};static DEFAULT_TEMPERANCE=0;static SEARCH_STARTS={TOP_LEFT:"TOP_LEFT",BOTTOM_RIGHT:"BOTTOM_RIGHT"};static DEFAULT_SEARCH_START=Color.SEARCH_STARTS.TOP_LEFT;static DEFAULT_DECIMAL_ROUNDING_POINT=3;static OPACITY_VISIBILITY_THRESHOLD=.029;#t=null;#e=null;constructor(t,e=!1){const i=Color.getFormat(t);this._color=t instanceof Color?t._color:i&&t||Color.DEFAULT_COLOR,this._format=i||Color.getFormat(this._color),this.#i(),this._isChannel=e||!1}#i(){const t=Color.FORMATS,e=this._format;if(e==t.GRADIENT||e==t.PATTERN)this.#t=this.#e=[];else{this.#t=e!=t.RGBA?this.convertTo():Color.#s(this._color);const i=this.#t,s=Color.DEFAULT_DECIMAL_ROUNDING_POINT,r=CDEUtils.round,n=i[3];i[0]=r(i[0],s),i[1]=r(i[1],s),i[2]=r(i[2],s),i[3]=null!=n?r(n,s):1,this.#e=Color.convertTo(i,t.HSV)}}static convertTo(t,e=Color.CONVERTABLE_FORMATS.RGBA){let i=Color.getFormat(t),s=t,r=Color.CONVERTABLE_FORMATS,n=r.RGBA,a=r.HEX,o=r.TEXT,l=r.HSV;return i&&(e==n?i==a?s=Color.#r(t):i==o?s=Color.#s(Color.CSS_COLOR_TO_RGBA_CONVERTIONS[t]):i==l&&(s=Color.#n(t)):e==a?s=i==n?Color.#a(t):Color.#a(Color.convertTo(t,n)):e==o?s=i==n?Color.RGBA_TO_CSS_COLOR_CONVERTIONS[t.toString()]??t:Color.RGBA_TO_CSS_COLOR_CONVERTIONS[Color.convertTo(t,n).toString()]??t:e==l&&(s=i==n?Color.#o(t):Color.#o(Color.convertTo(t,n)))),s}convertTo(t=this._color,e=Color.CONVERTABLE_FORMATS.RGBA){return Color.convertTo(t,e)}static random(t=Color.CONVERTABLE_FORMATS.RGBA,e=!1,i=[0,255],s=[0,255],r=[0,255],n=[0,1]){const a=Color.CONVERTABLE_FORMATS,o=CDEUtils.random,l=[o(...i),o(...s),o(...r),e?o(...n,2):1];return t==a.HEX?Color.convertTo(l,a.HEX):t==a.TEXT?Color.convertTo(l,a.TEXT):t==a.HSV?Color.convertTo(l,a.HSV):l}static#s(t){return t?[t[0],t[1],t[2],t[3]]:null}static#o(t){let e,i=t[0]/255,s=t[1]/255,r=t[2]/255,n=Math.min(i,s,r),a=Math.max(i,s,r),o=a-n;return a==n?e=0:(e=a==i?(s-r)/o:a==s?(r-i)/o+2:(i-s)/o+4,e=(360+60*e)%360),[e,a&&o/a*100,100*a]}static#n(t){let e,i,s,r=t[0],n=t[1]/100,a=t[2]/100,o=a*n,l=o*(1-Math.abs(r/60%2-1)),h=a-o;return 0<=r&&r<60?(e=o,i=l,s=0):60<=r&&r<120?(e=l,i=o,s=0):120<=r&&r<180?(e=0,i=o,s=l):180<=r&&r<240?(e=0,i=l,s=o):240<=r&&r<300?(e=l,i=0,s=o):(e=o,i=0,s=l),[Math.round(255*(e+h)),Math.round(255*(i+h)),Math.round(255*(s+h)),1]}static#a(t){let e=(0|t[0]).toString(16),i=(0|t[1]).toString(16),s=(0|t[2]).toString(16),r=t[3],n="#"+(e.length<2?"0"+e:e)+(i.length<2?"0"+i:i)+(s.length<2?"0"+s:s);if(1!=r){const t=Math.round(255*r).toString(16);n+=t.length<2?"0"+t:t}return n}static#r(t){"#"!=t[0]&&(t="#"+t);const e=[],i=t.length-1,s=4==i||8==i;if(i<6)for(let r=1;r<=i;r++){let n=t[r],a=parseInt(n+n,16);s&&r==i&&(a=Math.round(a/255*100)/100),e.push(a)}else for(let r=1;r<i;r+=2){let n=parseInt(t[r]+t[r+1],16);s&&r+1==i&&(n=Math.round(n/255*100)/100),e.push(n)}return e}static getFormat(t){const e=Color.FORMATS;return t?Array.isArray(t)?4==t.length?e.RGBA:e.HSV:t instanceof Color?e.COLOR:t instanceof Gradient?e.GRADIENT:t instanceof Pattern?e.PATTERN:"#"==t[0]?e.HEX:Color.CSS_COLOR_TO_RGBA_CONVERTIONS[t]?e.TEXT:null:null}static uniquify(t){return t instanceof Color?t.isChannel?t:t.duplicate():new Color(t)}static rgbaAdd(t,e=0,i=0,s=0,r=0){const n=(t,e)=>CDEUtils.clamp(t,0,e?1:255);return[n(t[0]+(e||0)),n(t[1]+(i||0)),n(t[2]+(s||0)),n(t[3]+(r||0),!0)]}static rgbaAddAll(t,e=0){const i=(t,e)=>CDEUtils.clamp(t,0,e?1:255);return[i(t[0]+(e||0)),i(t[1]+(e||0)),i(t[2]+(e||0)),t[3]]}static rgbaSet(t,e,i,s,r){const n=(t,e)=>CDEUtils.clamp(t,0,e?1:255);return[n(e??t[0]??0),n(i??t[1]??0),n(s??t[2]??0),n(r??t[3]??1,!0)]}static rgbaHsvAdd(t,e,i,s){const r=Color.#o(t);return r[0]=(r[0]+(e??0))%360||0,r[1]=CDEUtils.clamp(r[1]+(i??0),0,100)||0,r[2]=CDEUtils.clamp(r[2]+(s??0),0,100)||0,Color.rgbaSet(Color.#n(r),null,null,null,t[3])}static formatRgba(t){return Array.isArray(t)?`rgba(${t[0]??255}, ${t[1]??255}, ${t[2]??255}, ${t[3]??1})`:null}static rgba(t=255,e=255,i=255,s=1){const r=CDEUtils.round,n=Color.DEFAULT_DECIMAL_ROUNDING_POINT;return[r(t,n),r(e,n),r(i,n),r(s,n)]}static getColorValue(t){return"string"==typeof t||t instanceof CanvasGradient||t instanceof CanvasPattern?t:t instanceof _DynamicColor?t.value:Color.formatRgba(t)??t.color}static findFirstPos(t,e,i=!1,s=Color.DEFAULT_TEMPERANCE,r=Color.DEFAULT_SEARCH_START,n=[]){let a,o,l,h,_,c,u,E,d=n[0]??t.width,T=n[1]??t.height,S=t.ctx.getImageData(0,0,d,T).data,A=4*d,p=e.r??e[0],g=e.g??e[1],R=e.b??e[2],C=255*(e.a??e[3]),D=p-s,I=g-s,m=R-s,O=C-s,P=p+s,f=g+s,L=R+s,y=C+s,N=r==Color.SEARCH_STARTS.TOP_LEFT,b=N?0:d-1,U=N?d:-1,M=N?1:-1,v=N?T:-1,F=N?1:-1;for(o=N?0:T-1;o!=v;o+=F)for(l=o*A,a=b;a!=U;a+=M)if(h=l+4*a,_=S[h],s){if(_>=D&&_<=P&&(c=S[h+1],u=S[h+2],c>=I&&c<=f&&u>=m&&u<=L&&(!i||E>=O&&E<=y)))return[a,o]}else if(_==p&&S[h+1]==g&&S[h+2]==R&&(!i||S[h+3]==C))return[a,o];return null}duplicate(t){const e=Color.FORMATS,i=this._format;return i==e.GRADIENT||i==e.PATTERN?new Color(this._color.duplicate(t)):new Color(Color.#s(this.#t))}toString(){let t=Color.getColorValue(this._color);return(t instanceof CanvasGradient||t instanceof CanvasPattern)&&(t=this._color.toString()),t}[Symbol.toPrimitive](){return this.color}*[Symbol.iterator](){const t=this.#t;for(let e=0;e<4;e++)yield t[e]}get[Symbol.toStringTag](){return this.instanceOf}get instanceOf(){return"Color"}get color(){const t=Color.FORMATS,e=this._format;return e==t.GRADIENT||e==t.PATTERN?this._color.value:Color.formatRgba(this.#t)}get colorRaw(){return this._color}get isChannel(){return this._isChannel}get rgba(){return this.#t}get hsv(){return this.#e}get r(){return this.#t[0]}get g(){return this.#t[1]}get b(){return this.#t[2]}get a(){return this.#t[3]}get hue(){return this.#e[0]}get saturation(){return this.#e[1]}get brightness(){return this.#e[2]}set color(t){const e=t?._color||t,i=Color.getFormat(e);i&&(this._color=e,this._format=i,this.#i())}set r(t){this.#t[0]=CDEUtils.round(t,Color.DEFAULT_DECIMAL_ROUNDING_POINT)}set g(t){this.#t[1]=CDEUtils.round(t,Color.DEFAULT_DECIMAL_ROUNDING_POINT)}set b(t){this.#t[2]=CDEUtils.round(t,Color.DEFAULT_DECIMAL_ROUNDING_POINT)}set a(t){this.#t[3]=CDEUtils.round(t,Color.DEFAULT_DECIMAL_ROUNDING_POINT)}set rgba(t){this.#t[0]=CDEUtils.round(t[0],Color.DEFAULT_DECIMAL_ROUNDING_POINT),this.#t[1]=CDEUtils.round(t[1],Color.DEFAULT_DECIMAL_ROUNDING_POINT),this.#t[2]=CDEUtils.round(t[2],Color.DEFAULT_DECIMAL_ROUNDING_POINT),this.#t[3]=CDEUtils.round(t[3],Color.DEFAULT_DECIMAL_ROUNDING_POINT)}set hue(t){t%=360,this.#e[0]!=t&&(this.#e[0]=t,this.#t=Color.#n(this.#e))}set saturation(t){t=t>100?100:t,this.#e[1]!=t&&(this.#e[1]=t,this.#t=Color.#n(this.#e))}set brightness(t){t=t>100?100:t,this.#e[2]!=t&&(this.#e[2]=t,this.#t=Color.#n(this.#e))}}const colors=Object.entries(Color.CSS_COLOR_TO_RGBA_CONVERTIONS),c_ll=colors.length;for(let t=0;t<c_ll;t++){const e=colors[t];Object.defineProperty(Color,e[0],{get:()=>e[1]})}export class _HasColor{constructor(t){this._initColor=t,this._color=this._initColor}getInitColor(){return CDEUtils.isFunction(this._initColor)?this._initColor(this):this._initColor||null}get[Symbol.toStringTag](){return this.instanceOf}get instanceOf(){return"_HasColor"}get colorObject(){return this._color}get colorRaw(){return this._color.colorRaw}get color(){return this._color?.color}get initColor(){return this._initColor}get rgba(){return this._color.rgba}get r(){return this._color.r}get g(){return this._color.g}get b(){return this._color.b}get a(){return this._color.a}get hsv(){return this._color.hsv}get hue(){return this._color.hue}get saturation(){return this._color.saturation}get brightness(){return this._color.brightness}set color(t){const e=this._color;if(!e||e?.colorRaw?.toString()!==t?.toString()){const i=t?.colorRaw||t;i?.positions==_DynamicColor.PLACEHOLDER&&((t=t.isChannel?i:i.duplicate()).initPositions=this),e instanceof Color?e.color=t:this._color=Color.uniquify(t)}}set r(t){this._color.r=t}set g(t){this._color.g=t}set b(t){this._color.b=t}set a(t){this._color.a=t}set hue(t){this._color.hue=t}set saturation(t){this._color.saturation=t}set brightness(t){this._color.brightness=t}set initColor(t){this._initColor=t}}export class GridAssets{static D=["t","r","b","l","tr","br","bl","tl","i"].reduce((t,e,i)=>(t.places.push([t[e]=1<<i,t=>0==i?-t:1==i?1:2==i?t:3==i?-1:4==i?1-t:5==i?t+1:6==i?t-1:7==i?-t-1:8==i?0:void 0]),t),{places:[]});static DEFAULT_SOURCE=GridAssets.fontSource5x5;static get fontSource5x5(){const t=GridAssets.D;return{width:5,height:5,A:[[2,t.bl+t.br],[1,t.bl],[3,t.br],[0,t.r+t.b],[1,t.r],[2,t.r],[3,t.r],[4,t.b],[0,t.b],[4,t.b],[0],[4]],B:[[0,t.r+t.b],[,t.r],[,t.r],[,t.br],[0,t.b],[4,t.bl],[0,t.r+t.b],[,t.r],[,t.r],[,t.br],[0,t.b],[4,t.bl],[0,t.r],[,t.r],[,t.r],[]],C:[[1,t.r+t.bl],[,t.r],[,t.r],[],[0,t.b],[0,t.b],[0,t.br],[-1,t.r],[2,t.r],[,t.r],[]],D:[[0,t.r+t.b],[,t.r],[,t.r],[,t.br],[0,t.b],[4,t.b],[0,t.b],[4,t.b],[0,t.b],[4,t.bl],[0,t.r],[,t.r],[,t.r],[]],E:[[0,t.r+t.b],[,t.r],[,t.r],[,t.r],[],[0,t.b],[0,t.b+t.r],[,t.r],[,t.r],[,t.r],[0,t.b],[0,t.r],[,t.r],[,t.r],[,t.r],[]],F:[[0,t.r+t.b],[,t.r],[,t.r],[,t.r],[],[0,t.b],[0,t.b+t.r],[,t.r],[,t.r],[],[0,t.b],[0]],G:[[1,t.r+t.bl],[,t.r],[,t.r],[],[0,t.b],[0,t.b],[3,t.r],[4,t.b],[0,t.br],[4,t.b],[1,t.r],[,t.r],[,t.r],[]],H:[[0,t.r+t.b],[4,t.b],[0,t.b],[4,t.b],[0,t.b+t.r],[,t.r],[,t.r],[,t.r],[,t.b],[0,t.b],[4,t.b],[0],[4]],I:[[1,t.r],[,t.b+t.r],[],[2,t.b],[2,t.b],[2,t.b],[1,t.r],[,t.r],[]],J:[[1,t.r],[,t.r],[,t.b+t.r],[],[3,t.b],[3,t.b],[0,t.br],[3,t.bl],[1,t.r],[,t.r]],K:[[0,t.b],[3,t.bl],[0,t.b],[2,t.bl],[0,t.b+t.r],[,t.r+t.br],[0,t.b],[2,t.br],[0],[3,t.r]],L:[[0,t.b],[0,t.b],[0,t.b],[0,t.b],[0,t.r],[,t.r],[,t.r],[,t.r]],M:[[0,t.b+t.br],[4,t.b+t.bl],[0,t.b],[,t.br],[3,t.bl],[4,t.b],[0,t.b],[2],[4,t.b],[0,t.b],[4,t.b],[0],[4]],N:[[0,t.b+t.br],[4,t.b],[0,t.b],[,t.br],[4,t.b],[0,t.b],[2,t.br],[4,t.b],[0,t.b],[3,t.br],[4,t.b],[0],[4]],O:[[1,t.bl+t.r],[,t.r],[,t.br],[0,t.b],[4,t.b],[0,t.b],[4,t.b],[0,t.b+t.br],[4,t.b+t.bl],[1,t.r],[,t.r],[,t.r]],P:[[0,t.r+t.b],[,t.r],[,t.br],[0,t.b],[3,t.bl],[0,t.b+t.r],[,t.r],[],[0,t.b],[0]],Q:[[1,t.bl+t.r],[,t.r],[,t.br],[0,t.b],[4,t.b],[0,t.b],[4,t.b],[0,t.b+t.br],[3,t.br],[,t.bl],[1,t.r],[,t.r],[],[]],R:[[0,t.r+t.b],[,t.r],[,t.br],[0,t.b],[3,t.bl],[0,t.b+t.r],[,t.r+t.br],[],[0,t.b],[2,t.br],[0],[3]],S:[[1,t.r+t.bl],[,t.r],[,t.r],[],[0,t.br],[-1,t.r],[2,t.r],[,t.br],[-4,t.bl],[0,t.r+t.bl],[,t.r],[,t.r],[]],T:[[0,t.r],[,t.r],[,t.b+t.r],[,t.r],[],[2,t.b],[2,t.b],[2,t.b],[2]],U:[[0,t.r+t.b],[4,t.b],[0,t.b],[4,t.b],[0,t.b+t.r],[4,t.b],[0,t.br],[4,t.bl],[1,t.r],[,t.r],[,t.r]],V:[[0,t.r+t.b],[4,t.b],[0,t.b],[4,t.b],[0,t.br],[4,t.bl],[1,t.br],[3,t.bl],[2,t.r]],W:[[0,t.b+t.br],[4,t.b+t.bl],[0,t.b],[4,t.b],[0,t.b],[2,t.bl+t.br],[4,t.b],[0,t.b],[,t.bl],[3,t.br],[4,t.b],[0],[4]],X:[[0,t.br],[4,t.bl],[1,t.br],[3,t.bl],[2,t.br+t.bl],[1,t.bl],[3,t.br],[0],[4]],Y:[[0,t.br],[4,t.bl],[1,t.br],[3,t.bl],[2,t.b],[2,t.b],[2]],Z:[[0,t.r],[,t.r],[,t.r],[,t.r],[,t.bl],[3,t.bl],[2,t.bl],[1,t.bl],[0,t.r],[,t.r],[,t.r],[,t.r],[]],a:[[Infinity],[1,t.bl+t.r],[,t.br],[0,t.b],[3,t.b],[0,t.br],[3,t.bl+t.br],[1,t.r],[],[4]],b:[[0,t.b],[0,t.b],[0,t.b+t.r],[,t.r],[,t.br],[0,t.b],[3,t.bl],[0,t.r],[,t.r],[,t.r]],c:[[Infinity],[1,t.r+t.bl],[,t.r],[],[0,t.b],[0,t.br],[-1,t.r],[2,t.r],[]],d:[[3,t.b],[3,t.b],[1,t.bl+t.r],[,t.r],[,t.b],[0,t.br],[3,t.b],[1,t.r],[,t.r],[]],e:[[1,t.r+t.bl],[,t.br],[0,t.b],[3,t.bl],[0,t.b+t.r],[,t.r],[],[0,t.br],[3,t.bl],[1,t.r],[]],f:[[1,t.b+t.r],[],[1,t.b],[0,t.r],[,t.r+t.b],[],[1,t.b],[1]],g:[[1,t.bl+t.r],[,t.br],[0,t.br],[3,t.bl],[1,t.r],[,t.br],[0,t.br],[3,t.bl],[1,t.r],[]],h:[[0,t.b],[0,t.b],[0,t.b+t.r],[,t.r],[,t.br],[0,t.b],[3,t.b],[0],[3]],i:[[Infinity],[1,t.i],[1,t.b],[1,t.b],[1]],j:[[2,t.i],[2,t.b],[2,t.b],[0,t.br],[2,t.bl],[1]],k:[[0,t.b],[0,t.b],[2,t.bl],[0,t.b],[2,t.bl],[0,t.b+t.r],[,t.br],[0],[2]],l:[[0,t.b],[0,t.b],[0,t.b],[0,t.b],[0]],m:[[Infinity],[1,t.bl+t.br],[3,t.bl+t.br],[0,t.b],[2,t.b],[4,t.b],[0,t.b],[2,t.b],[4,t.b],[0],[2],[4]],n:[[Infinity],[0,t.b],[,t.bl+t.r],[,t.bl+t.br],[0,t.b],[3,t.b],[0,t.b],[3,t.b],[0],[3]],o:[[Infinity],[1,t.bl+t.r],[,t.br],[0,t.b],[3,t.b],[0,t.br],[3,t.bl],[1,t.r],[]],p:[[1,t.r+t.bl],[,t.br],[0,t.b],[3,t.bl],[0,t.b+t.r],[,t.r],[],[0,t.b],[0]],q:[[1,t.r+t.bl],[,t.br],[0,t.br],[3,t.b],[1,t.r],[,t.r],[,t.b],[3,t.b],[3]],r:[[Infinity],[0,t.b],[,t.bl+t.r],[],[0,t.b],[0,t.b],[0]],s:[[Infinity],[2,t.bl+t.br],[1,t.br],[3],[1,t.br],[2,t.r],[,t.b],[2,t.r],[]],t:[[2,t.b],[1,t.r],[,t.b+t.r],[],[2,t.b],[2,t.b],[2]],u:[[Infinity],[0,t.b],[2,t.b],[0,t.b],[2,t.b],[0,t.br],[2,t.bl+t.br],[1,t.r],[3]],v:[[Infinity],[1,t.b],[3,t.b],[1,t.b],[3,t.b],[1,t.br],[3,t.bl],[2,t.r]],w:[[Infinity],[0,t.b],[2,t.b],[4,t.b],[0,t.b],[2,t.b],[4,t.b],[0,t.br],[2,t.bl+t.br],[4,t.bl],[1],[3]],x:[[1,t.b],[3,t.b],[1,t.br],[3,t.bl],[2,t.br+t.bl],[1,t.b],[3,t.b],[1],[3]],y:[[Infinity],[1,t.b],[3,t.b],[1,t.br],[3,t.bl],[2,t.b],[2]],z:[[Infinity],[0,t.r],[,t.r],[,t.r],[,t.bl],[2,t.bl],[1,t.bl],[0,t.r],[,t.r],[,t.r],[]],"!":[[3,t.b],[3,t.b],[3,t.b],[3],[3,t.i]],"?":[[1,t.r+t.bl],[,t.r],[,t.br],[0],[4,t.bl],[3,t.bl],[2],[2,t.i]],"@":[[1,t.bl+t.r],[,t.r],[,t.br],[0,t.b],[2,t.bl+t.br],[4,t.b],[0,t.b],[1,t.br],[3,t.b],[4,t.b],[0,t.b+t.br],[2,t.r],[3,t.r],[4],[1,t.r],[,t.r],[,t.r]],"#":[[1,t.b],[3,t.b],[0,t.r],[1,t.b+t.r],[2,t.r],[3,t.b+t.r],[],[1,t.b],[3,t.b],[0,t.r],[1,t.b+t.r],[2,t.r],[3,t.b+t.r],[],[1],[3]],$:[[1,t.r+t.bl],[,t.r+t.b],[,t.r],[],[0,t.br],[2,t.b],[1,t.r],[2,t.r+t.b],[,t.br],[2,t.b],[4,t.bl],[0,t.r+t.bl],[,t.r],[,t.r],[]],"%":[[0,t.r+t.b],[1,t.b],[4,t.bl],[0,t.r],[],[3,t.bl],[2,t.bl],[1,t.bl],[3,t.r+t.b],[4,t.b],[0],[3,t.r],[]],"^":[[2,t.br+t.bl],[1],[3]],"&":[[0,t.r+t.br],[,t.r],[,t.r],[,t.bl],[1,t.br],[2,t.bl],[1,t.bl],[2,t.br],[0,t.br],[3,t.br],[,t.bl],[1,t.r],[2,t.r],[3],[]],"*":[[1,t.br],[,t.b],[,t.bl],[1,t.r],[,t.r],[],[1,t.tr],[,t.t],[,t.tl]],"(":[[3,t.bl],[2,t.b],[2,t.b],[2,t.br],[-3]],")":[[1,t.br],[-2,t.b],[2,t.b],[2,t.bl],[1]],"{":[[3,t.bl],[2,t.b],[1,t.r],[2,t.b],[2,t.br],[-3]],"}":[[1,t.br],[-2,t.b],[2,t.b+t.r],[],[2,t.bl],[1]],",":[[Infinity],[Infinity],[Infinity],[1,t.bl],[0]],".":[[Infinity],[Infinity],[Infinity],[Infinity],[0,t.i]],"+":[[Infinity],[2,t.b],[1,t.r],[2,t.b+t.r],[],[2]],_:[[Infinity],[Infinity],[Infinity],[Infinity],[0,t.r],[,t.r],[,t.r],[,t.r],[,t.r]],"-":[[Infinity],[Infinity],[1,t.r],[,t.r],[]],"=":[[Infinity],[1,t.r],[,t.r],[,t.r],[Infinity],[1,t.r],[,t.r],[,t.r]],";":[[2,t.r+t.b],[3,t.b],[2,t.r],[],[2,t.r+t.b],[3,t.b],[2,t.r],[,t.b],[3]],":":[[Infinity],[2,t.r+t.b],[3,t.b],[2,t.r],[],[2,t.r+t.b],[3,t.b],[2,t.r],[]],"[":[[2,t.b+t.r],[3],[2,t.b],[2,t.b],[2,t.b],[2,t.r],[3]],"]":[[1,t.r],[2,t.b],[2,t.b],[2,t.b],[2,t.b],[1,t.r],[2]],"'":[[0,t.b],[0]],"|":[[2,t.b],[2,t.b],[2,t.b],[2,t.b],[2]],"/":[[4,t.bl],[3,t.bl],[2,t.bl],[1,t.bl],[0]],"\\":[[0,t.br],[-1,t.br],[-2,t.br],[-3,t.br],[-4]],0:[[1,t.bl+t.r],[,t.br],[0,t.b],[3,t.b],[0,t.b],[,t.r],[],[,t.b],[0,t.b+t.br],[3,t.b+t.bl],[1,t.r],[,t.r]],1:[[2,t.b+t.bl],[1],[,t.b],[2,t.b],[2,t.b],[1,t.r],[,t.r],[]],2:[[1,t.r+t.bl],[,t.br],[0],[3,t.bl],[2,t.bl],[1,t.bl],[0,t.r],[,t.r],[,t.r],[,t.r]],3:[[1,t.r+t.bl],[,t.br],[0],[3,t.bl],[2,t.br],[0,t.br],[3,t.bl],[1,t.r],[,t.r]],4:[[3,t.b+t.bl],[2,t.bl],[,t.b],[1,t.bl],[3,t.b],[0,t.r],[,t.r],[,t.r],[,t.r+t.b],[,t.r],[3]],5:[[1,t.r+t.b],[,t.r],[,t.r],[],[1,t.b],[-1,t.r],[2,t.r],[,t.br],[-4,t.bl],[1,t.r+t.bl],[,t.r],[]],6:[[0,t.r+t.b],[,t.r],[,t.r],[,t.r],[0,t.b],[0,t.r+t.b],[,t.r],[,t.r],[,t.r+t.b],[0,t.b],[3,t.b],[0,t.r],[,t.r],[,t.r],[,t.r]],7:[[0,t.r],[,t.r],[,t.r],[,t.b],[3,t.bl],[1,t.r],[,t.bl+t.r],[],[1,t.bl],[0]],8:[[1,t.bl+t.r],[,t.br],[0,t.br],[3,t.bl],[1,t.bl+t.r],[,t.br],[0,t.b+t.br],[3,t.b+t.bl],[1,t.r],[,t.r]],9:[[1,t.r+t.bl],[,t.br],[0,t.br],[3,t.bl+t.b],[1,t.r],[],[,t.b],[3,t.b],[3]]}}}export class TypingDevice{static#l=0;static#h=3;static KEYS={A:"A",B:"B",C:"C",D:"D",E:"E",F:"F",G:"G",H:"H",I:"I",J:"J",K:"K",L:"L",M:"M",N:"N",O:"O",P:"P",Q:"Q",R:"R",S:"S",T:"T",U:"U",V:"V",W:"W",X:"X",Y:"Y",Z:"Z",DIGIT_0:"0",DIGIT_1:"1",DIGIT_2:"2",DIGIT_3:"3",DIGIT_4:"4",DIGIT_5:"5",DIGIT_6:"6",DIGIT_7:"7",DIGIT_8:"8",DIGIT_9:"9",SPACE:" ",ENTER:"ENTER",TAB:"TAB",BACKSPACE:"BACKSPACE",ESCAPE:"ESCAPE",SHIFT:"SHIFT",CONTROL:"CONTROL",ALT:"ALT",ALT_GRAPH:"ALTGRAPH",META:"META",CAPS_LOCK:"CAPSLOCK",CONTEXT_MENU:"CONTEXTMENU",ARROW_UP:"ARROWUP",ARROW_DOWN:"ARROWDOWN",ARROW_LEFT:"ARROWLEFT",ARROW_RIGHT:"ARROWRIGHT",HOME:"HOME",END:"END",PAGE_UP:"PAGEUP",PAGE_DOWN:"PAGEDOWN",INSERT:"INSERT",DELETE:"DELETE",F1:"F1",F2:"F2",F3:"F3",F4:"F4",F5:"F5",F6:"F6",F7:"F7",F8:"F8",F9:"F9",F10:"F10",F11:"F11",F12:"F12",F13:"F13",F14:"F14",F15:"F15",F16:"F16",F17:"F17",F18:"F18",F19:"F19",F20:"F20",F21:"F21",F22:"F22",F23:"F23",F24:"F24",NUMPAD_0:"NUMPAD0",NUMPAD_1:"NUMPAD1",NUMPAD_2:"NUMPAD2",NUMPAD_3:"NUMPAD3",NUMPAD_4:"NUMPAD4",NUMPAD_5:"NUMPAD5",NUMPAD_6:"NUMPAD6",NUMPAD_7:"NUMPAD7",NUMPAD_8:"NUMPAD8",NUMPAD_9:"NUMPAD9",NUMPAD_ADD:"NUMPADADD",NUMPAD_SUBTRACT:"NUMPADSUBTRACT",NUMPAD_MULTIPLY:"NUMPADMULTIPLY",NUMPAD_DIVIDE:"NUMPADDIVIDE",NUMPAD_DECIMAL:"NUMPADDECIMAL",NUMPAD_ENTER:"NUMPADENTER",PAUSE:"PAUSE",PRINT_SCREEN:"PRINTSCREEN",SCROLL_LOCK:"SCROLLLOCK",NUM_LOCK:"NUMLOCK",LAUNCH_APPLICATION_1:"LAUNCHAPPLICATION1",LAUNCH_APPLICATION_2:"LAUNCHAPPLICATION2",BRACKET_LEFT:"BRACKETLEFT",BRACKET_RIGHT:"BRACKETRIGHT",SEMICOLON:"SEMICOLON",QUOTE:"QUOTE",COMMA:"COMMA",PERIOD:"PERIOD",SLASH:"SLASH",BACKSLASH:"BACKSLASH",EQUAL:"EQUAL",MINUS:"MINUS",BACKQUOTE:"BACKQUOTE",AUDIO_VOLUME_UP:"AUDIOVOLUMEUP",AUDIO_VOLUME_DOWN:"AUDIOVOLUMEDOWN",AUDIO_VOLUME_MUTE:"AUDIOVOLUMEMUTE",MEDIA_PLAY_PAUSE:"MEDIAPLAYPAUSE",MEDIA_NEXT_TRACK:"MEDIANEXTTRACK",MEDIA_PREVIOUS_TRACK:"MEDIAPREVIOUSTRACK",MEDIA_STOP:"MEDIASTOP",BROWSER_BACK:"BROWSERBACK",BROWSER_FORWARD:"BROWSERFORWARD",BROWSER_REFRESH:"BROWSERREFRESH",BROWSER_STOP:"BROWSERSTOP",BROWSER_SEARCH:"BROWSERSEARCH",BROWSER_FAVORITES:"BROWSERFAVORITES",BROWSER_HOME:"BROWSERHOME"};static KEY_GROUPS={NATIVE_ZOOM_KEYS:["-","+","="]};static LISTENER_TYPES={DOWN:0,UP:1};static TRIGGER_TYPES={DEFAULT_REPEATING:0,ONCE:1,SLOW_REPEATING:2,MEDIUM_REPEATING:4,FAST_REPEATING:16};static#_=TypingDevice.TRIGGER_TYPES.SLOW_REPEATING|TypingDevice.TRIGGER_TYPES.MEDIUM_REPEATING|TypingDevice.TRIGGER_TYPES.FAST_REPEATING;static#c=[];static{TypingDevice.#c[TypingDevice.TRIGGER_TYPES.SLOW_REPEATING]=100,TypingDevice.#c[TypingDevice.TRIGGER_TYPES.MEDIUM_REPEATING]=1e3/30,TypingDevice.#c[TypingDevice.TRIGGER_TYPES.FAST_REPEATING]=1e3/60}#u=[];#E=null;constructor(){this._keysPressed=[],this._listeners=[]}addListener(t,e,i,s=TypingDevice.TRIGGER_TYPES.DEFAULT_REPEATING){const r=[e,i,s,TypingDevice.#l++];return this._listeners[t]||(this._listeners[t]=[]),this._listeners[t].push(r),r[TypingDevice.#h]}updateListener(t,e,i,s,r){const n=this._listeners[t][this._listeners[t].findIndex(t=>t[TypingDevice.#h]==(e?.[TypingDevice.#h]??e))];i&&(n[0]=i),s&&(n[1]=s),CDEUtils.isDefined(r)&&(n[2]=r)}#d(t,e){const i=this._listeners[t],s=i?.length;if(s){const r=TypingDevice.LISTENER_TYPES;for(let n=0;n<s;n++){const[s,a,o,l]=i[n];if(t===r.DOWN&&this.isDown(s)){this.#u[t]||(this.#u[t]=[]);const i=this.#u[t],r=this.#u[t]?.[o]?.[l]?.[1];o!==TypingDevice.TRIGGER_TYPES.ONCE||r?o&TypingDevice.#_&&!r?(i[o]||(i[o]=[]),i[o][l]=[s,CDEUtils.noDelayInterval(TypingDevice.#c[o],()=>a(this,e,this.keysPressed))]):o===TypingDevice.TRIGGER_TYPES.DEFAULT_REPEATING&&a(this,e,this.keysPressed):(i[o]||(i[o]=[]),i[o][l]=[s,!0],a(this,e,this.keysPressed))}else t===r.UP&&s.includes(this.#E)&&!this.isDown(this.#E)&&a(this,e,this.#E)}}}removeListener(t,e){const i="*"===e;this._listeners[t]=i?[]:this._listeners[t].filter(t=>t[TypingDevice.#h]!==(e?.[TypingDevice.#h]??e)),i?this.#u[t]=[]:this.#u[t].forEach(t=>{t[e]&&delete t[e]})}removeAllListeners(){this._listeners=[],this.#u=[]}setDown(t){const e=t.key?.toUpperCase();e&&!this.isDown(e)&&this._keysPressed.push({key:e,keyCode:t.keyCode}),this.#d(TypingDevice.LISTENER_TYPES.DOWN,t)}setUp(t){const e=t.key?.toUpperCase();if(e&&this.isDown(e)&&(this.#E=e,this._keysPressed=this._keysPressed.filter(t=>t.key!==e)),this.#u.length){const t=this.#u[TypingDevice.LISTENER_TYPES.DOWN],e=Object.values(TypingDevice.TRIGGER_TYPES).length;for(let i=1;i<1<<e;i*=2){const e=t[i];e?.length&&(i===TypingDevice.TRIGGER_TYPES.ONCE?e.forEach(t=>{this.isDown(t[0])||(t[1]=!1)}):i&TypingDevice.#_&&e.forEach(t=>{this.isDown(t[0])||(clearInterval(t[1]),t[1]=null)}))}}this.#d(TypingDevice.LISTENER_TYPES.UP,t)}isDown(t){const e=Array.isArray(t),i=this.keysPressed;if(!e)return i.includes(t?.toUpperCase());{const e=t.length;for(let s=0;s<e;s++){const e=t[s]?.toUpperCase();if(i.includes(e))return!0}}return!1}hasKeysDown(){return Boolean(this._keysPressed.length)}clearPressed(){this._keysPressed=[]}*[Symbol.iterator](){const t=this._keysPressed,e=t.length;for(let i=0;i<e;i++)yield t[i]}get[Symbol.toStringTag](){return this.instanceOf}get instanceOf(){return"TypingDevice"}get keysPressedRaw(){return this._keysPressed}get keysPressed(){return this._keysPressed.map(t=>t.key)}get keyCodesPressed(){return this._keysPressed.map(t=>t.keyCode)}set keysPressed(t){this._keysPressed=t}}export class Mouse{static#l=0;static#h=3;static DEFAULT_MOUSE_DECELERATION=.8;static DEFAULT_MOUSE_MOVE_TRESHOLD=.1;static DEFAULT_MOUSE_ANGULAR_DECELERATION=.2;static LISTENER_TYPES={CLICK:0,DOWN:0,UP:1,MAIN_DOWN:0,MAIN_UP:1,MIDDLE_DOWN:2,MIDDLE_UP:3,RIGHT_DOWN:4,RIGHT_UP:5,EXTRA_FOWARD_DOWN:6,EXTRA_FOWARD_UP:7,EXTRA_BACK_DOWN:8,EXTRA_BACK_UP:9,MOVE:10,ENTER:11,LEAVE:12,EXIT:12};static BUTTON_TYPES={LEFT:0,MIDDLE:1,RIGHT:2,EXTRA_BACK:3,EXTRA_FOWARD:4};#T=null;#S=null;#A=[];constructor(t){this._ctx=t,this._valid=!1,this._x=null,this._y=null,this._lastPos=[0,0],this._rawX=null,this._rawY=null,this._dir=null,this._speed=null,this._clicked=!1,this._rightClicked=!1,this._scrollClicked=!1,this._extraForwardClicked=!1,this._extraBackClicked=!1,this._holdValue={},this._listeners=[],this._moveListenersOptimizationEnabled=!0}calcSpeed(t){const e=Mouse.DEFAULT_MOUSE_DECELERATION;isFinite(this.#T)&&isFinite(this.#S)&&t?(this._speed=this._speed*e+CDEUtils.getDist(this._x,this._y,this.#T,this.#S)/t*(1-e),this._speed<Mouse.DEFAULT_MOUSE_MOVE_TRESHOLD&&(this._speed=0)):this._speed=0,this.#T=this._x,this.#S=this._y}calcAngle(){const t=this._x-this.#T,e=this._y-this.#S;if(isFinite(t)&&isFinite(e)&&(t||e)){let i=(360-CDEUtils.toDeg(Math.atan2(e,t)))%360-this._dir;i+=360*(i<-180)-360*(i>180),this._dir=(this._dir+i*Mouse.DEFAULT_MOUSE_ANGULAR_DECELERATION+360)%360}else this._dir=0}updateMouseClicks(t){const e="mousedown"==t.type||"touchstart"==t.type,i=Mouse.LISTENER_TYPES,s=Mouse.BUTTON_TYPES;t.button===s.LEFT?(this._clicked=e,this.checkListeners(e?i.MAIN_DOWN:i.MAIN_UP)):t.button===s.MIDDLE?(this._scrollClicked=e,this.checkListeners(e?i.MIDDLE_DOWN:i.MIDDLE_UP)):t.button===s.RIGHT?(this._rightClicked=e,this.checkListeners(e?i.RIGHT_DOWN:i.RIGHT_UP)):t.button===s.EXTRA_BACK?(this._extraBackClicked=e,this.checkListeners(e?i.EXTRA_BACK_DOWN:i.EXTRA_BACK_UP)):t.button===s.EXTRA_FOWARD&&(this._extraForwardClicked=e,this.checkListeners(e?i.EXTRA_FOWARD_DOWN:i.EXTRA_FOWARD_UP))}invalidate(){this._x=Infinity,this._y=Infinity,this._rawX=Infinity,this._rawY=Infinity}updatePos(t,e,i){this._valid=!0,this._rawX=t,this._rawY=e;const s=i[2];this._x=Math.round((t-i[0])/s),this._y=Math.round((e-i[1])/s),this._moveListenersOptimizationEnabled&&(this.checkListeners(Mouse.LISTENER_TYPES.ENTER),this.checkListeners(Mouse.LISTENER_TYPES.LEAVE)),this._lastPos[0]=this._x,this._lastPos[1]=this._y,this.checkListeners(Mouse.LISTENER_TYPES.MOVE)}checkValid(){return Infinity==this._x||null==this._x||Infinity==this._y||null==this._y?this._valid=!1:this._valid?void 0:this._valid=!0}addListener(t,e,i,s=!1,r=!1){const n=s&&t.getBoundsAccurate,a=[r?n?t.getBoundsAccurate():t.getBounds():t,i,n,Mouse.#l++];return this._listeners[e]||(this._listeners[e]=[]),this._listeners[e].push(a),a[Mouse.#h]}checkListeners(t){const e=this._listeners[t],i=e?.length;if(i){let s=Mouse.LISTENER_TYPES,r=this.pos,n=!0;if(t>=s.ENTER){n=2,t==s.LEAVE&&(n=1);for(let t=0;t<i;t++){const i=e[t],s=i[0],a=i[1],o=i[2],l=s instanceof Path2D,h=Array.isArray(s)||l,_=!h&&(o?s.isWithinAccurate(r):s.isWithin(r))||h&&this.isWithin(r,s,l);if(this._moveListenersOptimizationEnabled)2*_+(!h&&(o?s.isWithinAccurate(this._lastPos):s.isWithin(this._lastPos))||h&&this.isWithin(this._lastPos,s,l))==n&&a(r,s,this);else{const t=this.#A[i[Mouse.#h]];!t&&_?(this.#A[i[Mouse.#h]]=!0,2==n&&a(r,s,this)):!_&&t&&(this.#A[i[Mouse.#h]]=!1,1==n&&a(r,s,this))}}}else{n=t==s.MAIN_DOWN||t==s.RIGHT_DOWN||t==s.MIDDLE_DOWN||t==s.EXTRA_BACK_DOWN||t==s.EXTRA_FOWARD_DOWN?this._clicked:t!=s.MAIN_UP&&t!=s.RIGHT_UP&&t!=s.MIDDLE_UP&&t!=s.EXTRA_BACK_UP&&t!=s.EXTRA_FOWARD_UP||!this._clicked;for(let t=0;t<i;t++){const[i,s,a]=e[t],o=i instanceof Path2D,l=Array.isArray(i)||o;n&&(!l&&(a?i.isWithinAccurate(r):i.isWithin(r))||l&&this.isWithin(r,i,o))&&s(r,i,this)}}}}updateListener(t,e,i,s,r,n=!1){const a=this._listeners[t][this._listeners[t].findIndex(t=>t[Mouse.#h]==(e?.[Mouse.#h]??e))];i&&(a[0]=n?r&&i.getBoundsAccurate?i.getBoundsAccurate():i.getBounds():i),s&&(a[1]=s),CDEUtils.isDefined(r)&&(a[2]=r)}removeListener(t,e){this._listeners[t]="*"==e?[]:this._listeners[t].filter(t=>t[Mouse.#h]!==(e?.[Mouse.#h]??e))}removeAllListeners(){this._listeners=[]}isWithin(t,e,i){const s=t[0],r=t[1];if(i){const i=this._viewPos;return this._ctx.isPointInPath(e,t[0]+i[0],t[1]+i[1])}return s>=e[0][0]&&s<=e[1][0]&&r>=e[0][1]&&r<=e[1][1]}get[Symbol.toStringTag](){return this.instanceOf}get instanceOf(){return"Mouse"}get ctx(){return this._ctx}get valid(){return this._valid}get x(){return this._x}get y(){return this._y}get pos(){return[this._x,this._y]}get rawX(){return this._rawX}get rawY(){return this._rawY}get rawPos(){return[this._rawX,this._rawY]}get deltaTimeLastX(){return this.#T}get deltaTimeLastY(){return this.#S}get lastX(){return this._lastPos[0]}get lastY(){return this._lastPos[0]}get lastPos(){return this._lastPos}get dir(){return this._dir}get speed(){return this._speed}get clicked(){return this._clicked}get scrollClicked(){return this._scrollClicked}get rightClicked(){return this._rightClicked}get extraBackClicked(){return this._extraBackClicked}get extraForwardClicked(){return this._extraForwardClicked}get holdValue(){return this._holdValue}get listeners(){return this._listeners}get moveListenersOptimizationEnabled(){return this._moveListenersOptimizationEnabled}set ctx(t){this._ctx=t}set valid(t){this._valid=t}set dir(t){this._dir=t}set speed(t){this._speed=t}set clicked(t){this._clicked=t}set scrollClicked(t){this._scrollClicked=t}set rightClicked(t){this._rightClicked=t}set extraBackClicked(t){this._extraBackClicked=t}set extraForwardClicked(t){this._extraForwardClicked=t}set holdValue(t){this._holdValue=t}}export class Render{static PROFILE_ID_GIVER=-1;static TEXT_PROFILE_ID_GIVER=-1;static COMPOSITE_OPERATIONS={UNDER:"destionation-over",OVER:"source-over",SOURCE_OVER:"source-over",SOURCE_IN:"source-in",SOURCE_OUT:"source-out",SOURCE_ATOP:"source-atop",DESTINATION_OVER:"destination-over",DESTINATION_IN:"destination-in",DESTINATION_OUT:"destination-out",DESTINATION_ATOP:"destination-atop",LIGHTER:"lighter",COPY:"copy",XOR:"xor",MULTIPLY:"multiply",SCREEN:"screen",OVERLAY:"overlay",DARKEN:"darken",LIGHTEN:"lighten",COLOR_DODGE:"color-dodge",COLOR_BURN:"color-burn",HARD_LIGHT:"hard-light",SOFT_LIGHT:"soft-light",DIFFERENCE:"difference",EXCLUSION:"exclusion",HUE:"hue",SATURATION:"saturation",COLOR:"color",LUMINOSITY:"luminosity"};static FILTERS={BLUR:t=>`blur(${t}px)`,BRIGHTNESS:t=>`brightness(${t})`,CONTRAST:t=>`contrast(${t})`,DROPSHADOW:t=>`drop-shadow(${t})`,GRAYSCALE:t=>`grayscale(${t})`,HUE_ROTATE:t=>`hue-rotate(${t}deg)`,INVERT:t=>`invert(${t})`,OPACITY:t=>`opacity(${t})`,SATURATE:t=>`saturate(${t})`,SEPIA:t=>`sepia(${t})`,URL:t=>`url(${t})`};static DEFAULT_COMPOSITE_OPERATION=Render.COMPOSITE_OPERATIONS.SOURCE_OVER;static DEFAULT_FILTER="none";static DEFAULT_ALPHA=1;static PATH_TYPES={LINEAR:Render.getLine,QUADRATIC:Render.getQuadCurve,CUBIC_BEZIER:Render.getBezierCurve,ARC:Render.getArc,ARC_TO:Render.getArcTo,ELLIPSE:Render.getEllispe,RECT:Render.getRect,POSITIONS_RECT:Render.getPositionsRect,ROUND_RECT:Render.getRoundRect,POSITIONS_ROUND_RECT:Render.getPositionsRoundRect};static LINE_TYPES={LINEAR:Render.getLine,QUADRATIC:Render.getQuadCurve,CUBIC_BEZIER:Render.getBezierCurve};static DRAW_METHODS={FILL:"FILL",STROKE:"STROKE"};static COLOR_TRANSFORMS={NONE:null,INVERT:1,GRAYSCALE:2,SEPIA:3,RANDOMIZE:4,STATIC:5,MULTIPLY:6,BGRA:7,TINT:8,FORCE_TINT:9};#p=[Color.DEFAULT_COLOR_VALUE,Render.DEFAULT_FILTER,Render.DEFAULT_COMPOSITE_OPERATION,Render.DEFAULT_ALPHA];#g=RenderStyles.DEFAULT_PROFILE.getStyles();#R=TextStyles.DEFAULT_PROFILE.getStyles();constructor(t){this._ctx=t,this._batchedStrokes={},this._batchedFills={},this._bactchedStandalones=[],this._defaultProfile=RenderStyles.DEFAULT_PROFILE.duplicate(this),this._profile1=this._defaultProfile.duplicate(),this._profile2=this._defaultProfile.duplicate(),this._profile3=this._defaultProfile.duplicate(),this._profile4=this._defaultProfile.duplicate(),this._profile5=this._defaultProfile.duplicate(),this._profiles=[],this._defaultTextProfile=TextStyles.DEFAULT_PROFILE.duplicate(this),this._textProfile1=this._defaultTextProfile.duplicate(),this._textProfile2=this._defaultTextProfile.duplicate(),this._textProfile3=this._defaultTextProfile.duplicate(),this._textProfile4=this._defaultTextProfile.duplicate(),this._textProfile5=this._defaultTextProfile.duplicate(),this._textProfiles=[]}static getLine(t,e){const i=new Path2D;return i.moveTo(t[0],t[1]),i.lineTo(e[0],e[1]),i}static getQuadCurve(t,e,i=null){Array.isArray(i)||(i=Render.getDefaultQuadraticControlPos(t,e,i||void 0));const s=new Path2D;return s.moveTo(t[0],t[1]),s.quadraticCurveTo(i[0],i[1],e[0],e[1]),s}static getDefaultQuadraticControlPos(t,e,i=1){return[e[0]*i,t[1]*i]}static getBezierCurve(t,e,i=null,s=null){if(!s||!i){const r=Render.getDefaultBezierControlPos(t,e,i||void 0);i=r[0],s??=r[1]}const r=new Path2D;return r.moveTo(t[0],t[1]),r.bezierCurveTo(i[0],i[1],s[0],s[1],e[0],e[1]),r}static getDefaultBezierControlPos(t,e,i=.75){const[s,r]=t,[n,a]=e;return[[s+(n-s)*(1-i),r+(a-r)*i],[n-(n-s)*(1-i),a-(a-r)*i]]}static getArc(t,e=5,i=0,s=CDEUtils.CIRC){const r=new Path2D;return r.arc(t[0],t[1],e,i,s),r}static getArcTo(t,e,i,s){const r=new Path2D;return r.moveTo(t[0],t[1]),r.arcTo(e[0],e[1],i[0],i[1],s),r}static getEllispe(t,e,i,s=0,r=0,n=CDEUtils.CIRC,a=!1){const o=new Path2D;return o.ellipse(t[0],t[1],e,i,s,r,n,a),o}static getRect(t,e,i){const s=new Path2D;return s.rect(t[0],t[1],e,i),s}static getPositionsRect(t,e){const i=new Path2D,s=t[0],r=t[1];return i.rect(s,r,e[0]-s,e[1]-r),i}static getRoundRect(t,e,i,s=5){const r=new Path2D;return r.roundRect(t[0],t[1],e,i,s),r}static getPositionsRoundRect(t,e,i=5){const s=new Path2D,r=t[0],n=t[1];return s.roundRect(r,n,e[0]-r,e[1]-n,i),s}static getFromSVGPath(t){return new Path2D(t)}createCustomStylesProfile(t=this._defaultProfile){const e=t.duplicate();return this._profiles.push(e),e}createCustomTextStylesProfile(t=this._defaultTextProfile){const e=t.duplicate();return this._textProfiles.push(e),e}batchStroke(t,e=Color.DEFAULT_RGBA,i=[]){if((e[3]??e.a??1)>Color.OPACITY_VISIBILITY_THRESHOLD){const s=this._batchedStrokes,r=i[0],n=i[1],a=i[2],o=e instanceof RenderStyles?e.toString(void 0,r,n,a):this._defaultProfile.toString(e,r,n,a);s[o]||(s[o]=new Path2D),s[o].addPath(t)}}batchFill(t,e=Color.DEFAULT_RGBA,i=[]){if((e[3]??e.a??1)>Color.OPACITY_VISIBILITY_THRESHOLD){const s=this._batchedFills,r=i[0],n=i[1],a=i[2],o=e instanceof RenderStyles?e.fillOptimizedToString(void 0,r,n,a):this._defaultProfile.fillOptimizedToString(e,r,n,a);s[o]||(s[o]=new Path2D),s[o].addPath(t)}}drawBatched(){const t=Object.entries(this._batchedStrokes),e=t.length,i=Object.entries(this._batchedFills),s=i.length,r=this._ctx,n=this._bactchedStandalones,a=n.length,o=Gradient.SERIALIZATION_SEPARATOR,l=Pattern.SERIALIZATION_SEPARATOR,h=Render.DEFAULT_FILTER,_=Render.DEFAULT_COMPOSITE_OPERATION,c=Render.DEFAULT_ALPHA;for(let i=0;i<e;i++){let e=t[i],s=e[0],n=e[1],a=s.split(RenderStyles.SERIALIZATION_SEPARATOR),h=a[0],_=a[5];h.includes(o)?h=Gradient.getCanvasGradientFromString(r,h):h.includes(l)&&(h=Pattern.LOADED_PATTERN_SOURCES[h.split(l)[0]].value);let c=[];if(_){let t=_.length,e=0;for(let i=0;i<=t;i++)if(","==_[i]||i==t){const t=+_.slice(e,i).trim();t&&c.push(t),e=i+1}}else c[0]=0;RenderStyles.apply(this,h,a[1],a[2],a[3],a[4],c,a[6],a[7],a[8]),r.stroke(n)}RenderStyles.apply(this,null,h,_,c);for(let t=0;t<s;t++){let e=i[t],s=e[0],n=e[1],a=s.split(RenderStyles.SERIALIZATION_SEPARATOR),h=a[0];h.includes(o)?h=Gradient.getCanvasGradientFromString(r,h):h.includes(l)&&(h=Pattern.LOADED_PATTERN_SOURCES[h.split(l)[0]].value),RenderStyles.apply(this,h,a[1],a[2],a[3]),r.fill(n)}if(RenderStyles.apply(this,null,h,_,c),a){for(let t=0;t<a;t++)n[t]();this._bactchedStandalones=[]}this._batchedStrokes={},this._batchedFills={}}stroke(t,e=Color.DEFAULT_RGBA,i=[]){if((e[3]??e.a??1)>Color.OPACITY_VISIBILITY_THRESHOLD){const s=i[0],r=i[1],n=i[2];e instanceof RenderStyles?e.apply(void 0,s,r,n):this._defaultProfile.apply(e,s,r,n),this._ctx.stroke(t),RenderStyles.apply(this,null,Render.DEFAULT_FILTER,Render.DEFAULT_COMPOSITE_OPERATION,Render.DEFAULT_ALPHA)}}fill(t,e=Color.DEFAULT_RGBA,i=[]){if((e[3]??e.a??1)>Color.OPACITY_VISIBILITY_THRESHOLD){const s=i[0],r=i[1],n=i[2];e instanceof RenderStyles?e.apply(void 0,s,r,n):this._defaultProfile.apply(e,s,r,n),this._ctx.fill(t),RenderStyles.apply(this,null,Render.DEFAULT_FILTER,Render.DEFAULT_COMPOSITE_OPERATION,Render.DEFAULT_ALPHA)}}strokeText(t,e,i,s,r=void 0,n=TextDisplay.DEFAULT_LINE_HEIGHT,a=[]){if(t){const o=Color.getColorValue(i),l=this.#p,h=this._ctx;if(s instanceof TextStyles?s.apply():this._defaultTextProfile.apply(s),i&&l[0]!==o&&(l[0]=h.strokeStyle=h.fillStyle=o),a?.length&&RenderStyles.apply(this,null,a[0],a[1],a[2]),t.includes("\n")){const i=t.split("\n"),s=i.length;for(let t=0;t<s;t++)h.strokeText(i[t],e[0],e[1]+t*n,r)}else h.strokeText(t,e[0],e[1],r);RenderStyles.apply(this,null,Render.DEFAULT_FILTER,Render.DEFAULT_COMPOSITE_OPERATION,Render.DEFAULT_ALPHA)}}fillText(t,e,i,s,r=void 0,n=TextDisplay.DEFAULT_LINE_HEIGHT,a=[]){if(t){const o=Color.getColorValue(i),l=this.#p,h=this._ctx;if(s instanceof TextStyles?s.apply():this._defaultTextProfile.apply(s),i&&l[0]!==o&&(l[0]=h.strokeStyle=h.fillStyle=o),a?.length&&RenderStyles.apply(this,null,a[0],a[1],a[2]),t.includes("\n")){const i=t.split("\n"),s=i.length;for(let t=0;t<s;t++)h.fillText(i[t],e[0],e[1]+t*n,r)}else h.fillText(t,e[0],e[1],r);RenderStyles.apply(this,null,Render.DEFAULT_FILTER,Render.DEFAULT_COMPOSITE_OPERATION,Render.DEFAULT_ALPHA)}}drawImage(t,e,i,s,r=[]){if(r?.length&&RenderStyles.apply(this,null,r[0],r[1],r[2]),s){const[[r,n],[a,o]]=s;this._ctx.drawImage(t,r,n,a-r,o-r,e[0],e[1],i[0],i[1])}else this._ctx.drawImage(t,e[0],e[1],i[0],i[1]);RenderStyles.apply(this,null,Render.DEFAULT_FILTER,Render.DEFAULT_COMPOSITE_OPERATION,Render.DEFAULT_ALPHA)}drawLateImage(t,e,i,s,r=[]){this._bactchedStandalones.push(()=>{if(r?.length&&RenderStyles.apply(this,null,r[0],r[1],r[2]),s){const[[r,n],[a,o]]=s;this._ctx.drawImage(t,r,n,a-r,o-r,e[0],e[1],i[0],i[1])}else this._ctx.drawImage(t,e[0],e[1],i[0],i[1]);RenderStyles.apply(this,null,Render.DEFAULT_FILTER,Render.DEFAULT_COMPOSITE_OPERATION,Render.DEFAULT_ALPHA)})}replaceColor(t,e=Color.DEFAULT_RGBA,i=Color.DEFAULT_TEMPERANCE,s=null,r=1,n=!1){const a=()=>{const n=this._ctx,a=n.canvas,o=s?.[0]?.[0]??0,l=s?.[0]?.[1]??0,h=n.getImageData(o,l,s?.[1]?.[0]-o||a.width,s?.[1]?.[1]-l||a.height),_=h.data,c=_.length,u=t.r??t[0],E=t.g??t[1],d=t.b??t[2],T=e.r??e[0],S=e.g??e[1],A=e.b??e[2],p=255*(e.a??e[3]),g=4*(r>0?r:1);if(i){let t,e,s,r=i[0]??i,n=i[1]??i,a=i[2]??i,o=u-r,l=E-n,h=d-a,R=u+r,C=E+n,D=d+a;for(let i=0;i<c;i+=g)t=_[i],t>=o&&t<=R&&(e=_[i+1],s=_[i+2],e>=l&&e<=C&&s>=h&&s<=D&&(_[i]=T,_[i+1]=S,_[i+2]=A,_[i+3]=p))}else for(let t=0;t<c;t+=g)_[t]==u&&_[t+1]==E&&_[t+2]==d&&(_[t]=T,_[t+1]=S,_[t+2]=A,_[t+3]=p);n.putImageData(h,o,l)};n?a():this._bactchedStandalones.push(a)}transformArea(t=COLOR_TRANSFORMS.NONE,e,i=null,s=1,r=!1){if(t){const n=()=>{const r=this._ctx,n=r.canvas,a=i?.[0]?.[0]??0,o=i?.[0]?.[1]??0,l=r.getImageData(a,o,i?.[1]?.[0]-a||n.width,i?.[1]?.[1]-o||n.height),h=l.data,_=h.length,c=Render.COLOR_TRANSFORMS,u=CDEUtils.random,E=4*(s>0?s:1);if(t==c.INVERT){e??=1;for(let t=0;t<_;t+=E){const i=h[t],s=h[t+1],r=h[t+2];h[t]=255*e-i,h[t+1]=255*e-s,h[t+2]=255*e-r}}else if(t==c.GRAYSCALE){e??=1;for(let t=0;t<_;t+=E){const i=(h[t]+h[t+1]+h[t+2])/3;h[t]=i*e,h[t+1]=i*e,h[t+2]=i*e}}else if(t==c.SEPIA){e??=1;for(let t=0;t<_;t+=E){const i=h[t],s=h[t+1],r=h[t+2];h[t]=(.393*i+.769*s+.189*r)*e,h[t+1]=(.349*i+.686*s+.168*r)*e,h[t+2]=(.272*i+.534*s+.131*r)*e}}else if(t==c.RANDOMIZE){e||=[0,255];for(let t=0;t<_;t+=E)h[t]=u(e[0],e[1]),h[t+1]=u(e[0],e[1]),h[t+2]=u(e[0],e[1])}else if(t==c.STATIC){e||=[0,255];for(let t=0;t<_;t+=E)h[t]=h[t+1]=h[t+2]=u(e[0],e[1])}else if(t==c.MULTIPLY){e??=1;for(let t=0;t<_;t+=E)h[t]*=e,h[t+1]*=e,h[t+2]*=e}else if(t==c.BGRA){e??=1;for(let t=0;t<_;t+=E){const i=h[t],s=h[t+1],r=h[t+2];h[t]=r*e,h[t+1]=s*e,h[t+2]=i*e}}else if(t==c.TINT){e||=[255,255,255,1];for(let t=0;t<_;t+=E)h[t]+=e[0],h[t+1]+=e[1],h[t+2]+=e[2],h[t+3]+=e[3]}else if(t==c.FORCE_TINT){e||=[255,255,255,1];for(let t=0;t<_;t+=E)h[t]=e[0],h[t+1]=e[1],h[t+2]=e[2]}r.putImageData(l,a,o)};r?n():this._bactchedStandalones.push(n)}}static generate(t,e,i,s=100,r=null){t??=[0,0],e??=()=>0,i??=100,s??=100;const n=Math.sign(i),a=Math.abs(i)+.1;if(a>1&&s>1){const o=(a-.1)/s,l=t[0],h=t[1],_=r?r(t,e,i,s):new Path2D;_.moveTo(l,h+e(0));for(let t=0;t<=a;t+=o)_.lineTo(l+t*n,h+e(t*n));return _}return null}static getGenerationEndPos(t,e,i){return CDEUtils.addPos(t,[i,CDEUtils.round(e(i),_BaseObj.POSITION_PRECISION)])}static composePath(t,e){const i=new Path2D,s=t.length,r=t[0];i.moveTo(r[0],r[1]);for(let r=1;r<s;r++){const s=t[r].pos||t[r];e?i.addPath(e(t[r-1].pos||t[r-1],s)):i.lineTo(s[0],s[1])}return i}static mergePaths(t){const e=t.length,i=t[0];for(let s=1;s<e;s++)i.addPath(t[s]);return i}static Y_FUNCTIONS={SINUS:(t=100,e=100)=>{t??=100,e??=100,e=2*Math.PI/Math.abs(e);const i=Math.sin,s=Math.abs(t)/2*Math.sign(t);return t=>s*i(e*t)},COSINUS:(t=100,e=100)=>{t??=100,e??=100,e=2*Math.PI/Math.abs(e);const i=Math.cos,s=Math.abs(t)/2*Math.sign(t);return t=>s*i(e*t)},LINEAR:(t=1)=>(t??=1,e=>t*e)};get[Symbol.toStringTag](){return this.instanceOf}get instanceOf(){return"Render"}get ctx(){return this._ctx}get batchedStrokes(){return this._batchedStrokes}get batchedFills(){return this._bactchedStandalones}get batchedStandalones(){return this._batchedImages}get defaultProfile(){return this._defaultProfile}get profile1(){return this._profile1}get profile2(){return this._profile2}get profile3(){return this._profile3}get profile4(){return this._profile4}get profile5(){return this._profile5}get profiles(){return this._profiles}get defaultTextProfile(){return this._defaultTextProfile}get textProfile1(){return this._textProfile1}get textProfile2(){return this._textProfile2}get textProfile3(){return this._textProfile3}get textProfile4(){return this._textProfile4}get textProfile5(){return this._textProfile5}get textProfiles(){return this._textProfiles}get currentCtxVisuals(){return this.#p}get currentCtxStyles(){return this.#g}get currentCtxTextStyles(){return this.#R}set ctx(t){this._ctx=t}set defaultProfile(t){this._defaultProfile=t}set profile1(t){this._profile1=t}set profile2(t){this._profile2=t}set profile3(t){this._profile3=t}set profile4(t){this._profile4=t}set profile5(t){this._profile5=t}set profiles(t){this._profiles=t}set defaultTextProfile(t){this._defaultTextProfile=t}set textProfile1(t){this._textProfile1=t}set textProfile2(t){this._textProfile2=t}set textProfile3(t){this._textProfile3=t}set textProfile4(t){this._textProfile4=t}set textProfile5(t){this._textProfile5=t}set textProfiles(t){this._textProfiles=t}set currentCtxVisuals(t){this.#p=t}set currentCtxStyles(t){this.#g=t}set currentCtxTextStyles(t){this.#R=t}}export class TextStyles{static CAPS_VARIANTS={NORMAL:"normal",SMALL_CAPS:"small-caps",ALL_SMALL_CAPS:"all-small-caps",PETITE_CAPS:"petite-caps",ALL_PETITE_CAPS:"all-petite-caps",UNICASE:"unicase",TILTING_CAPS:"tilting-caps"};static DIRECTIONS={LEFT_TO_RIGHT:"ltr",RIGHT_TO_LEFT:"rtl",INHERIT:"inherit"};static STRETCHES={ULTRA_CONDENSED:"ultra-condensed",EXTRA_CONDENSED:"extra-condensed",CONDENSED:"condensed",SEMI_CONDENSED:"semi-condensed",NORMAL:"normal",SEMI_EXPANDED:"semi-expanded",EXPANDED:"expanded",EXTRA_EXPANDED:"extra-expanded",ULTRA_EXPANDED:"ultra-expanded"};static KERNINGS={AUTO:"auto",NORMAL:"normal",NONE:"none"};static ALIGNMENTS={LEFT:"left",RIGHT:"right",CENTER:"center",START:"start",END:"end"};static BASELINES={TOP:"top",BOTTOM:"bottom",HANGING:"hanging",MIDDLE:"middle",ALPHABETIC:"alphabetic",IDEOGRAPHIC:"ideographic"};static RENDERINGS={AUTO:"auto",FAST:"optimizeSpeed",LEGIBLE:"optimizeLegibility",PRECISE:"geometricPrecision"};static DEFAULT_FONT="32px Arial";static DEFAULT_LETTER_SPACING="2px";static DEFAULT_WORD_SPACING="4px";static DEFAULT_FONT_VARIANT_CAPS=TextStyles.CAPS_VARIANTS.NORMAL;static DEFAULT_DIRECTION=TextStyles.DIRECTIONS.LEFT_TO_RIGHT;static DEFAULT_FONT_STRETCH=TextStyles.STRETCHES.NORMAL;static DEFAULT_FONT_KERNING=TextStyles.KERNINGS.NORMAL;static DEFAULT_TEXT_ALIGN=TextStyles.ALIGNMENTS.CENTER;static DEFAULT_TEXT_BASELINE=TextStyles.BASELINES.MIDDLE;static DEFAULT_TEXT_RENDERING=TextStyles.RENDERINGS.FAST;static DEFAULT_PROFILE=new TextStyles(null,TextStyles.DEFAULT_FONT,TextStyles.DEFAULT_LETTER_SPACING,TextStyles.DEFAULT_WORD_SPACING,TextStyles.DEFAULT_FONT_VARIANT_CAPS,TextStyles.DEFAULT_DIRECTION,TextStyles.DEFAULT_FONT_STRETCH,TextStyles.DEFAULT_FONT_KERNING,TextStyles.DEFAULT_TEXT_ALIGN,TextStyles.DEFAULT_TEXT_BASELINE,TextStyles.DEFAULT_TEXT_RENDERING);static SUPPORTED_FONTS_FORMATS=["woff","woff2","ttf","otf"];static#C=1;#D=null;constructor(t,e,i,s,r,n,a,o,l,h,_){this._id=Render.TEXT_PROFILE_ID_GIVER++,this._render=t,this.#D=t?.ctx,this._font=e??TextStyles.DEFAULT_FONT,this._letterSpacing=i??TextStyles.DEFAULT_LETTER_SPACING,this._wordSpacing=s??TextStyles.DEFAULT_WORD_SPACING,this._fontVariantCaps=r??TextStyles.DEFAULT_FONT_VARIANT_CAPS,this._direction=n??TextStyles.DEFAULT_DIRECTION,this._fontStretch=a??TextStyles.DEFAULT_FONT_STRETCH,this._fontKerning=o??TextStyles.DEFAULT_FONT_KERNING,this._textAlign=l??TextStyles.DEFAULT_TEXT_ALIGN,this._textBaseline=h??TextStyles.DEFAULT_TEXT_BASELINE,this._textRendering=_??TextStyles.DEFAULT_TEXT_RENDERING}duplicate(t=this._render,e=this._font,i=this._letterSpacing,s=this._wordSpacing,r=this._fontVariantCaps,n=this._direction,a=this._fontStretch,o=this._fontKerning,l=this._textAlign,h=this._textBaseline,_=this._textRendering){return new TextStyles(t,e,i,s,r,n,a,o,l,h,_)}getStyles(){return[this._font,this._letterSpacing,this._wordSpacing,this._fontVariantCaps,this._direction,this._fontStretch,this._fontKerning,this._textAlign,this._textBaseline,this._textRendering]}update(t,e,i,s,r,n,a,o,l,h){return t&&(this._font=t),e&&(this._letterSpacing="number"==typeof e?e+"px":e),i&&(this._wordSpacing="number"==typeof i?i+"px":i),s&&(this._fontVariantCaps=s),r&&(this._direction=r),n&&(this._fontStretch=n),a&&(this._fontKerning=a),o&&(this._textAlign=o),l&&(this._textBaseline=l),h&&(this._textRendering=h),this}apply(t=this._font,e=this._letterSpacing,i=this._wordSpacing,s=this._fontVariantCaps,r=this._direction,n=this._fontStretch,a=this._fontKerning,o=this._textAlign,l=this._textBaseline,h=this._textRendering){const _=this.#D,c=this._render.currentCtxTextStyles;t&&c[0]!==t&&(c[0]=_.font=t),e&&c[1]!==e&&(c[1]=_.letterSpacing=e),i&&c[2]!==i&&(c[2]=_.wordSpacing=i),s&&c[3]!==s&&(c[3]=_.fontVariantCaps=s),r&&c[4]!==r&&(c[4]=_.direction=r),n&&c[5]!==n&&(c[5]=_.fontStretch=n),a&&c[6]!==a&&(c[6]=_.fontKerning=a),o&&c[7]!==o&&(c[7]=_.textAlign=o),l&&c[8]!==l&&(c[8]=_.textBaseline=l),h&&c[9]!==h&&(c[9]=_.textRendering=h)}static apply(t,e,i,s,r,n,a,o,l,h,_){const c=[t.font,t.letterSpacing,t.wordSpacing,t.fontVariantCaps,t.direction,t.fontStretch,t.fontKerning,t.textAlign,t.textBaseline,t.textRendering];e&&c[0]!==e&&(c[0]=t.font=e),i&&c[1]!==i&&(c[1]=t.letterSpacing=i),s&&c[2]!==s&&(c[2]=t.wordSpacing=s),r&&c[3]!==r&&(c[3]=t.fontVariantCaps=r),n&&c[4]!==n&&(c[4]=t.direction=n),a&&c[5]!==a&&(c[5]=t.fontStretch=a),o&&c[6]!==o&&(c[6]=t.fontKerning=o),l&&c[7]!==l&&(c[7]=t.textAlign=l),h&&c[8]!==h&&(c[8]=t.textBaseline=h),_&&c[9]!==_&&(c[9]=t.textRendering=_)}static isFontFormatSupported(t){const e=(t?.name||t).toLowerCase();return TextStyles.SUPPORTED_FONTS_FORMATS.some(t=>e.endsWith("."+t))}static loadCustomFont(t,e=null,i={},s=null,r=e=>console.warn("Error loading font:",t,e)){if(TextStyles.isFontFormatSupported(t)||t instanceof ArrayBuffer||t instanceof Int8Array||t instanceof Uint8Array||t instanceof Uint8ClampedArray||t instanceof Int16Array||t instanceof Uint16Array||t instanceof Int32Array||t instanceof Uint32Array||t instanceof Float32Array||t instanceof Float64Array||t instanceof BigInt64Array||t instanceof BigUint64Array){const n=new FontFace(e||"customFont"+TextStyles.#C++,`url(${t})`,i);return n.load().then(t=>{document.fonts.add(t),CDEUtils.isFunction(s)&&s(n,n.family)}).catch(t=>{CDEUtils.isFunction(r)&&r(t)}),n}{const e=document.createElement("link");return e.rel="stylesheet",e.type="text/css",e.href=t,e.id="customFont"+TextStyles.#C++,document.querySelector("head").appendChild(e)}}static getFontStyleDeclaration(t,e,i=null,s=null,r=null,n=null){return n&&(e=`${e}/${n}`),[s,r,i,e,t=t.split(",").map(t=>(t=t.trim()).includes(" ")&&!t.match(/['"`]/g)?`'${t}'`:t).join(", ")].filter(Boolean).join(" ")}[Symbol.toPrimitive](){return this.toString()}*[Symbol.iterator](){const t=this.getStyles(),e=t.length;for(let i=0;i<e;i++)yield t[i]}get[Symbol.toStringTag](){return this.instanceOf}get instanceOf(){return"TextStyles"}get id(){return this.id}get render(){return this._render}get font(){return this._font}get letterSpacing(){return+this._letterSpacing.replace("px","")}get wordSpacing(){return+this._wordSpacing.replace("px","")}get fontVariantCaps(){return this._fontVariantCaps}get direction(){return this._direction}get fontStretch(){return this._fontStretch}get fontKerning(){return this._fontKerning}get textAlign(){return this._textAlign}get textBaseline(){return this._textBaseline}get textRendering(){return this._textRendering}set render(t){this._render=t,this.#D=t.ctx}set font(t){this._font=t}set letterSpacing(t){this._letterSpacing="number"==typeof t?t+"px":t}set wordSpacing(t){this._wordSpacing="number"==typeof t?t+"px":t}set fontVariantCaps(t){this._fontVariantCaps=t}set direction(t){this._direction=t}set fontStretch(t){this._fontStretch=t}set fontKerning(t){this._fontKerning=t}set textAlign(t){this._textAlign=t}set textBaseline(t){this._textBaseline=t}set textRendering(t){this._textRendering=t}}export class RenderStyles extends _HasColor{static JOIN_TYPES={MITER:"miter",BEVEL:"bevel",ROUND:"round"};static CAP_TYPES={BUTT:"butt",SQUARE:"square",ROUND:"round"};static DEFAULT_WIDTH=2;static DEFAULT_CAP=RenderStyles.CAP_TYPES.ROUND;static DEFAULT_JOIN=RenderStyles.JOIN_TYPES.MITER;static DEFAULT_DASH=[];static DEFAULT_DASH_OFFSET=0;static SERIALIZATION_SEPARATOR="%";static DEFAULT_PROFILE=new RenderStyles(null,Color.DEFAULT_RGBA,Render.DEFAULT_FILTER,Render.DEFAULT_COMPOSITE_OPERATION,Render.DEFAULT_ALPHA,RenderStyles.DEFAULT_WIDTH,RenderStyles.DEFAULT_DASH,RenderStyles.DEFAULT_DASH_OFFSET,RenderStyles.DEFAULT_JOIN,RenderStyles.DEFAULT_CAP);#D=null;constructor(t,e,i,s,r,n,a,o,l,h){super(e),t&&(this.color=this.getInitColor()),this._id=Render.PROFILE_ID_GIVER++,this._render=t,this.#D=t?.ctx,this._filter=i??Render.DEFAULT_FILTER,this._compositeOperation=s??Render.DEFAULT_COMPOSITE_OPERATION,this._opacity=r??Render.DEFAULT_ALPHA,this._lineWidth=n??RenderStyles.DEFAULT_WIDTH,this._lineDash=a??RenderStyles.DEFAULT_DASH,this._lineDashOffset=o??RenderStyles.DEFAULT_DASH_OFFSET,this._lineJoin=l??RenderStyles.DEFAULT_JOIN,this._lineCap=h??RenderStyles.DEFAULT_CAP}duplicate(t=this._render,e=this._color,i=this._filter,s=this._compositeOperation,r=this._opacity,n=this._lineWidth,a=this._lineDash,o=this._lineDashOffset,l=this._lineJoin,h=this._lineCap){return new RenderStyles(t,Color.uniquify(e),i,s,r,n,a,o,l,h)}getStyles(){return[this._lineWidth,this._lineDash,this._lineDashOffset,this._lineJoin,this._lineCap]}toString(t=this._color,e=this._filter,i=this._compositeOperation,s=this._opacity,r=this._lineWidth,n=this._lineDash,a=this._lineDashOffset,o=this._lineJoin,l=this._lineCap){let h=RenderStyles.SERIALIZATION_SEPARATOR,_=Color.getColorValue(t);return(_ instanceof CanvasGradient||_ instanceof CanvasPattern)&&(_=t.toString()),_+h+e+h+i+h+s+h+r+h+n+h+a+h+o+h+l}fillOptimizedToString(t=this._color,e=this._filter,i=this._compositeOperation,s=this._opacity){let r=RenderStyles.SERIALIZATION_SEPARATOR,n=Color.getColorValue(t);return(n instanceof CanvasGradient||n instanceof CanvasPattern)&&(n=t.toString()),n+r+e+r+i+r+s}update(t,e,i,s,r,n,a,o,l){return t&&(this.color=t),e&&(this._filter=e),i&&(this._compositeOperation=i),null!=s&&(this._opacity=s),r&&(this._lineWidth=r),n&&(this._lineDash=n),a&&(this._lineDashOffset=a),o&&(this._lineJoin=o),l&&(this._lineCap=l),this}apply(t=this._color,e=this._filter,i=this._compositeOperation,s=this._opacity,r=this._lineWidth,n=this._lineDash,a=this._lineDashOffset,o=this._lineJoin,l=this._lineCap){const h=this.#D,_=Color.getColorValue(t),c=this._render.currentCtxStyles,u=this._render.currentCtxVisuals;if(!t||u[0]===_&&h.strokeStyle===_||(u[0]=h.strokeStyle=h.fillStyle=_),e&&u[1]!==e&&(u[1]=h.filter=e),i&&u[2]!==i&&(u[2]=h.globalCompositeOperation=i),null!=s&&u[3]!==s&&(u[3]=h.globalAlpha=s),null!=r&&c[0]!==r&&(c[0]=h.lineWidth=r),n){const t=n.toString();c[1]!==t&&(c[1]=t,h.setLineDash(n))}null!==a&&c[2]!==a&&(c[2]=h.lineDashOffset=a),o&&c[3]!==o&&(c[3]=h.lineJoin=o),l&&c[4]!==l&&(c[4]=h.lineCap=l)}static apply(t,e,i,s,r,n,a,o,l,h){const _=t.ctx,c=e&&Color.getColorValue(e),u=t.currentCtxStyles,E=t.currentCtxVisuals;if(!e||E[0]===c&&_.strokeStyle===c||(E[0]=_.strokeStyle=_.fillStyle=c),i&&E[1]!==i&&(E[1]=_.filter=i),s&&E[2]!==s&&(E[2]=_.globalCompositeOperation=s),null!=r&&E[3]!==r&&(E[3]=_.globalAlpha=r),null!=n&&u[0]!==n&&(u[0]=_.lineWidth=n),a){const t=a.toString();u[1]!==t&&(u[1]=t,_.setLineDash(a))}null!==o&&u[2]!==o&&(u[2]=_.lineDashOffset=o),l&&u[3]!==l&&(u[3]=_.lineJoin=l),h&&u[4]!==h&&(u[4]=_.lineCap=h)}[Symbol.toPrimitive](){return this.toString()}*[Symbol.iterator](){const t=this.getStyles(),e=t.length;for(let i=0;i<e;i++)yield t[i]}get[Symbol.toStringTag](){return this.instanceOf}get instanceOf(){return"RenderStyles"}get id(){return this.id}get render(){return this._render}get lineWidth(){return this._lineWidth}get lineCap(){return this._lineCap}get lineJoin(){return this._lineJoin}get lineDash(){return this._lineDash}get lineDashOffset(){return this._lineDashOffset}set render(t){this._render=t,this.#D=t.ctx}set lineWidth(t){return this._lineWidth=t}set lineCap(t){return this._lineCap=t}set lineJoin(t){return this._lineJoin=t}set lineDash(t){return this._lineDash=t}set lineDashOffset(t){return this._lineDashOffset=t}}const CDE_CANVAS_TIMEOUT_FUNCTION=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.msRequestAnimationFrame||function(t){window.setTimeout(()=>t(performance.now()),1e3/60)};export class Canvas{static DOMParser=new DOMParser;static CANVAS_ID_GIVER=0;static ELEMENT_ID_GIVER=0;static DEFAULT_MAX_DELTATIME_MS=130;static DEFAULT_MAX_DELTATIME=Canvas.DEFAULT_MAX_DELTATIME_MS/1e3;static DEFAULT_MAXDELAY_MULTIPLIER=.44;static DEFAULT_CANVAS_ACTIVE_AREA_PADDING=25;static DEFAULT_CVSDE_ATTR="_CVSDE";static DEFAULT_CVSFRAMEDE_ATTR="_CVSDE_F";static DEFAULT_CUSTOM_SVG_FILTER_ID_PREFIX="CDE_FE_";static DEFAULT_CUSTOM_SVG_FILTER_CONTAINER_ID=Canvas.DEFAULT_CUSTOM_SVG_FILTER_ID_PREFIX+"CONTAINER";static CURSOR_STYLES={CUSTOM:(t,e=[0,0],i=Canvas.CURSOR_STYLES.AUTO)=>`url("${t}") ${e.join(" ")}, ${i}`,AUTO:"auto",POINTER:"pointer",DEFAULT:"default",CROSSHAIR:"crosshair",MOVE:"move",TEXT:"text",WAIT:"wait",HELP:"help",NONE:"none",GRAB:"grab",GRABBING:"grabbing",ALL_SCROLL:"all-scroll",COL_RESIZE:"col-resize",ROW_RESIZE:"row-resize",N_RESIZE:"n-resize",E_RESIZE:"e-resize",S_RESIZE:"s-resize",W_RESIZE:"w-resize",NE_RESIZE:"ne-resize",NW_RESIZE:"nw-resize",SE_RESIZE:"se-resize",SW_RESIZE:"sw-resize",ZOOM_IN:"zoom-in",ZOOM_OUT:"zoom-out",NO_DROP:"no-drop",COPY:"copy",NOT_ALLOWED:"not-allowed",VERTICAL_TEXT:"vertical-text",CELL:"cell",CONTEXT_MENU:"context-menu",EXT_RESIZE:"ext-resize",DEFAULT_ARROW:"default",UNSET:"unset"};static LOADED_SVG_FILTERS={};static DEFAULT_CTX_SETTINGS={imageSmoothingEnabled:!1,font:TextStyles.DEFAULT_FONT,letterSpacing:TextStyles.DEFAULT_LETTER_SPACING,wordSpacing:TextStyles.DEFAULT_WORD_SPACING,fontVariantCaps:TextStyles.DEFAULT_FONT_VARIANT_CAPS,direction:TextStyles.DEFAULT_DIRECTION,fontSretch:TextStyles.DEFAULT_FONT_STRETCH,fontKerning:TextStyles.DEFAULT_FONT_KERNING,textAlign:TextStyles.DEFAULT_TEXT_ALIGN,textBaseline:TextStyles.DEFAULT_TEXT_BASELINE,textRendering:TextStyles.DEFAULT_TEXT_RENDERING,lineDashOffset:RenderStyles.DEFAULT_DASH_OFFSET,lineJoin:RenderStyles.DEFAULT_JOIN,lineCap:RenderStyles.DEFAULT_CAP,lineWidth:RenderStyles.DEFAULT_WIDTH,fillStyle:Color.DEFAULT_COLOR,stokeStyle:Color.DEFAULT_COLOR};static DEFAULT_CANVAS_WIDTH=800;static DEFAULT_CANVAS_HEIGHT=800;static DEFAULT_CANVAS_STYLES={position:"absolute",top:"0",left:"0",width:"100%",height:"100%","background-color":"transparent",border:"none",outline:"none","pointer-events":"none !important","z-index":0,padding:"0 !important",margin:"0","-webkit-transform":"translate3d(0, 0, 0)","-moz-transform":"translate3d(0, 0, 0)","-ms-transform":"translate3d(0, 0, 0)",transform:"translate3d(0, 0, 0)","touch-action":"none","-webkit-user-select":"none","user-select":"none"};static STATIC_MODE=0;static STATIC="static";static STATES={STOPPED:0,LOOPING:1,REQUESTED_STOP:2};static#I=[];static#m=[];static DEFAULT_MOUSE_MOVE_THROTTLE_DELAY=10;static ACTIVATION_MARGIN_DISABLED=0;static MOBILE_SCROLLING_STATES={DISABLED:0,IF_CANVAS_STOPPED:1,ALWAYS:2};static#O=new Map;static#P=new IntersectionObserver(t=>{const e=t.length;for(let i=0;i<e;i++){const e=t[i],s=Canvas.getFromHTMLCanvas(e.target);CDEUtils.isFunction(s._onIntersectionChangeCB)&&s._onIntersectionChangeCB(e.intersectionRatio>0,s,e)}});#f=0;#L=0;#y=0;#N=null;#b=null;#U=null;#M=[];#v=null;#F=null;#x=[window.scrollX,window.screenY];#B=null;#G=[];#w=Canvas.MOBILE_SCROLLING_STATES.IF_CANVAS_STOPPED;constructor(t,e,i=null,s,r=Canvas.DEFAULT_CTX_SETTINGS,n=!1){if(this._id=Canvas.CANVAS_ID_GIVER++,!t)throw new Error("The cvs (canvas) parameter is undefined");if(this._cvs=t,this.isOffscreenCanvas||(this._frame=s??t?.parentElement,this._cvs.setAttribute(Canvas.DEFAULT_CVSDE_ATTR,!0),this._frame.setAttribute(Canvas.DEFAULT_CVSFRAMEDE_ATTR,!0),this.onVisibilityChangeCB=null,this._onResizeCB=null,this._onScrollCB=null,this.onIntersectionChangeCB=null,Canvas.#P.observe(this._cvs),Canvas.#O.set(this._cvs,this)),this._ctx=this._cvs.getContext("2d",{willReadFrequently:n??!1}),this._settings=this.updateSettings(r||Canvas.DEFAULT_CTX_SETTINGS),this._els={refs:[],defs:[]},this._state=0,this._loopingCB=e,this.fpsLimit=i,this._speedModifier=1,this.#b=this.#V(i),this._deltaTime=null,this._fixedTimeStamp=null,this._windowListeners=this.#H(),this._viewPos=[0,0],this._zoom=1,this.isOffscreenCanvas)this.#F=[this._cvs.width,this._cvs.height];else{const t=this._frame?.getBoundingClientRect()??{width:Canvas.DEFAULT_CANVAS_WIDTH,height:Canvas.DEFAULT_CANVAS_HEIGHT};this.setSize(t.width,t.height),this.#Y(),this._offset=this.updateOffset()}this._typingDevice=new TypingDevice,this._mouse=new Mouse(this._ctx),this._render=new Render(this._ctx),this._anims=[],this._mouseMoveThrottlingDelay=Canvas.DEFAULT_MOUSE_MOVE_THROTTLE_DELAY}static create(t=null,e,i=null,s,r=Canvas.DEFAULT_CTX_SETTINGS,n=!1){const a=document.createElement("canvas");return(t||document.documentElement).appendChild(a),new Canvas(a,e,i,s,r,n)}static preventNativeZoom(t){const e=CDEUtils.isFunction(t);document.addEventListener("wheel",i=>{(i.ctrlKey||i.metaKey)&&(i.preventDefault(),e&&t(Math.sign(i.deltaY),!0))},{passive:!1}),document.addEventListener("keydown",i=>{const s=i.key;TypingDevice.KEY_GROUPS.NATIVE_ZOOM_KEYS.includes(s)&&(i.ctrlKey||i.metaKey)&&(i.preventDefault(),e&&t("-"===s?1:-1,!1))})}#Y(){const t=document.createElement("style");t.appendChild(document.createTextNode(`[${Canvas.DEFAULT_CVSFRAMEDE_ATTR}]{position:relative !important;outline: none;}canvas[${Canvas.DEFAULT_CVSDE_ATTR}]{${Object.entries(Canvas.DEFAULT_CANVAS_STYLES).reduce((t,e)=>t+`${e[0]}:${e[1]};`,"")}}`)),this._cvs.appendChild(t),this._frame.setAttribute("tabindex",0),this._cvs.setAttribute("draggable","false")}#H(){const t=t=>{const e=this._render,i=this._ctx,[s,r,n,a,o]=e.currentCtxStyles,[l,h,_,c,u,E,d,T,S,A]=e.currentCtxTextStyles,[p,g,R,C]=e.currentCtxVisuals;this.setSize(),i.strokeStyle=i.fillStyle=Color.getColorValue(p),e.currentCtxStyles[0]=i.lineWidth,"string"==typeof r&&(e.currentCtxStyles[1]=r.split(",")),e.currentCtxStyles[2]=i.lineDashOffset,e.currentCtxStyles[3]=i.lineJoin,e.currentCtxStyles[4]=i.lineCap,RenderStyles.apply(e,null,g,R,C,s,"string"==typeof r?r.split(","):r,n,a,o),TextStyles.apply(i,l,h,_,c,u,E,d,T,S,A),this.moveViewAt(this._viewPos),this.hasBeenStarted&&(this._fpsLimit>=25||this._state==Canvas.STATES.STOPPED)&&this.drawSingleFrame(),CDEUtils.isFunction(this._onResizeCB)&&this._onResizeCB(this.size,this,t)},e=t=>{this._typingDevice.clearPressed(),this._onVisibilityChangeCB(!document.hidden,this,t)},i=t=>{const e=window.scrollX,i=window.scrollY,s=this._mouse.x,r=this._mouse.y;this.updateOffset(),null!=s&&null!=r&&(this._mouse.updatePos(this._mouse.x+(e-this.#x[0]),this._mouse.y+(i-this.#x[1]),[0,0]),this.#k()),this.#x[0]=e,this.#x[1]=i,CDEUtils.isFunction(this._onScrollCB)&&this._onScrollCB([e,i],this,t)},s=t=>{const e=Canvas.#I,i=e?.length;if(i)for(let s=0;s<i;s++)e[s](t,this);Canvas.#I=null},r=()=>{this._typingDevice.clearPressed()};return this.isOffscreenCanvas||(window.addEventListener("resize",t),window.addEventListener("visibilitychange",e),window.addEventListener("scroll",i),window.addEventListener("blur",r)),window.addEventListener("load",s),this.isOffscreenCanvas?{removeOnloadListener:()=>window.removeEventListener("load",s)}:{removeOnreziseListener:()=>window.removeEventListener("resize",t),removeOnvisibilitychangeListener:()=>window.removeEventListener("visibilitychange",e),removeOnscrollListener:()=>window.removeEventListener("scroll",i),removeOnBlurListener:()=>window.removeEventListener("blur",r),removeOnloadListener:()=>window.removeEventListener("load",s)}}static getFromHTMLCanvas(t){return Canvas.#O.get(t)}setCursorStyle(t=Canvas.CURSOR_STYLES.DEFAULT){const e=this._frame;e.style.cursor!==t&&(e.style.cursor=t)}static addOnLoadCallback(t){CDEUtils.isFunction(t)&&Canvas.#I&&Canvas.#I.push(t)}static addOnFirstInteractCallback(t){CDEUtils.isFunction(t)&&Canvas.#m&&Canvas.#m.push(t)}static loadSVGFilter(t,e){let i=document.getElementById(Canvas.DEFAULT_CUSTOM_SVG_FILTER_CONTAINER_ID),s=(new DOMParser).parseFromString(t,"text/html").body.firstChild,r=s.querySelector("filter"),n=document.createElement("div");return e?r.id=e:e=r.id,n.id=Canvas.DEFAULT_CUSTOM_SVG_FILTER_ID_PREFIX+e,n.appendChild(s),i||(i=document.createElement("div"),i.id=Canvas.DEFAULT_CUSTOM_SVG_FILTER_CONTAINER_ID,document.head.appendChild(i)),i.appendChild(n),Canvas.LOADED_SVG_FILTERS[e]=[...r.children],e}static getSVGFilter(t){return Canvas.LOADED_SVG_FILTERS[t]}static removeSVGFilter(t){t=Canvas.DEFAULT_CUSTOM_SVG_FILTER_ID_PREFIX+t,document.getElementById(t).remove(),delete Canvas.LOADED_SVG_FILTERS[t]}updateOffset(){const{width:t,height:e,x:i,y:s}=this._cvs.getBoundingClientRect(),r=this._zoom;return this._offset=[Math.round(i+t-this.width)+this._viewPos[0],Math.round(s+e-this.height)+this._viewPos[1],r]}#z(t,e){this.#N=t;const i=(t-this.#f)*this._speedModifier,s=this._fpsLimit;if(2!=this._state)if(s){const r=t-this.#L;r>=s&&(this._fixedTimeStamp=(this.#U+=i)-this.#y,e||this.#W(t),this.#f=t,this.#L=t-r%s)}else this._fixedTimeStamp=(this.#U+=i)-this.#y,e||this.#W(t),this.#f=t;1==this._state?CDE_CANVAS_TIMEOUT_FUNCTION(this.#z.bind(this)):this._state=0}drawSingleFrame(t=null){let e=this._mouse,i=this._loopingCB,s=null!=t,r=s?this.#K(t):this._deltaTime;if(e._moveListenersOptimizationEnabled||(e.checkListeners(Mouse.LISTENER_TYPES.ENTER),e.checkListeners(Mouse.LISTENER_TYPES.LEAVE)),this.clear(),this.draw(),this._render.drawBatched(),i&&this._loopingCB(r),s){const e=this._anims,i=e.length;if(this.#U=this._fixedTimeStamp=t,i)for(let t=0;t<i;t++)e[t].getFrame(this.#U,r)}}#W(t){const e=this.#K(t),i=this._mouse,s=this._loopingCB;i.calcSpeed(e),i._moveListenersOptimizationEnabled||(i.checkListeners(Mouse.LISTENER_TYPES.ENTER),i.checkListeners(Mouse.LISTENER_TYPES.LEAVE)),this.clear(),this.draw(),this._render.drawBatched(),s&&this._loopingCB(e);const r=this._anims,n=r.length;if(n)for(let t=0;t<n;t++)r[t].getFrame(this.timeStamp,e)}startLoop(){if(1!=this._state){if(2==this._state)return this._state=1;this._state=1,this.#f&&(this.#y+=(performance.now()-this.#f)*this._speedModifier),this.#z(this.#U||0,!0)}}start(){this.startLoop()}stopLoop(){this._state&&(this._state=2)}stop(){this.stopLoop()}#K(t=0){const e=(t-this.#f)/1e3,i=this.#b/1e3;return this._deltaTime=e>i?i:e}#V(t){return t?t<7?(1.05*(14-t))**3*Canvas.DEFAULT_MAXDELAY_MULTIPLIER:Math.max((360-t)*Canvas.DEFAULT_MAXDELAY_MULTIPLIER,50):Canvas.DEFAULT_MAX_DELTATIME_MS}updateCachedAllEls(){const t=[];t.push(...this.refs),this._els.refs.forEach(e=>t.push(...e.asSource)),t.push(...this._els.defs),this.#M=t,this.#v=t.length}draw(){const t=this.#M,e=this.#v,i=this._render,s=this._deltaTime*this._speedModifier,r=this.timeStamp;for(let n=0;n<e;n++){const e=t[n],a=e.activationMargin;a&&(!0===a||!e.initialized||this.isWithin(e.pos,a))&&e.draw&&e.draw(i,r,s)}}clear(t=0,e=0,i=this.width,s=this.height){this._viewPos[0]||this._viewPos[1]||1!==this._zoom?(this.save(),this.ctx.setTransform(1,0,0,1,0,0),this._ctx.clearRect(t,e,i,s),this.restore()):this._ctx.clearRect(t,e,i,s)}initializeStatic(){this.fpsLimit=0,this.draw(),this.drawStatic();const t=this.getObjs(ImageDisplay),e=t.length;for(let i=0;i<e;i++){const e=t[i];if(null===e.setupCB)e.setupCB=t=>t.draw(this.render,this.timeStamp*this._speedModifier,this._deltaTime);else if(CDEUtils.isFunction(e.setupCB)){const t=e.setupCB;e.setupCB=(e,i)=>{e.draw(this.render,this.timeStamp*this._speedModifier,this._deltaTime),t(e,i)}}}}drawStatic(){this.draw(),this._render.drawBatched(),CDEUtils.isFunction(this._loopingCB)&&this._loopingCB()}cleanDrawStatic(){this.clear(),this.drawStatic()}resetReferences(){this.refs.filter(t=>t.fragile).forEach(t=>t.reset())}#X(){this.updateOffset(),null!=this._mouse.x&&null!=this._mouse.y&&(this._mouse.updatePos(this._mouse.rawX,this._mouse.rawY,this._offset),this.#k())}resetTransformations(t){t&&(this._zoom=1,this._viewPos=[0,0]),this.ctx.setTransform(this._zoom,0,0,this._zoom,this._viewPos[0],this._viewPos[1]),this.#X()}setTransformations(t=this._zoom,e=this._viewPos){this.ctx.setTransform(t,0,0,t,e[0],e[1])}moveViewAt(t){this._viewPos[0]=t[0],this._viewPos[1]=t[1],this.setTransformations(),this.#X()}moveViewBy(t){this._viewPos[0]+=t[0],this._viewPos[1]+=t[1],this.setTransformations(),this.#X()}moveViewTo(t,e=null,i=null,s=null){e??=1e3,i??=Anim.easeInOutQuad,s??=this._viewPos;let[r,n]=t,[a,o]=s,l=a,h=o;CDEUtils.isDefined(r)||(r=a??0),CDEUtils.isDefined(n)||(n=o??0);const _=r-a,c=n-o;if(_||c)return this.playAnim(new Anim(t=>{const e=a+_*t,i=o+c*t,s=e-l,r=i-h;this._viewPos[0]+=s,this._viewPos[1]+=r,l=e,h=i,this.setTransformations(),this.#X()},e,i))}zoomAtPos(t,e){const i=this._zoom,s=this._viewPos,[r,n]=t;this._zoom=e,s[0]=r-(r-s[0])/i*e,s[1]=n-(n-s[1])/i*e,this.#X(),this.setTransformations()}centerViewAt(t){this.moveViewAt([-t[0]+this.width/2,-t[1]+this.height/2])}centerViewTo(t,e=null,i=null){this.moveViewTo([-t[0]+this.width/2,-t[1]+this.height/2],e,i)}playAnim(t){const e=t.endCB;return t.endCB=()=>{this._anims=this._anims.filter(e=>e.id!==t.id),CDEUtils.isFunction(e)&&e()},this._anims.push(t),t}setSize(t,e,i){const{width:s,height:r}=this._frame.getBoundingClientRect(),n=t??s,a=e??r;this._cvs.width===n&&this._cvs.width===a||(this._cvs.width=n??s,this._cvs.height=a??r,i&&(this._frame.style.width=this.width+"px",this._frame.style.height=this.height+"px"),this.updateSettings(),this.updateOffset()),this.#F=[this._cvs.width,this._cvs.height]}updateSettings(t){const e=t||this._settings;return e?(Object.entries(e).forEach(t=>this._ctx[t[0]]=t[1]),this._settings=e):null}add(t,e=!1){const i=t&&(t.length??1);for(let s=0;s<i;s++){const i=t[s]??t;i._parent=this,CDEUtils.isFunction(i.initialize)&&i.initialize(),e||this._els[i.asSource?"refs":"defs"].push(i)}return this.updateCachedAllEls(),t}remove(t){"*"==t?this._els={refs:[],defs:[]}:(this._els.defs=this._els.defs.filter(e=>e.id!==t),this._els.refs=this._els.refs.filter(e=>e.id!==t)),this.updateCachedAllEls()}removeAllObjects(){this.remove("*")}get(t){const e=this.#M,i=this.#v;for(let s=0;s<i;s++){const i=e[s];if(i.id==t)return i}return null}getObjs(t){return this.allEls.filter(e=>e instanceof t)}save(){this._ctx.save()}restore(){this._ctx.restore()}static#Z(t){if("keydown"!==t.type||"keydown"==t.type&&1==t.key.length){const e=Canvas.#m,i=e?.length;if(i)for(let s=0;s<i;s++)e[s](t);Canvas.#m=null}}#k(t,e){const i=this.refs,s=i.length;for(let t=0;t<s;t++){const e=i[t];e.ratioPosCB||!1===e.ratioPosCB||(e.ratioPos=this._mouse.pos)}this._mouse.checkValid(),CDEUtils.isFunction(t)&&t(this._mouse,e)}setMouseMove(t,e){if(this.isOffscreenCanvas)return!1;{let i=0;this.#B=t;const s=e=>{const s=this.#N;s-i>Math.abs(this._mouseMoveThrottlingDelay*this._speedModifier)&&(i=s,this._mouse.updatePos(e.x,e.y,this._offset),this._mouse.calcAngle(),this.#k(t,e))},r=e=>{const s=e.touches,r=Math.abs(this.#N);r-i>Math.abs(this._mouseMoveThrottlingDelay*this._speedModifier)&&1==s.length&&(i=r,e.x=CDEUtils.round(s[0].clientX,1),e.y=CDEUtils.round(s[0].clientY,1),this._mouse.updatePos(e.x,e.y,this._offset),this._mouse.calcAngle(),this.#k(t,e))},n=e?document:this._frame;return n.addEventListener("mousemove",s),n.addEventListener("touchmove",r),()=>{n.removeEventListener("mousemove",s),n.removeEventListener("touchmove",r)}}}setMouseLeave(t,e){if(this.isOffscreenCanvas)return!1;{const i=e=>{this._mouse.invalidate(),this.#k(t,e)},s=e?document:this._frame;return s.addEventListener("mouseleave",i),()=>s.removeEventListener("mouseleave",i)}}#q(t,e,i){this._mouse.updateMouseClicks(e),CDEUtils.isFunction(t)&&t(this._mouse,e),!i&&Canvas.#m&&Canvas.#Z(e)}setMouseDown(t,e){if(this.isOffscreenCanvas)return!1;{let i=!1;const s=e=>{i=!0;const s=e.touches;if(1==s.length){const i=this.#w;e.cancelable&&(!i||1==i&&this.looping)&&e.preventDefault(),e.x=CDEUtils.round(s[0].clientX,1),e.y=CDEUtils.round(s[0].clientY,1),e.button=0,this._mouse.updatePos(e.x,e.y,this._offset),this._mouse.calcAngle(),this.#k(this.#B,e),this.#q(t,e,!0)}},r=e=>{i||this.#q(t,e),i=!1},n=e?document:this._frame;return n.addEventListener("touchstart",s),n.addEventListener("mousedown",r),()=>{n.removeEventListener("touchstart",s),n.removeEventListener("mousedown",r)}}}setMouseUp(t,e){if(this.isOffscreenCanvas)return!1;{let i=!1;const s=e=>{i=!0;const s=e.changedTouches;e.touches.length||(e.x=CDEUtils.round(s[0].clientX,1),e.y=CDEUtils.round(s[0].clientY,1),e.button=0,this.#q(t,e),this.#k(t,e),setTimeout(()=>this._mouse.invalidate(),50))},r=e=>{i||this.#q(t,e),i=!1},n=e?document:this._frame;return n.addEventListener("touchend",s),n.addEventListener("mouseup",r),()=>{n.removeEventListener("touchend",s),n.removeEventListener("mouseup",r)}}}setKeyDown(t,e){if(this.isOffscreenCanvas)return!1;{const i=e=>{this._typingDevice.setDown(e),CDEUtils.isFunction(t)&&t(this._typingDevice,e)},s=t=>{Canvas.#m&&Canvas.#Z(t)},r=e?document:this._frame;return r.addEventListener("keydown",i),document.addEventListener("keydown",s),()=>r.removeEventListener("keydown",i)}}setKeyUp(t,e){if(this.isOffscreenCanvas)return!1;{const i=e=>{this._typingDevice.setUp(e),CDEUtils.isFunction(t)&&t(this._typingDevice,e)},s=e?document:this._frame;return s.addEventListener("keyup",i),()=>s.removeEventListener("keyup",i)}}getCenter(){return[this.width/2,this.height/2]}isWithin(t,e=0){const i=this._viewPos,s=this._zoom,r=i[0],n=i[1];return t[0]>=-r/s-e&&t[0]<=(this.#F[0]-r)/s+e&&t[1]>=-n/s-e&&t[1]<=(this.#F[1]-n)/s+e}pct(t,e=!0){return e?this.width*t:this.height*t}getResponsivePos(t,e=this.size){return[t[0]*e[0],t[1]*e[1]]}enableAccurateMouseMoveListenersMode(){this.mouseMoveListenersOptimizationEnabled=!1}disableAccurateMouseMoveListenersMode(){this.mouseMoveListenersOptimizationEnabled=!0}disableMouseMoveThrottling(){this._mouseMoveThrottlingDelay=0}disableViewportIntersectionOptimizations(){this.onIntersectionChangeCB=void 0}enableDefaultViewportIntersectionOptimizations(){this.onIntersectionChangeCB=null}[Symbol.toPrimitive](){return this.id}*[Symbol.iterator](){const t=this.allEls,e=t.length;for(let i=0;i<e;i++)yield t[i]}get[Symbol.toStringTag](){return this.instanceOf}get instanceOf(){return"Canvas"}get id(){return this._id}get cvs(){return this._cvs}get frame(){return this._frame}get ctx(){return this._ctx}get width(){return this.#F?.[0]}get height(){return this.#F?.[1]}get size(){return this.#F}get settings(){return this._settings}get loopingCB(){return this._loopingCB}get looping(){return this._state==Canvas.STATES.LOOPING}get stopped(){return this._state==Canvas.STATES.STOPPED}get state(){return this._state}get deltaTime(){return this._deltaTime}get windowListeners(){return this._windowListeners}get timeStamp(){return this._fixedTimeStamp||this.#U}get timeStampNotFixed(){return this.#U}get timeStampRaw(){return this.#N}get els(){return this._els}get mouse(){return this._mouse}get typingDevice(){return this._typingDevice}get keyboard(){return this._typingDevice}get offset(){return this._offset}get defs(){return this._els.defs}get refs(){return this._els.refs}get allDefsAndRefs(){return this.defs.concat(this.refs)}get allEls(){return this.allDefsAndRefs.flatMap(t=>t.dots||t)}get fpsLimitRaw(){return this._fpsLimit}get fpsLimit(){const t=!isFinite(this._fpsLimit);return null==this._fpsLimit||t?t?"static":null:1/(this._fpsLimit/1e3)}get onVisibilityChangeCB(){return this._onVisibilityChangeCB}get onIntersectionChangeCB(){return this._onIntersectionChangeCB}get onResizeCB(){return this._onResizeCB}get onScrollCB(){return this._onScrollCB}get maxTime(){return this.#b}get viewPos(){return this._viewPos}get zoom(){return this._zoom}get render(){return this._render}get speedModifier(){return this._speedModifier}get anims(){return this._anims}get mouseMoveListenersOptimizationEnabled(){return this._mouse._moveListenersOptimizationEnabled}get isOffscreenCanvas(){return this._cvs instanceof OffscreenCanvas}get mouseMoveThrottlingDelay(){return this._mouseMoveThrottlingDelay}get dimensions(){return[[0,0],this.size]}get hasBeenStarted(){return Boolean(this.timeStamp)}get mobileScrollingState(){return this.#w}set id(t){this._id=t}set loopingCB(t){this._loopingCB=t}set width(t){this.setSize(t,null)}set height(t){this.setSize(null,t)}set offset(t){this._offset=t}set fpsLimit(t){this._fpsLimit=CDEUtils.isDefined(t)&&isFinite(t)?1e3/Math.max(t,0):null,this.#b=this.#V(t)}set onVisibilityChangeCB(t){this.#G[0]=this._state,this._onVisibilityChangeCB=(e,i,s)=>{e||(this.#G[0]=this._state),1==this.#G[0]&&(e?(this.startLoop(),this.resetReferences()):this.stopLoop()),CDEUtils.isFunction(t)&&t(e,i,s)}}set onIntersectionChangeCB(t){void 0===t?this._onIntersectionChangeCB=null:(this.#G[1]=this._state,this._onIntersectionChangeCB=(e,i,s)=>{e||(this.#G[1]=this._state),this.#G[1]==Canvas.STATES.LOOPING&&(e?(this.startLoop(),this.resetReferences()):this.stopLoop()),CDEUtils.isFunction(t)&&t(e,i,s)})}set onResizeCB(t){this._onResizeCB=t}set onScrollCB(t){this._onScrollCB=t}set speedModifier(t){this._speedModifier=t}set mouseMoveListenersOptimizationEnabled(t){this._mouse._moveListenersOptimizationEnabled=t}set mouseMoveThrottlingDelay(t){this._mouseMoveThrottlingDelay=t}set mobileScrollingState(t){this.#w=t}}export class Anim{static#j=0;static DEFAULT_DURATION=1e3;constructor(t,e,i,s){this._id=Anim.#j++,this._animation=t,this._duration=e??Anim.DEFAULT_DURATION,this._easing=i||Anim.linear,this._endCB=s,this._startTime=null,this._progress=0,this._playCount=0,this._isReversed=!1}getFrame(t,e){const i=this._duration<0,s=i?-this._duration:this._duration,r=this._startTime,n=this._isReversed;if(!this._playCount||i)if(r)if(e>=0&&t<r+s){let i=t-r,a=this._easing(Math.abs(i)/s);this._progress=n?1-a:a,this._animation(this._progress,this._playCount,e,this.progress),n&&i>0&&(this._isReversed=!1,this._playCount++)}else if(e<0&&t>r-s){let i=r-t,a=this._easing(Math.abs(i)/s);!n&&i>0&&(this._isReversed=!0,this._playCount++),this._easing(Math.abs(r-(t+1e3*e))/s)>1?(this._startTime=null,this._animation(0,this._playCount++,e,0)):(this._progress=this._isReversed?1-a:a,this._animation(this._progress,this._playCount,e,this.progress))}else i?this._isReversed?(this._startTime=null,this._playCount++):this.reset(!0,e):this.end(e);else this._startTime=t}end(t){this._animation(1,this._playCount++,t,1),CDEUtils.isFunction(this._endCB)&&this._endCB(this)}reset(t,e){t?this._animation(1,this._playCount++,e,1):this._playCount=0,this._progress=0,this._startTime=null}[Symbol.toPrimitive](){return this.id}get[Symbol.toStringTag](){return this.instanceOf}get instanceOf(){return"Anim"}get id(){return this._id}get animation(){return this._animation}get duration(){return this._duration}get easing(){return this._easing}get endCB(){return this._endCB}get startTime(){return this._startTime}get progress(){return CDEUtils.clamp(this._progress,0,1)}get progressRaw(){return this._progress}get playCount(){return this._playCount}set startTime(t){this._startTime=t}set animation(t){this._animation=t}set duration(t){this._duration=t}set easing(t){this._easing=t}set endCB(t){this._endCB=t}static easeInSine=t=>1-Math.cos(t*Math.PI/2);static easeOutSine=t=>Math.sin(t*Math.PI/2);static easeInOutSine=t=>-(Math.cos(Math.PI*t)-1)/2;static easeInCubic=t=>t*t*t;static easeOutCubic=t=>1-Math.pow(1-t,3);static easeInOutCubic=t=>t<.5?4*t*t*t:1-Math.pow(-2*t+2,3)/2;static easeInQuint=t=>t*t*t*t*t;static easeOutQuint=t=>1-Math.pow(1-t,5);static easeInOutQuint=t=>t<.5?16*t*t*t*t*t:1-Math.pow(-2*t+2,5)/2;static easeInCirc=t=>1-Math.sqrt(1-Math.pow(t,2));static easeOutCirc=t=>Math.sqrt(1-Math.pow(t-1,2));static easeInOutCirc=t=>t<.5?(1-Math.sqrt(1-Math.pow(2*t,2)))/2:(Math.sqrt(1-Math.pow(-2*t+2,2))+1)/2;static easeInElastic=t=>0==t?0:1==t?1:-Math.pow(2,10*t-10)*Math.sin((10*t-10.75)*(2*Math.PI/3));static easeOutElastic=t=>0==t?0:1==t?1:Math.pow(2,-10*t)*Math.sin((10*t-.75)*(2*Math.PI/3))+1;static easeInOutElastic=t=>0==t?0:1==t?1:t<.5?-Math.pow(2,20*t-10)*Math.sin((20*t-11.125)*(2*Math.PI)/4.5)/2:Math.pow(2,-20*t+10)*Math.sin((20*t-11.125)*(2*Math.PI)/4.5)/2+1;static easeInQuad=t=>t*t;static easeOutQuad=t=>1-(1-t)*(1-t);static easeInOutQuad=t=>t<.5?2*t*t:1-Math.pow(-2*t+2,2)/2;static easeInQuart=t=>t*t*t*t;static easeOutQuart=t=>1-Math.pow(1-t,4);static easeInOutQuart=t=>t<.5?8*t*t*t*t:1-Math.pow(-2*t+2,4)/2;static easeInExpo=t=>0==t?0:Math.pow(2,10*t-10);static easeOutExpo=t=>1==t?1:1-Math.pow(2,-10*t);static easeInOutExpo=t=>0==t?0:1==t?1:t<.5?Math.pow(2,20*t-10)/2:(2-Math.pow(2,-20*t+10))/2;static easeInBack=t=>2.70158*t*t*t-1.70158*t*t;static easeOutBack=t=>1+2.70158*Math.pow(t-1,3)+1.70158*Math.pow(t-1,2);static easeInOutBack=t=>t<.5?Math.pow(2*t,2)*(7.189819*t-2.5949095)/2:(Math.pow(2*t-2,2)*(3.5949095*(2*t-2)+2.5949095)+2)/2;static easeInBounce=t=>1-Anim.easeOutBounce(1-t);static easeOutBounce=t=>t<1/2.75?7.5625*t*t:t<2/2.75?7.5625*(t-=1.5/2.75)*t+.75:t<2.5/2.75?7.5625*(t-=2.25/2.75)*t+.9375:7.5625*(t-=2.625/2.75)*t+.984375;static easeInOutBounce=t=>t<.5?(1-Anim.easeOutBounce(1-2*t))/2:(1+Anim.easeOutBounce(2*t-1))/2;static linear=t=>t}export class _BaseObj extends _HasColor{static DEFAULT_POS=[0,0];static DEFAULT_ACTIVATION_MARGIN=Canvas.DEFAULT_CANVAS_ACTIVE_AREA_PADDING;static ACTIVATION_MARGIN_DISABLED=Canvas.ACTIVATION_MARGIN_DISABLED;static ABSOLUTE_ANCHOR=[0,0];static POSITION_PRECISION=6;#Q=[0,0];#$=null;constructor(t,e,i,s,r,n){super(e),this._id=Canvas.ELEMENT_ID_GIVER++,this._initPos=t||[0,0],this._pos=[0,0],this._setupCB=i??null,this._loopCB=s,this._setupResults=null,this._anchorPos=r,this._activationMargin=n??Canvas.DEFAULT_CANVAS_ACTIVE_AREA_PADDING,this._parent=null,this._rotation=0,this._scale=[1,1],this._anims={backlog:[],currents:[]},this._visualEffects=null,this._initialized=!1}initialize(){if(this._pos=this.getInitPos()||_BaseObj.DEFAULT_POS,this.color=this.getInitColor(),this.setAnchoredPos(),CDEUtils.isFunction(this._setupCB)){const t=this._setupCB(this,this.parent);void 0!==t&&(this._setupResults=t)}}draw(t,e){this.setAnchoredPos();const i=this._loopCB;i&&this.initialized&&i(this,e);let s=this._anims.currents;this._anims.backlog[0]&&(s=[...s,this._anims.backlog[0]]);const r=s.length;if(r)for(let i=0;i<r;i++)s[i].getFrame(t,e)}getInitColor(){return CDEUtils.isFunction(this._initColor)?this._initColor(this.render??this.parent.render,this):this._initColor||null}getInitPos(){return CDEUtils.isFunction(this._initPos)?CDEUtils.unlinkArr2(this._initPos(this._parent instanceof Canvas?this:this._parent,this)):CDEUtils.unlinkArr2(this.adjustPos(this._initPos))}setAnchoredPos(){const t=this.hasAnchorPosChanged;t&&(this.relativeX+=t[0]-this.#Q[0],this.relativeY+=t[1]-this.#Q[1],this.#Q=t)}moveAt(t){const[e,i]=t;CDEUtils.isDefined(e)&&isFinite(e)&&(this.x=e),CDEUtils.isDefined(i)&&isFinite(i)&&(this.y=i)}moveBy(t){const[e,i]=t;CDEUtils.isDefined(e)&&isFinite(e)&&(this.x+=e),CDEUtils.isDefined(i)&&isFinite(i)&&(this.y+=i)}moveTo(t,e,i,s,r,n){e??=1e3,i??=Anim.easeInOutQuad,s??=this.pos_,r??=!0,n??=!0;const[a,o]=s,[l,h]=this.adjustPos(t),_=l-a,c=h-o;return this.playAnim(new Anim(t=>{this.x=a+_*t,this.y=o+c*t},e,i),r,n)}rotateBy(t){this.rotation=(this._rotation+t)%360}rotateAt(t){this.rotation=t%360}rotateTo(t,e=1e3,i=Anim.easeInOutQuad,s=!1,r=!1){const n=this._rotation,a=t-this._rotation;return this.playAnim(new Anim(t=>this.rotateAt(n+a*t),e,i),s,r)}scaleBy(t){let[e,i]=t;CDEUtils.isDefined(e)||(e=this._scale[0]),CDEUtils.isDefined(i)||(i=this._scale[1]),this.scale[0]*=e,this.scale[1]*=i}scaleAt(t){this.scale=t}scaleTo(t,e=1e3,i=Anim.easeInOutQuad,s=this.pos,r=!1,n=!1){const a=CDEUtils.unlinkArr2(this._scale),o=t[0]-a[0],l=t[1]-a[1];return this.playAnim(new Anim(t=>this.scaleAt([a[0]+o*t,a[1]+l*t],s),e,i),r,n)}follow(t,e,i,s){let[r,n]=this._pos,a=s.length-1;this.playAnim(new Anim(t=>{let e=null;t<0&&(t=0);for(let i=a;i>=0;i--){let r=s[i];if(r[0]<=t){e=r;break}}const[o,l]=e[1](t,t-e[0],this,r,n);this.moveAt([r+o,n+l]),CDEUtils.isFunction(i)&&i(t,this)},t,e))}addForce(t,e,i=1e3,s=Anim.easeInOutQuad,r=!0,n=!0){let a=CDEUtils.toRad(e),o=this.x,l=this.y,h=CDEUtils.getAcceptableDiff(t*Math.cos(a),CDEUtils.DEFAULT_ACCEPTABLE_DIFFERENCE),_=CDEUtils.getAcceptableDiff(t*Math.sin(a),CDEUtils.DEFAULT_ACCEPTABLE_DIFFERENCE);return this.playAnim(new Anim(t=>{this.x=o+h*t,this.y=l-_*t},i,s),r,n)}playAnim(t,e,i){e&&this.currentBacklogAnim&&i&&(this.currentBacklogAnim.end(),this._anims.backlog=CDEUtils.addAt(this._anims.backlog,t,0));const s=t.endCB;return t.endCB=()=>{e?this._anims.backlog.shift():this._anims.currents=this._anims.currents.filter(e=>e.id!==t.id),CDEUtils.isFunction(s)&&s()},this._anims[e?"backlog":"currents"].push(t),t}clearAnims(){this._anims.backlog=[],this._anims.currents=[]}adjustPos(t){let[e,i]=t;return CDEUtils.isDefined(e)||(e=this.x??0),CDEUtils.isDefined(i)||(i=this.y??0),[e,i]}remove(){this._parent.remove(this._id)}isWithin(t,e){return t[0]>=e[0][0]&&t[0]<=e[1][0]&&t[1]>=e[0][1]&&t[1]<=e[1][1]}getCenter(t){return CDEUtils.getPositionsCenter(t)}getCorners(t,e=0,i=null,s=null,r=this.getCenter(t)){const n=CDEUtils.rotatePos,a=CDEUtils.scalePos;return t[2]=[t[1][0],t[0][1]],t[3]=[t[0][0],t[1][1]],s&&(t[0]=a(t[0],s,r),t[1]=a(t[1],s,r),t[2]=a(t[2],s,r),t[3]=a(t[3],s,r)),i&&(t[0]=n(t[0],i,r),t[1]=n(t[1],i,r),t[2]=n(t[2],i,r),t[3]=n(t[3],i,r)),e??=0,e&&(e="number"==typeof e?[e,e,e,e]:[e[0],e[1]??e[0],e[2]??e[0],e[3]??e[1]],t[0][0]-=e[3],t[0][1]-=e[0],t[2][0]+=e[1],t[2][1]-=e[0],t[1][0]+=e[1],t[1][1]+=e[2],t[3][0]-=e[3],t[3][1]+=e[2]),t}getBounds(t,e,i,s,r=this.getCenter(t)){let n=Infinity,a=Infinity,o=-Infinity,l=-Infinity;const h=(t=this.getCorners(t,0,i,s,r)).length;for(let e=0;e<h;e++){let[i,s]=t[e];i<n&&(n=i),i>o&&(o=i),s<a&&(a=s),s>l&&(l=s)}return e??=0,[[n-(e="number"==typeof e?[e,e,e,e]:[e[0],e[1]??e[0],e[2]??e[0],e[3]??e[1]])[3],a-e[0]],[o+e[1],l+e[2]]]}disable(){this.#$=this._activationMargin,this._activationMargin=Canvas.ACTIVATION_MARGIN_DISABLED}enable(){this.#$&&(this._activationMargin=this.#$,this.#$=null)}get[Symbol.toStringTag](){return this.instanceOf}get instanceOf(){return"_BaseObj"}get id(){return this._id}get x(){return this._pos[0]}get y(){return this._pos[1]}get pos(){return this._pos}get pos_(){return CDEUtils.unlinkArr2(this._pos)}get relativeX(){return this.x-this.anchorPos[0]}get relativeY(){return this.y-this.anchorPos[1]}get relativePos(){return[this.relativeX,this.relativeY]}get stringPos(){return this.x+","+this.y}get initPos(){return this._initPos}get currentBacklogAnim(){return this._anims.backlog[0]}get anims(){return this._anims}get setupCB(){return this._setupCB}get loopCB(){return this._loopCB}get loopingCB(){return this._loopCB}get setupResults(){return this._setupResults}get initialized(){return this._initialized}get activationMargin(){return this._activationMargin}get anchorPosRaw(){return this._anchorPos}get anchorPos(){if(Array.isArray(this._anchorPos))return this._anchorPos;if(!this._anchorPos)return this.parent instanceof Canvas?[0,0]:this.parent?.pos_;if(this._anchorPos instanceof _BaseObj)return this._anchorPos.pos_;if(CDEUtils.isFunction(this._anchorPos)){const t=this._anchorPos(this,this.parent);return CDEUtils.unlinkArr2(t?.pos_||t||[0,0])}}get lastAnchorPos(){return this.#Q}get hasAnchorPosChanged(){const t=this.anchorPos;return!CDEUtils.posEquals(this.#Q,t)&&t}get parent(){return this._parent}get rotation(){return this._rotation}get scale(){return this._scale}get visualEffects(){return this._visualEffects??[]}get visualEffects_(){const t=this._visualEffects;return t?CDEUtils.unlinkArr3(t):[]}get filter(){return this._visualEffects?.[0]??Render.DEFAULT_FILTER}get compositeOperation(){return this._visualEffects?.[1]??Render.DEFAULT_COMPOSITE_OPERATION}get opacity(){return this._visualEffects?.[2]??Render.DEFAULT_ALPHA}get safeColorObject(){return this.initialized&&this._color}get lastActivationMargin(){return this.#$}get enabled(){return!this.#$}get disabled(){return Boolean(this.#$)}set x(t){this._pos[0]=CDEUtils.round(t,_BaseObj.POSITION_PRECISION)}set y(t){this._pos[1]=CDEUtils.round(t,_BaseObj.POSITION_PRECISION)}set pos(t){this.x=t[0],this.y=t[1]}set relativeX(t){this.x=this.anchorPos[0]+t}set relativeY(t){this.y=this.anchorPos[1]+t}set relativePos(t){this.relativeX=CDEUtils.round(t[0],_BaseObj.POSITION_PRECISION),this.relativeY=CDEUtils.round(t[1],_BaseObj.POSITION_PRECISION)}set initPos(t){this._initPos=t}set setupCB(t){this._setupCB=t}set loopCB(t){this._loopCB=t}set loopingCB(t){this._loopCB=t}set setupResults(t){this._setupResults=t}set initialized(t){this._initialized=t}set activationMargin(t){this._activationMargin=t}set anchorPos(t){this.anchorPosRaw=t}set anchorPosRaw(t){this._anchorPos=t}set lastAnchorPos(t){this.#Q=t}set rotation(t){this._rotation=t%360}set scale(t){let[e,i]=t;CDEUtils.isDefined(e)||(e=this._scale[0]),CDEUtils.isDefined(i)||(i=this._scale[1]),this._scale[0]=e,this._scale[1]=i}set visualEffects(t){this._visualEffects=t?.length?CDEUtils.unlinkArr3(t):null}set filter(t){const e=this._visualEffects;e?e[0]=t:this._visualEffects=[t]}set compositeOperation(t){const e=this._visualEffects;e?e[1]=t:this._visualEffects=[,t]}set opacity(t){const e=this._visualEffects;e?e[2]=t:this._visualEffects=[,,t]}}export class AudioDisplay extends _BaseObj{static LOADED_IR_BUFFERS=[];static SUPPORTED_AUDIO_FORMATS=["mp3","wav","ogg","aac","m4a","opus","flac"];static SOURCE_TYPES={FILE_PATH:"string",DYNAMIC:"[object Object]",MICROPHONE:"MICROPHONE",SCREEN_AUDIO:"SCREEN_AUDIO",VIDEO:HTMLVideoElement,AUDIO:HTMLAudioElement};static MINIMAL_FFT=1;static MAXIMAL_FFT=32768;static DEFAULT_SAMPLE_COUNT=64;static DEFAULT_BINCB=(t,e,i,s)=>{const r=100*e;return t.batchFill(Render.getRect(i,2,r),s._color,s.visualEffects),i[0]+=5,[i]};static DEFAULT_BINCB_TRANSFORMABLE=(t,e,i,s)=>{const r=100*e;return t.fill(Render.getRect(i,2,r),s._color,s.visualEffects),i[0]+=5,[i]};static BIN_CALLBACKS={DEFAULT:AudioDisplay.DEFAULT_BINCB,CIRCLE:AudioDisplay.CIRCLE(),BARS:AudioDisplay.BARS(),TOP_WAVE:AudioDisplay.TOP_WAVE()};static MICROPHONE_CHANNELS={MONO:1,STEREO:2};static DEFAULT_MICROPHONE_DELAY=1;static DEFAULT_MICROPHONE_AUTO_GAIN_CONTROL=!1;static DEFAULT_MICROPHONE_ECHO_CANCELLATION=!1;static DEFAULT_MICROPHONE_NOISE_SUPPRESSION=!1;static DEFAULT_MICROPHONE_CHANNEL_COUNT=AudioDisplay.MICROPHONE_CHANNELS.STEREO;static DEFAULT_MICROPHONE_SAMPLE_RATE=48e3;static DEFAULT_MICROPHONE_SAMPLE_SIZE=16;static DEFAULT_MICROPHONE_SETTINGS=AudioDisplay.loadMicrophone();static DEFAULT_SCREEN_AUDIO_SETTINGS=AudioDisplay.loadScreenAudio();static MAX_NORMALISED_DATA_VALUE=255/128;static MAX_DELAY_TIME=179;static ERROR_TYPES={NO_PERMISSION:0,DEVICE_IN_USE:1,SOURCE_DISCONNECTED:2,FILE_NOT_FOUND:3,NOT_AVAILABLE:4,NOT_SUPPORTED:5};static BIQUAD_FILTER_TYPES={DEFAULT:"allpass",ALLPASS:"allpass",BANDPASS:"bandpass",HIGHPASS:"highpass",HIGHSHELF:"highshelf",LOWPASS:"lowpass",LOWSHELF:"lowshelf",NOTCH:"notch",PEAKING:"peaking"};static IS_MICROPHONE_SUPPORTED=()=>!!navigator?.mediaDevices?.getUserMedia;static IS_SCREEN_ADUIO_SUPPORTED=()=>!!navigator?.mediaDevices?.getDisplayMedia;static DEFAULT_MEDIA_ERROR_CALLBACK=(t,e)=>console.warn("Error while loading media:",AudioDisplay.getErrorFromCode(t),"("+e+")");#J=null;#tt=null;#et=null;constructor(t,e,i,s,r,n,a,o,l,h,_,c){super(e,i,l,h,_,c),this._source=t??"",this._binCB=s??AudioDisplay.DEFAULT_BINCB,this._sampleCount=r??AudioDisplay.DEFAULT_SAMPLE_COUNT,this._disableAudio=n??!1,this._offsetPourcent=a??0,this._errorCB=o||AudioDisplay.DEFAULT_MEDIA_ERROR_CALLBACK,this._transformable=0,this._audioCtx=new AudioContext,Canvas.addOnFirstInteractCallback(()=>this._audioCtx.resume()),this._audioAnalyser=this._audioCtx.createAnalyser(),this._gainNode=this._audioCtx.createGain(),this._biquadFilterNode=this._audioCtx.createBiquadFilter(),this._biquadFilterNode.type=AudioDisplay.BIQUAD_FILTER_TYPES.DEFAULT,this._convolverNode=this._audioCtx.createConvolver(),this._waveShaperNode=this._audioCtx.createWaveShaper(),this._dynamicsCompressorNode=this._audioCtx.createDynamicsCompressor(),this._pannerNode=this._audioCtx.createPanner(),this._delayNode=this._audioCtx.createDelay(AudioDisplay.MAX_DELAY_TIME),this.#et=this._audioAnalyser.fftSize=Math.max(32,2**Math.round(Math.log2(2*this._sampleCount))),this.#J=this._audioAnalyser.frequencyBinCount,this.#tt=new Uint8Array(this.#J)}initialize(){this.initializeSource(),this._pos=this.getInitPos()||_BaseObj.DEFAULT_POS,this.setAnchoredPos(),super.initialize()}draw(t,e,i){if(this.initialized){const e=t.ctx,i=1!==this._scale[0]||1!==this._scale[1],s=this._rotation||i,r=this.#tt;let n,a;if(this._transformable&&s){const t=this._pos[0],s=this._pos[1],r=this.parent;n=r.viewPos,a=r.zoom,e.translate(t,s),this._rotation&&e.rotate(CDEUtils.toRad(this._rotation)),i&&e.scale(this._scale[0],this._scale[1]),e.translate(-t,-s)}this._audioAnalyser.getByteFrequencyData(r);let o=this.pos_,l=null,h=this._sampleCount,_=this._offsetPourcent%1*(this.#et/2),c=Math.round(.49+h)-_,u=-_,E=0|_;for(;u<c;u++,E=(E+1)%h){const e=r[E],i=this._binCB(t,e/128,o,this,l,E,h,e),s=i?.[0],n=i?.[1];s&&(o=s),n&&(l=n)}this._transformable&&s&&e.setTransform(a,0,0,a,n[0],n[1])}super.draw(e,i)}#it(){const t=this._rotation||1!=this._scale[0]||1!=this._scale[1];t&&this._transformable<2?this._transformable=2:!t&&this._transformable&&this._transformable--}isWithin(t,e,i,s){return super.isWithin(t,this.getBounds(e,i,s),e)}#st(t=2,e=100,i=5){const s=this._pos,r=this._sampleCount*(t*i)/2;return[[s[0],s[1]],[s[0]+r,s[1]+2*e]]}getCenter(){return super.getCenter(this.#st())}getBounds(t,e=this._rotation,i=this._scale){const s=this.#st();return super.getBounds(s,t,e,i,this._pos)}initializeSource(t=this._source){AudioDisplay.initializeDataSource(t,(e,i)=>{this._source=e,i?(e.oninactive=e=>{CDEUtils.isFunction(this._errorCB)&&this._errorCB(AudioDisplay.ERROR_TYPES.SOURCE_DISCONNECTED,t,e)},this._source=this._audioCtx.createMediaStreamSource(e),this._source.connect(this._gainNode)):this._audioCtx.createMediaElementSource(e).connect(this._gainNode),this._gainNode.connect(this._biquadFilterNode),this._biquadFilterNode.connect(this._waveShaperNode),this._waveShaperNode.connect(this._dynamicsCompressorNode),this._dynamicsCompressorNode.connect(this._pannerNode),this._pannerNode.connect(this._delayNode),this._delayNode.connect(this._audioAnalyser),this._disableAudio||this._audioAnalyser.connect(this._audioCtx.destination),this._initialized=!0,CDEUtils.isFunction(this._setupCB)&&(this._setupResults=this._setupCB(this,this._parent,this._source))},this._errorCB)}static initializeDataSource(t,e,i){const s=AudioDisplay.SOURCE_TYPES;typeof t==s.FILE_PATH?AudioDisplay.isAudioFormatSupported(t)?AudioDisplay.#rt(AudioDisplay.loadAudio(t),e,i):ImageDisplay.isVideoFormatSupported(t)?AudioDisplay.#rt(ImageDisplay.loadVideo(t),e,i):CDEUtils.isFunction(i)&&i(AudioDisplay.ERROR_TYPES.NOT_SUPPORTED,t):t.toString()==s.DYNAMIC?t.type==s.MICROPHONE?AudioDisplay.#nt(t.settings,e,i):t.type==s.SCREEN_AUDIO&&AudioDisplay.#at(t.settings,e,i):t instanceof s.VIDEO||t instanceof s.AUDIO?AudioDisplay.#rt(t,e,i):t instanceof MediaStream&&(t.getAudioTracks().length&&CDEUtils.isFunction(e)?e(t,!0):CDEUtils.isFunction(i)&&i(AudioDisplay.ERROR_TYPES.NO_AUDIO_TRACK,t))}static#rt(t,e,i){const s=()=>{CDEUtils.isFunction(e)&&e(t)};t.onerror=e=>{CDEUtils.isFunction(i)&&i(AudioDisplay.ERROR_TYPES.FILE_NOT_FOUND,t,e)},t.readyState?s():t.onloadeddata=s}static#nt(t=!0,e,i){AudioDisplay.IS_MICROPHONE_SUPPORTED()?navigator.mediaDevices.getUserMedia({audio:t}).then(s=>{s.getAudioTracks().length&&CDEUtils.isFunction(e)?e(s,!0):CDEUtils.isFunction(i)&&i(AudioDisplay.ERROR_TYPES.NO_AUDIO_TRACK,t)}).catch(e=>{CDEUtils.isFunction(i)&&i(AudioDisplay.ERROR_TYPES.NO_PERMISSION,t,e)}):CDEUtils.isFunction(i)&&i(AudioDisplay.ERROR_TYPES.NOT_AVAILABLE,t)}static#at(t=!0,e,i){AudioDisplay.IS_MICROPHONE_SUPPORTED()?navigator.mediaDevices.getDisplayMedia({audio:t}).then(s=>{s.getAudioTracks().length&&CDEUtils.isFunction(e)?e(s,!0):CDEUtils.isFunction(i)&&i(AudioDisplay.ERROR_TYPES.NO_AUDIO_TRACK,t)}).catch(e=>{CDEUtils.isFunction(i)&&i(AudioDisplay.ERROR_TYPES.NO_PERMISSION,t,e)}):CDEUtils.isFunction(i)&&i(AudioDisplay.ERROR_TYPES.NOT_AVAILABLE,t)}static loadAudio(t,e=!0,i=!0){const s=new Audio(t);return s.preload="auto",s.loop=e,i&&(s.autoplay=i,ImageDisplay.playMedia(s)),s}static loadMicrophone(t,e,i,s,r,n,a){return t??=AudioDisplay.DEFAULT_MICROPHONE_AUTO_GAIN_CONTROL,e??=AudioDisplay.DEFAULT_MICROPHONE_ECHO_CANCELLATION,i??=AudioDisplay.DEFAULT_MICROPHONE_NOISE_SUPPRESSION,s??=!0,r??=AudioDisplay.DEFAULT_MICROPHONE_DELAY,n??=AudioDisplay.DEFAULT_MICROPHONE_SAMPLE_RATE,a??=AudioDisplay.DEFAULT_MICROPHONE_SAMPLE_SIZE,{type:AudioDisplay.SOURCE_TYPES.MICROPHONE,settings:{autoGainControl:t,channelCount:s?2:1,echoCancellation:e,latency:r,noiseSuppression:i,sampleRate:n,sampleSize:a}}}static loadScreenAudio(t,e,i,s,r,n,a){return t??=AudioDisplay.DEFAULT_MICROPHONE_AUTO_GAIN_CONTROL,e??=AudioDisplay.DEFAULT_MICROPHONE_ECHO_CANCELLATION,i??=AudioDisplay.DEFAULT_MICROPHONE_NOISE_SUPPRESSION,s??=!0,r??=AudioDisplay.DEFAULT_MICROPHONE_DELAY,n??=AudioDisplay.DEFAULT_MICROPHONE_SAMPLE_RATE,a??=AudioDisplay.DEFAULT_MICROPHONE_SAMPLE_SIZE,{type:AudioDisplay.SOURCE_TYPES.SCREEN_AUDIO,settings:{autoGainControl:t,channelCount:s?2:1,echoCancellation:e,latency:r,noiseSuppression:i,sampleRate:n,sampleSize:a}}}static getDistortionCurve(t,e=44100){if(!t)return null;let i=new Float32Array(e),s=0,r=Math.PI,n=Math.abs,a=CDEUtils.TO_DEGREES;for(;s<e;s++){const o=2*s/e-1;i[s]=(3+t)*o*20*a/(r+t*n(o))}return i}connectConvolver(){this._biquadFilterNode.disconnect(0),this._biquadFilterNode.connect(this._convolverNode),this._convolverNode.connect(this._dynamicsCompressorNode)}disconnectConvolver(){this._biquadFilterNode.disconnect(0),this._biquadFilterNode.connect(this._dynamicsCompressorNode)}loadImpulseResponse(t,e=t=>{this.setReverb(t),this.connectConvolver()}){fetch(t).then(t=>t.arrayBuffer()).then(t=>this._audioCtx.decodeAudioData(t)).then(t=>{AudioDisplay.LOADED_IR_BUFFERS.push(t),CDEUtils.isFunction(e)&&e(t)})}setVolume(t=1){this._gainNode.gain.value=t}setBiquadFilterType(t=AudioDisplay.BIQUAD_FILTER_TYPES.DEFAULT){this._biquadFilterNode.type=t}setDistortionCurve(t=null){this._waveShaperNode.curve="number"==typeof t?AudioDisplay.getDistortionCurve(t):t}setOriginPos(t=0,e=0,i=0,s=0){const r=this._audioCtx.currentTime;null!=t&&this._pannerNode.positionX.setValueAtTime(t,r+s),null!=e&&this._pannerNode.positionY.setValueAtTime(e,r+s),null!=i&&this._pannerNode.positionZ.setValueAtTime(i,r+s)}setDelay(t=0){this._delayNode.delayTime.value=t>AudioDisplay.MAX_DELAY_TIME?AudioDisplay.MAX_DELAY_TIME:t}setReverb(t=null){t?this._convolverNode.buffer=t:this.disconnectConvolver()}resetAudioModifiers(){this.setVolume(),this.setBiquadFilterType(),this.setDistortionCurve(),this.setOriginPos(),this.setDelay(),this.setReverb()}static isAudioFormatSupported(t){const e=(t?.name||t).toLowerCase();return AudioDisplay.SUPPORTED_AUDIO_FORMATS.some(t=>e.endsWith("."+t))}static getSupportedHTMLAcceptValue(){return"."+AudioDisplay.SUPPORTED_AUDIO_FORMATS.join(", .")}static getErrorFromCode(t){return Object.keys(AudioDisplay.ERROR_TYPES)[t]}duplicate(t=this._source,e=this.pos_,i=this._color,s=this._binCB,r=this._sampleCount,n=this._disableAudio,a=this._offsetPourcent,o=this._errorCB,l=this._setupCB,h=this._loopCB,_=this._anchorPos,c=this._activationMargin){const u=i,E=u.colorRaw,d=new AudioDisplay(t instanceof MediaStreamAudioSourceNode?t.mediaStream.clone():t.cloneNode(),e,(t,e)=>E instanceof Gradient||E instanceof Pattern?E.duplicate(Array.isArray(E.initPositions)?null:e):u.duplicate(),s,r,n,a,o,l,h,_,c);return d._scale=CDEUtils.unlinkArr2(this._scale),d._rotation=this._rotation,d._visualEffects=this.visualEffects_,this.initialized?d:null}static BARS(t,e,i,s,r){return t??=100,e??=0,i??=1,s??=2,t/=AudioDisplay.MAX_NORMALISED_DATA_VALUE,e/=AudioDisplay.MAX_NORMALISED_DATA_VALUE,r?(r,n,a,o)=>{const l=e+t*n;return r.fill(Render.getRect(a,s,l),o._color,o.visualEffects),a[0]+=i,[a]}:(r,n,a,o)=>{const l=e+t*n;return r.batchFill(Render.getRect(a,s,l),o._color,o.visualEffects),a[0]+=i,[a]}}static CIRCLE(t,e,i,s){return t??=100,e??=0,s??=2,t/=AudioDisplay.MAX_NORMALISED_DATA_VALUE,e/=AudioDisplay.MAX_NORMALISED_DATA_VALUE,i?(i,r,n,a,o,l)=>{l%s==0&&i.stroke(Render.getArc(n,e+t*r),a._color,a.visualEffects)}:(i,r,n,a,o,l)=>{l%s==0&&i.batchStroke(Render.getArc(n,e+t*r),a._color,a.visualEffects)}}static TOP_WAVE(t,e,i,s,r){return t??=100,e??=0,i??=1,r??=2,t/=AudioDisplay.MAX_NORMALISED_DATA_VALUE,e/=AudioDisplay.MAX_NORMALISED_DATA_VALUE,s?(s,n,a,o,l,h,_)=>{const c=e+t*n;return h?h%r==0&&l.lineTo(a[0],a[1]+c):(l=new Path2D).moveTo(a[0],a[1]+c),h==_-1&&s.stroke(l,o._color,o.visualEffects),a[0]+=i,[a,l]}:(s,n,a,o,l,h,_)=>{const c=e+t*n;return h?h%r==0&&l.lineTo(a[0],a[1]+c):(l=new Path2D).moveTo(a[0],a[1]+c),h==_-1&&s.batchStroke(l,o._color,o.visualEffects),a[0]+=i,[a,l]}}static CLOUD(t,e,i,s,r,n){return t??=100,e??=0,i??=2,r??=2,n??=.1,t/=AudioDisplay.MAX_NORMALISED_DATA_VALUE,e/=AudioDisplay.MAX_NORMALISED_DATA_VALUE,s?(s,a,o,l,h,_)=>{const c=e+t*a,u=n*_;return _%r||s.fill(Render.getArc([o[0]+c*Math.cos(u),o[1]+c*Math.sin(u)],i),l._color,l.visualEffects),[o]}:(s,a,o,l,h,_)=>{const c=e+t*a,u=n*_;return _%r||s.batchFill(Render.getArc([o[0]+c*Math.cos(u),o[1]+c*Math.sin(u)],i),l._color,l.visualEffects),[o]}}[Symbol.toPrimitive](){return this.id}*[Symbol.iterator](){const t=this.#tt,e=t.length;for(let i=0;i<e;i++)yield t[i]}get[Symbol.toStringTag](){return this.instanceOf}get instanceOf(){return"AudioDisplay"}get source(){return this._source}get binCB(){return this._binCB}get sampleCount(){return this._sampleCount}get disableAudio(){return this._disableAudio}get offsetPourcent(){return this._offsetPourcent}get errorCB(){return this._errorCB}get audioCtx(){return this._audioCtx}get audioAnalyser(){return this._audioAnalyser}get gainNode(){return this._gainNode}get biquadFilterNode(){return this._biquadFilterNode}get convolverNode(){return this._convolverNode}get waveShaperNode(){return this._waveShaperNode}get dynamicsCompressorNode(){return this._dynamicsCompressorNode}get pannerNode(){return this._pannerNode}get delayNode(){return this._delayNode}get data(){return this.#tt}get fft(){return this.#et}get bufferLength(){return this.#J}get transformableRaw(){return this._transformable}get transformable(){return Boolean(this._transformable)}get top(){return this.#st()[0][1]}get bottom(){return this.#st()[1][1]}get height(){const t=this.#st();return t[1][1]-t[0][1]}get left(){return this.#st()[0][0]}get right(){return this.#st()[1][0]}get width(){const t=this.#st();return t[1][0]-t[0][0]}get video(){return this._source}get image(){return this._source}get paused(){return this._source?.paused}get isPaused(){return this.paused}get playbackRate(){return this._source?.playbackRate}get speed(){return this.playbackRate}get currentTime(){return this._source?.currentTime}get loop(){return this._source?.loop}get isLooping(){return this.loop}set paused(t){try{t?this._source.pause():ImageDisplay.playMedia(this._source)}catch(t){}}set isPaused(t){this.paused=t}set playbackRate(t){this._source.playbackRate=t}set speed(t){this.playbackRate=t}set currentTime(t){this._source.currentTime=t}set loop(t){this._source.loop=t}set isLooping(t){this.loop=t}set binCB(t){this._binCB=t}set sampleCount(t){this._sampleCount=t,this.#et=this._audioAnalyser.fftSize=Math.max(32,2**Math.round(Math.log2(2*this._sampleCount))),this.#J=this._audioAnalyser.frequencyBinCount,this.#tt=new Uint8Array(this.#J)}set disableAudio(t){this._disableAudio=t,t?this._audioAnalyser.disconnect(this._audioCtx.destination):this._audioAnalyser.connect(this._audioCtx.destination)}set offsetPourcent(t){this._offsetPourcent=t}set errorCB(t){this._errorCB=t}set transformable(t){this._transformable=+t}set rotation(t){super.rotation=t,this.#it()}set scale(t){super.scale=t,this.#it()}}export class ImageDisplay extends _BaseObj{static SUPPORTED_IMAGE_FORMATS=["jpg","jpeg","png","gif","svg","webp","bmp","tiff","ico","heif","heic"];static SUPPORTED_VIDEO_FORMATS=["mp4","webm","ogv","mov","avi","mkv","flv","wmv","3gp","m4v"];static DEFAULT_WIDTH=128;static DEFAULT_HEIGHT=128;static SOURCE_TYPES={FILE_PATH:"string",DYNAMIC:"[object Object]",CAMERA:"CAMERA",CAPTURE:"CAPTURE",IMAGE:HTMLImageElement,SVG:SVGImageElement,BITMAP_PROMISE:Promise,BITMAP:ImageBitmap,VIDEO:HTMLVideoElement,CANVAS:HTMLCanvasElement,OFFSCREEN_CANVAS:OffscreenCanvas};static DYNAMIC_SOURCE_TYPES={VIDEO:HTMLVideoElement,CANVAS:HTMLCanvasElement,OFFSCREEN_CANVAS:OffscreenCanvas};static RESOLUTIONS={SD:[640,480],HD:[1280,720],FULL_HD:[1920,1080],"4K":[3840,2160],FOURK:[3840,2160],MAX:[3840,2160]};static CAMERA_FACING_MODES={USER:"user",ENVIRONMENT:"environment"};static DEFAULT_FACING_MODE=ImageDisplay.CAMERA_FACING_MODES.USER;static DEFAULT_CAMERA_RESOLUTION=ImageDisplay.RESOLUTIONS.HD;static DEFAULT_CAMERA_FRAME_RATE=30;static DEFAULT_CAMERA_SETTINGS=ImageDisplay.loadCamera();static DEFAULT_CAMERAS={CAMERA_SD:ImageDisplay.loadCamera(ImageDisplay.RESOLUTIONS.SD),CAMERA_HD:ImageDisplay.loadCamera(ImageDisplay.RESOLUTIONS.HD),CAMERA_FULL_HD:ImageDisplay.loadCamera(ImageDisplay.RESOLUTIONS.FULL_HD),CAMERA_4K:ImageDisplay.loadCamera(ImageDisplay.RESOLUTIONS.FOURK),CAMERA:ImageDisplay.DEFAULT_CAMERA_SETTINGS};static CAPTURE_MEDIA_SOURCES={SCREEN:"screen",WINDOW:"window",TAB:"tab"};static CAPTURE_CURSOR={ALWAYS:"always",MOTION:"motion",NONE:"none"};static DEFAULT_CAPTURE_RESOLUTION=ImageDisplay.RESOLUTIONS.HD;static DEFAULT_CAPTURE_MEDIA_SOURCE="screen";static DEFAULT_CAPTURE_FRAME_RATE=30;static DEFAULT_CAPTURE_CURSOR="always";static DEFAULT_CAPTURE_SETTINGS=ImageDisplay.loadCapture();static DEFAULT_CAPTURES={CAPTURE_SD:ImageDisplay.loadCapture(ImageDisplay.RESOLUTIONS.SD),CAPTURE_HD:ImageDisplay.loadCamera(ImageDisplay.RESOLUTIONS.HD),CAPTURE_FULL_HD:ImageDisplay.loadCamera(ImageDisplay.RESOLUTIONS.FULL_HD),CAPTURE_4k:ImageDisplay.loadCamera(ImageDisplay.RESOLUTIONS.FOURK),CAPTURE:ImageDisplay.DEFAULT_CAPTURE_SETTINGS};static ERROR_TYPES={NO_PERMISSION:0,DEVICE_IN_USE:1,SOURCE_DISCONNECTED:2,FILE_NOT_FOUND:3,NOT_AVAILABLE:4,NOT_SUPPORTED:5};static IS_CAMERA_SUPPORTED=()=>!!navigator?.mediaDevices?.getUserMedia;static IS_SCREEN_RECORD_SUPPORTED=()=>!!navigator?.mediaDevices?.getDisplayMedia;static DEFAULT_MEDIA_ERROR_CALLBACK=(t,e)=>console.warn("Error while loading media:",ImageDisplay.getErrorFromCode(t),"("+e+")");#ot=null;constructor(t,e,i,s,r,n,a,o){super(e,null,r,n,a,o),this._source=t,this._size=i||[],this._errorCB=s||ImageDisplay.DEFAULT_MEDIA_ERROR_CALLBACK,this._sourceCroppingPositions=null}initialize(){ImageDisplay.initializeDataSource(this._source,(t,e)=>{this._source=t,this.#ot=e,this.size=this._size,this._initialized=!0,CDEUtils.isFunction(this._setupCB)&&(this._setupResults=this._setupCB(this,this._parent,this._source))},this._errorCB),this._pos=this.getInitPos()||_BaseObj.DEFAULT_POS,this.setAnchoredPos()}draw(t,e,i){if(this.initialized){const e=this._source;if(e instanceof HTMLVideoElement&&!e.src&&!e.srcObject?.active)return;const i=t.ctx,s=1!==this._scale[0]||1!==this._scale[1],r=this._rotation||s;let n,a;if(r){const t=this.centerX,e=this.centerY,r=this.parent;n=r.viewPos,a=r.zoom,i.translate(t,e),this._rotation&&i.rotate(CDEUtils.toRad(this._rotation)),s&&i.scale(this._scale[0],this._scale[1]),i.translate(-t,-e)}e instanceof HTMLCanvasElement?t.drawLateImage(e,this._pos,this._size,this._sourceCroppingPositions,this.visualEffects):t.drawImage(e,this._pos,this._size,this._sourceCroppingPositions,this.visualEffects),r&&i.setTransform(a,0,0,a,n[0],n[1])}super.draw(e,i)}static initializeDataSource(t,e,i){const s=ImageDisplay.SOURCE_TYPES;if(typeof t==s.FILE_PATH)ImageDisplay.isImageFormatSupported(t)?ImageDisplay.loadImage(t,i).onload=t=>ImageDisplay.#lt(t.target,e):ImageDisplay.isVideoFormatSupported(t)?ImageDisplay.#ht(ImageDisplay.loadVideo(t),e,i):CDEUtils.isFunction(i)&&i(ImageDisplay.ERROR_TYPES.NOT_SUPPORTED,t);else if(t instanceof s.IMAGE||t instanceof s.SVG){const i=t.getAttribute("fakeload");t.complete&&t.src&&!i?ImageDisplay.#lt(t,e):t.onload=()=>{i&&t.removeAttribute("fakeload"),ImageDisplay.#lt(t,e)}}else t.toString()==s.DYNAMIC?t.type==s.CAMERA?ImageDisplay.#_t(t.settings,e,i):t.type==s.CAPTURE&&ImageDisplay.#ct(t.settings,e,i):t instanceof s.VIDEO?ImageDisplay.#ht(t,e,i):t instanceof s.CANVAS||t instanceof s.BITMAP||t instanceof s.OFFSCREEN_CANVAS?ImageDisplay.#lt(t,e):t instanceof MediaStream?ImageDisplay.#ut(t,e,i):t instanceof s.BITMAP_PROMISE&&t.then(t=>ImageDisplay.#lt(t,e))}static#lt(t,e,i=t.width||ImageDisplay.DEFAULT_WIDTH,s=t.height||ImageDisplay.DEFAULT_HEIGHT){CDEUtils.isFunction(e)&&e(t,[i,s])}static#ht(t,e,i){const s=()=>this.#lt(t,e,t.videoWidth,t.videoHeight);t.onerror=e=>{CDEUtils.isFunction(i)&&i(ImageDisplay.ERROR_TYPES.FILE_NOT_FOUND,t,e)},t.readyState?s():t.onloadeddata=s}static#ut(t,e,i){const s=document.createElement("video");s.srcObject=t,s.autoplay=!0,s.setAttribute("permaLoad","1"),t.oninactive=e=>{CDEUtils.isFunction(i)&&i(ImageDisplay.ERROR_TYPES.SOURCE_DISCONNECTED,t,e)},s.oncanplay=()=>this.#lt(s,e,s.videoWidth,s.videoHeight)}static#_t(t=!0,e,i){ImageDisplay.IS_CAMERA_SUPPORTED()?navigator.mediaDevices.getUserMedia({video:t}).then(t=>ImageDisplay.#ut(t,e,i)).catch(e=>{CDEUtils.isFunction(i)&&i(e.toString().includes("NotReadableError")?ImageDisplay.ERROR_TYPES.DEVICE_IN_USE:ImageDisplay.ERROR_TYPES.NO_PERMISSION,t,e)}):CDEUtils.isFunction(i)&&i(ImageDisplay.ERROR_TYPES.NOT_AVAILABLE,t)}static#ct(t=!0,e,i){ImageDisplay.IS_SCREEN_RECORD_SUPPORTED()?navigator.mediaDevices.getDisplayMedia({video:t}).then(t=>ImageDisplay.#ut(t,e,i)).catch(e=>{CDEUtils.isFunction(i)&&i(ImageDisplay.ERROR_TYPES.NO_PERMISSION,t,e)}):CDEUtils.isFunction(i)&&i(ImageDisplay.ERROR_TYPES.NOT_AVAILABLE,t)}static loadImage(t,e=null,i=!1){const s=new Image;return s.src=t,CDEUtils.isFunction(e)&&(s.onerror=i=>e(ImageDisplay.ERROR_TYPES.FILE_NOT_FOUND,t,i)),i&&s.setAttribute("fakeload","1"),s}static loadVideo(t,e=!0,i=!0){const s=document.createElement("video");return s.src=t instanceof File?URL.createObjectURL(t):t,s.preload="auto",s.loop=e,i&&(s.mute=!0,s.autoplay=i,ImageDisplay.playMedia(s)),s}static loadCamera(t=null,e=null,i=null){return t??=ImageDisplay.DEFAULT_CAMERA_RESOLUTION,{type:ImageDisplay.SOURCE_TYPES.CAMERA,settings:{width:{ideal:t?.[0]},height:{ideal:t?.[1]},facingMode:e??ImageDisplay.DEFAULT_FACING_MODE,frameRate:i??ImageDisplay.DEFAULT_CAMERA_FRAME_RATE}}}static loadCapture(t=null,e=null,i=null,s=null){return t??=ImageDisplay.DEFAULT_CAPTURE_RESOLUTION,{type:ImageDisplay.SOURCE_TYPES.CAPTURE,settings:{mediaSource:s??ImageDisplay.DEFAULT_CAPTURE_MEDIA_SOURCE,frameRate:i??ImageDisplay.DEFAULT_CAPTURE_FRAME_RATE,cursor:e??ImageDisplay.DEFAULT_CAPTURE_CURSOR,width:{ideal:t?.[0]},height:{ideal:t?.[1]}}}}static getErrorFromCode(t){return Object.keys(ImageDisplay.ERROR_TYPES)[t]}playVideo(){ImageDisplay.playMedia(this._source)}pauseVideo(){const t=this._source;t instanceof HTMLVideoElement&&t.pause()}static playMedia(t,e){(t instanceof HTMLVideoElement||t instanceof HTMLAudioElement)&&t.play().catch(()=>Canvas.addOnFirstInteractCallback(()=>t.play().catch(i=>{CDEUtils.isFunction(e)&&e(ImageDisplay.ERROR_TYPES.NOT_AVAILABLE,t,i)})))}static getNaturalSize(t){return[t?.displayWidth||t?.videoWidth||t?.width,t?.displayHeight||t?.videoHeight||t?.height]}duplicate(t=this._source,e=this.pos_,i=this.size_,s=this._setupCB,r=this._loopCB,n=this._anchorPos,a=this._activationMargin){const o=new ImageDisplay(t instanceof MediaStreamAudioSourceNode?t.mediaStream.clone():t.cloneNode(),e,i,s,r,n,a);return o._scale=CDEUtils.unlinkArr2(this._scale),o._rotation=this._rotation,o._visualEffects=this.visualEffects_,this.initialized?o:null}isWithin(t,e,i,s){return super.isWithin(t,this.getBounds(e,i,s),e)}isWithinAccurate(t,e,i,s){const r=this.cvs.viewPos;return this.ctx.isPointInPath(this.getBoundsAccurate(e,i,s),t[0]+r[0],t[1]+r[1])}#st(){const t=this._size,e=this._pos;return[e,[e[0]+t[0],e[1]+t[1]]]}getBoundsAccurate(t,e=this._rotation,i=this._scale){const s=new Path2D,r=this.#st(),n=super.getCorners(r,t,e,i,super.getCenter(r));return s.moveTo(n[0][0],n[0][1]),s.lineTo(n[2][0],n[2][1]),s.lineTo(n[1][0],n[1][1]),s.lineTo(n[3][0],n[3][1]),s.lineTo(n[0][0],n[0][1]),s}getCenter(){return super.getCenter(this.#st())}getBounds(t,e=this._rotation,i=this._scale){const s=this.#st();return super.getBounds(s,t,e,i,super.getCenter(s))}remove(){this._source instanceof HTMLVideoElement&&(this._source.pause(),this._source.remove()),this._parent.remove(this._id)}aspectRatioWidthResize(t){const e=this._size[1]/this._size[0],i=0|("string"==typeof t?+t.replace("%","").trim()/100*this.#ot[0]:null==t?this.#ot[0]:t);this._size[0]=i,this._size[1]=i*e}aspectRatioHeightResize(t){const e=this._size[0]/this._size[1],i=0|("string"==typeof t?+t.replace("%","").trim()/100*this.#ot[1]:null==t?this.#ot[1]:t);this._size[1]=i,this._size[0]=i*e}static isFormatSupported(t){return ImageDisplay.isImageFormatSupported(t)||ImageDisplay.isVideoFormatSupported(t)}static isImageFormatSupported(t){const e=(t?.name||t).toLowerCase();return ImageDisplay.SUPPORTED_IMAGE_FORMATS.some(t=>e.endsWith("."+t))}static isVideoFormatSupported(t){const e=(t?.name||t).toLowerCase();return ImageDisplay.SUPPORTED_VIDEO_FORMATS.some(t=>e.endsWith("."+t))}static getSupportedHTMLAcceptValue(){const t=", .";return"."+ImageDisplay.SUPPORTED_IMAGE_FORMATS.join(t)+t+ImageDisplay.SUPPORTED_VIDEO_FORMATS.join(t)}[Symbol.toPrimitive](){return this.id}get[Symbol.toStringTag](){return this.instanceOf}get instanceOf(){return"ImageDisplay"}get ctx(){return this._parent._ctx}get size(){return this._size||[0,0]}get size_(){return this._size?CDEUtils.unlinkArr2(this._size):[0,0]}get width(){return this._size[0]}get height(){return this._size[1]}get top(){return this._pos[1]}get bottom(){return this._pos[1]+this.height}get left(){return this._pos[0]}get right(){return this._pos[0]+this.width}get trueSize(){const t=this.size;return[Math.abs(t[0]*this._scale[0]),Math.abs(t[1]*this._scale[1])]}get naturalSize(){return this.#ot||ImageDisplay.getNaturalSize(this._source)}get centerX(){return this._pos[0]+this._size[0]/2}get centerY(){return this._pos[1]+this._size[1]/2}get centerPos(){return[this.centerX,this.centerY]}get source(){return this._source}get sourceCroppingPositions(){return this._sourceCroppingPositions}get errorCB(){return this._errorCB}get paused(){return this._source?.paused}get playbackRate(){return this._source?.playbackRate}get speed(){return this.playbackRate}get currentTime(){return this._source?.currentTime}get isLooping(){return this.loop}get isDynamic(){return this._source instanceof ImageDisplay.DYNAMIC_SOURCE_TYPES.CANVAS||this._source instanceof ImageDisplay.DYNAMIC_SOURCE_TYPES.OFFSCREEN_CANVAS||this._source instanceof ImageDisplay.DYNAMIC_SOURCE_TYPES.VIDEO}set source(t){const e=this._size;ImageDisplay.initializeDataSource(t,(t,i)=>{this._source=t,this.#ot=i,this.size=e},this._errorCB)}set errorCB(t){this._errorCB=t}set naturalSize(t){this.#ot=t}set size(t){return this.width=t[0],this.height=t[1],this._size}set width(t){this._size[0]=0|("string"==typeof t?+t.replace("%","").trim()/100*this.#ot[0]:null==t?this.#ot[0]:t)}set height(t){this._size[1]=0|("string"==typeof t?+t.replace("%","").trim()/100*this.#ot[1]:null==t?this.#ot[1]:t)}set paused(t){try{t?this._source.pause():ImageDisplay.playMedia(this._source)}catch(t){}}set playbackRate(t){this._source.playbackRate=t}set speed(t){this.playbackRate=t}set currentTime(t){this._source.currentTime=t}set isLooping(t){this.loop=t}set sourceCroppingPositions(t){if(t){const e=t[0],i=t[1],s=this.#ot;this._sourceCroppingPositions=[["string"==typeof e[0]?+e[0].replace("%","").trim()/100*s[0]:null==e[0]?0:e[0],"string"==typeof e[1]?+e[1].replace("%","").trim()/100*s[1]:null==e[1]?0:e[1]],["string"==typeof i[0]?+i[0].replace("%","").trim()/100*s[0]:null==i[0]?s[0]:i[0],"string"==typeof i[1]?+i[1].replace("%","").trim()/100*s[1]:null==i[1]?s[1]:i[1]]]}else this._sourceCroppingPositions=null}}export class TextDisplay extends _BaseObj{static MEASUREMENT_CTX=new OffscreenCanvas(1,1).getContext("2d");static DEFAULT_LINE_HEIGHT_PADDING=10;#Et=null;constructor(t,e,i,s,r,n,a,o,l,h){super(e,i,a,o,l,h),this._text=t??"",this._textStyles=s,this._drawMethod=r?.toUpperCase()??Render.DRAW_METHODS.FILL,this._maxWidth=n??void 0,this._lineHeight=null,this._size=null}initialize(){this._textStyles=CDEUtils.isFunction(this._textStyles)?this._textStyles(this.render,this):this._textStyles??this.render.defaultTextProfile,this.#dt(),this.initialized=!0,super.initialize()}#dt(t=TextDisplay.DEFAULT_LINE_HEIGHT_PADDING){this._size=this.getSize(),this.#Et=this.getTextValue().split("\n").length,this.#Et-1&&(this._size[1]-=t),this._lineHeight=this.trueSize[1]/this.#Et}draw(t,e,i){if(this.initialized&&(this.a??1)>Color.OPACITY_VISIBILITY_THRESHOLD){const e=t.ctx,i=1!=this._scale[0]||1!=this._scale[1],s=this._rotation||i,r=this.getTextValue();let n,a;if(s){const t=this._pos[0],s=this._pos[1],r=this.parent;n=r.viewPos,a=r.zoom,e.translate(t,s),this._rotation&&e.rotate(CDEUtils.toRad(this._rotation)),i&&e.scale(this._scale[0],this._scale[1]),e.translate(-t,-s)}"FILL"==this._drawMethod?t.fillText(r,this._pos,this._color,this._textStyles,this._maxWidth,this._lineHeight,this.visualEffects):t.strokeText(r,this._pos,this._color,this._textStyles,this._maxWidth,this._lineHeight,this.visualEffects),s&&e.setTransform(a,0,0,a,n[0],n[1])}super.draw(e,i)}getSize(t=this._textStyles,e=this.getTextValue(),i){return TextDisplay.getSize(t,e,i,this._maxWidth)}static getSize(t,e,i=TextDisplay.DEFAULT_LINE_HEIGHT_PADDING,s,r=[1,1]){TextStyles.apply(TextDisplay.MEASUREMENT_CTX,...t.getStyles());const n=e.replace(/./g,1).split("\n"),a=n.length,o=a>1?n.reduce((t,e)=>t.length<e.length?e:t):e,{width:l,actualBoundingBoxAscent:h,actualBoundingBoxDescent:_}=TextDisplay.MEASUREMENT_CTX.measureText(o);return[CDEUtils.round(s||l,4)*r[0],(h+_)*a*r[1]+a*i]}#Tt(t=TextDisplay.DEFAULT_LINE_HEIGHT_PADDING){const e=TextDisplay.MEASUREMENT_CTX,i=this._maxWidth,s=this.getTextValue().split("\n"),r=s.length,n=new Array(r);TextStyles.apply(e,...this._textStyles.getStyles());for(let a=0;a<r;a++){const r=e.measureText("1".repeat(s[a].length)),o=r.width;n[a]=[i&&o>i?i:o,r.actualBoundingBoxAscent+r.actualBoundingBoxDescent+t]}return n}getTextValue(){return(CDEUtils.isFunction(this._text)?this._text(this._parent,this):this._text).trim()}duplicate(t=this._text,e=this.pos_,i=this._color,s=this._textStyles,r=this._drawMethod,n=this._maxWidth,a=this._setupCB,o=this._loopCB,l=this._anchorPos,h=this._activationMargin){const _=i,c=_.colorRaw,u=new TextDisplay(t,e,(t,e)=>c instanceof Gradient||c instanceof Pattern?c.duplicate(Array.isArray(c.initPositions)?null:e):_.duplicate(),s,r,n,a,o,l,h);return u._scale=CDEUtils.unlinkArr2(this._scale),u._rotation=this._rotation,u._visualEffects=this.visualEffects_,this.initialized?u:null}isWithin(t,e,i,s){return super.isWithin(t,this.getBounds(e,i,s),e)}isWithinAccurate(t,e,i,s){const r=this.cvs.viewPos;return this.ctx.isPointInPath(this.getBoundsAccurate(e,i,s),t[0]+r[0],t[1]+r[1])}#st(){const t=this._size,e=this._pos,i=TextDisplay.DEFAULT_LINE_HEIGHT_PADDING/2+this._lineHeight/2;return[[e[0]-t[0]/2,e[1]-i/2-3],[e[0]+t[0]/2,e[1]+t[1]-i]]}getBoundsAccurate(t,e=this._rotation,i=this._scale,s=TextDisplay.DEFAULT_LINE_HEIGHT_PADDING,r=this.render.currentCtxStyles[0]){const n=new Path2D,a=this.#Tt(),o=a.length,l=this._pos[1]-(s/4+this._lineHeight/4)-r,h=this._pos[0]-r/2;if(t)for(let e=0;e<o;e++)a[e][0]+=t;let _=a[0][1]-(o-1?s/o:s/4),c=a[0][0]/2,u=a[o-1][0],E=h+c,d=[[h-c,l],[E,l]];for(let t=1;t<o;t++){const e=l+_*t;d.push([E,e],[E=h+a[t][0]/2,e])}d.push([E,l+_*o-s/2]),d.push([E-u,l+_*o-s/2]),d.push([E-=u,l+_*(o-1)]);for(let t=o-1;t>0;t--)d.push([h-a[t-1][0]/2,l+_*t],[h-a[t-1][0]/2,l+_*(t-1)]);for(let t=0;t<d.length;t++){let s=d[t];1==i[0]&&1==i[1]||(s=CDEUtils.scalePos(s,i,this._pos)),e&&(s=CDEUtils.rotatePos(s,e,this._pos)),t?n.lineTo(s[0],s[1]):n.moveTo(s[0],s[1])}return n}getCenter(){return super.getCenter(this.#st())}getBounds(t,e=this._rotation,i=this._scale){return super.getBounds(this.#st(),t,e,i,this._pos)}static loadCustomFont(t,e=null,i={},s=null,r=e=>console.warn("Error loading font:",t,e)){TextStyles.loadCustomFont(t,e,i,s,r)}[Symbol.toPrimitive](){return this.id}*[Symbol.iterator](){const t=this.getTextValue(),e=t.length;for(let i=0;i<e;i++)yield t[i]}get[Symbol.toStringTag](){return this.instanceOf}get instanceOf(){return"TextDisplay"}get ctx(){return this._parent.ctx}get render(){return this._parent.render}get text(){return this._text+""}get textStyles(){return this._textStyles}get drawMethod(){return this._drawMethod}get maxWidth(){return this._maxWidth}get size(){return this._size}get lineHeight(){return this._lineHeight}get trueSize(){return[Math.abs(this._size[0]*this._scale[0]),Math.abs(this._size[1]*this._scale[1])]}get render(){return this._parent.render}get lineCount(){return this.#Et}get width(){return this.trueSize[0]}get height(){return this.trueSize[1]}get top(){return this._pos[1]-this.lineHeight/2}get bottom(){return this._pos[1]+this.lineHeight*this.lineCount-this.lineHeight/2}get left(){return this._pos[0]-this._size[0]/2}get right(){return this._pos[0]+this._size[0]/2}set text(t){const e=this._scale[1];this._text=""+t||"",this._scale[1]=1,this.#dt(),this._scale[1]=e}set textStyles(t){this._textStyles=t??this.render.defaultTextProfile,this.#dt()}set drawMethod(t){this._drawMethod=t.toUpperCase()}set maxWidth(t){this._maxWidth=t??void 0,this.#dt()}set lineHeight(t){this._lineHeight=t}}export class _DynamicColor{static PLACEHOLDER="PLACEHOLDER";static PLACEHOLDER_COLOR="transparent";constructor(t,e){this._initPositions=t,this._positions=t,this._rotation=e??0,this._lastChangeValue=null,this._value=null}get[Symbol.toStringTag](){return this.instanceOf}get instanceOf(){return"_DynamicColor"}get initPositions(){return this._initPositions}get positions(){return this._positions}get rotation(){return this._rotation}get isDynamic(){return null!=this._initPositions?.pos}get value(){return this.isDynamic&&this.update(),this._value}set initPositions(t){this._initPositions=t}set positions(t){this._positions=t,this.isDynamic||this.update(!0)}set rotation(t){this._rotation=CDEUtils.round(t,2)%360,this.isDynamic||this.update(!0)}}export class Pattern extends _DynamicColor{static#St=0;static#At=new OffscreenCanvas(1,1).getContext("2d");static#pt=new DOMMatrixReadOnly;static LOADED_PATTERN_SOURCES=[];static PLACEHOLDER_COLOR="transparent";static REPETITION_MODES={REPEAT:"repeat",REPEAT_X:"repeat-x",REPEAT_Y:"repeat-y",NO_REPEAT:"no-repeat"};static DEFAULT_REPETITION_MODE=Pattern.REPETITION_MODES.NO_REPEAT;static DEFAULT_FRAME_RATE=1/30;static SERIALIZATION_SEPARATOR="!";static FORCE_UPDATE_LEVELS={DISABLED:null,RESPECT_FRAME_RATE:!0,OVERRIDE:2};static DEFAULT_FORCE_UPDATE_LEVEL=Pattern.FORCE_UPDATE_LEVELS.DISABLED;#gt=null;#Rt=!1;constructor(t,e,i,s,r,n,a,o,l,h,_){super(i,a),this._id=Pattern.#St++,this._render=t,this._source=e,this._sourceCroppingPositions=s,this._keepAspectRatio=r??!1,this._forcedUpdates=n??Pattern.DEFAULT_FORCE_UPDATE_LEVEL;const c=h??Pattern.DEFAULT_FRAME_RATE;this._frameRate=c%1?c:1/Math.max(c,0),this._errorCB=o||ImageDisplay.DEFAULT_MEDIA_ERROR_CALLBACK,this._readyCB=l,this._repeatMode=_??Pattern.DEFAULT_REPETITION_MODE,Pattern.LOADED_PATTERN_SOURCES[this._id]=this,ImageDisplay.initializeDataSource(e,t=>{this._source=t,this.sourceCroppingPositions=this._sourceCroppingPositions||null,this.#Rt=!0,CDEUtils.isFunction(this._readyCB)&&this._readyCB(this),this.update(Pattern.FORCE_UPDATE_LEVELS.OVERRIDE)},this._errorCB)}getAutomaticPositions(t=this._initPositions){return t instanceof Shape?this.#Ct(t)?t.getBounds(0,0,0):this._positions:t instanceof Dot?this.#Dt(t)?t.getBounds(0,0,0):this._positions:t instanceof TextDisplay?this.#It(t)?t.getBounds(0,0,0):this._positions:t instanceof AudioDisplay?t.getBounds(0,0,0):this._positions}#Ct(t){const e=t.dotsPositions+t.radius;return e!==this._lastChangeValue&&(this._lastChangeValue=e,!0)}#Dt(t){const e=t.stringPos+t.radius;return e!==this._lastChangeValue&&(this._lastChangeValue=e,!0)}#It(t){const e=t.trueSize+t.pos;return e!==this._lastChangeValue&&(this._lastChangeValue=e,!0)}update(t=this._forcedUpdates){if(this.#Rt){const e=this._source,i=this._render.ctx,s=e instanceof HTMLCanvasElement,r=Pattern.FORCE_UPDATE_LEVELS,n=s||t==r.RESPECT_FRAME_RATE?performance.now()/1e3:e.currentTime;if(null!=n&&t!=r.OVERRIDE){if(this.#gt>n&&(this.#gt=n),!(n-this.#gt>=this._frameRate))return;this.#gt=n}const a=this.getAutomaticPositions();if(t!=r.OVERRIDE&&(!e.currentTime||e.paused)&&Array.isArray(this._positions)&&CDEUtils.positionsEquals(a,this._positions)&&this._value)return;this._positions=a,s?this._render._bactchedStandalones.push(()=>this._value=this.#mt(i,e)):this._value=this.#mt(i,e)}}#mt(t,e){let i,s;const r=Pattern.#pt,n=this._sourceCroppingPositions;if(n){const t=Pattern.#At,r=t.canvas,a=n[0][0],o=n[0][1];i=r.width=Math.abs(n[1][0]-a),s=r.height=Math.abs(n[1][1]-o),t.clearRect(0,0,i,s),t.drawImage(e,a,o,i,s,0,0,i,s),e=r}else[i,s]=ImageDisplay.getNaturalSize(e);const a=t.createPattern(e,this._repeatMode),o=this._positions;if(o){const t=o[0],e=o[1],n=e[0]-t[0],l=e[1]-t[1],h=n/i,_=l/s,c=this._rotation;if(this._keepAspectRatio){const e=h>_,o=e?h:_,u=i*o/2,E=s*o/2;c?a.setTransform(r.translate(t[0]-(e?0:u-n/2)+u,t[1]-(e?E-l/2:0)+E).rotate(c).translate(-u,-E).scale(o,o)):a.setTransform(r.translate(t[0]-(e?0:u-n/2),t[1]-(e?E-l/2:0)).scale(o,o))}else{const e=i*h/2,n=s*_/2;c?a.setTransform(r.translate(t[0]+e,t[1]+n).rotate(c).translate(-e,-n).scale(h,_)):a.setTransform(r.translate(t[0],t[1]).scale(h,_))}}return a}toString(){return this._id+Pattern.SERIALIZATION_SEPARATOR}playVideo(){ImageDisplay.playMedia(this._source)}pauseVideo(){try{this._source.pause()}catch(t){}}duplicate(t=this._positions,e=this._render,i=this._source,s=this._sourceCroppingPositions,r=this._keepAspectRatio,n=this._forcedUpdates,a=this._rotation,o=this._errorCB,l=this._frameRate,h=this._repeatMode){return!(i instanceof HTMLElement)||i.getAttribute("permaLoad")||i instanceof HTMLCanvasElement||(i=i.cloneNode()).setAttribute("fakeload","1"),new Pattern(e,i,CDEUtils.unlinkPositions(t),CDEUtils.unlinkPositions(s),r,n,a,o,null,l,h)}static loadImage(t,e=null,i=!1){return ImageDisplay.loadImage(t,e,i)}static loadVideo(t,e=!0,i=!0){return ImageDisplay.loadVideo(t,e,i)}static loadCamera(t=null,e=null,i=this._frameRate){return ImageDisplay.loadCamera(t,e,i)}static loadCapture(t=null,e=null,i=this.frameRate,s=null){return ImageDisplay.loadCapture(t,e,i,s)}[Symbol.toPrimitive](){return this.value}get[Symbol.toStringTag](){return this.instanceOf}get instanceOf(){return"Pattern"}get id(){return this._id}get render(){return this._render}get source(){return this._source}get sourceCroppingPositions(){return this._sourceCroppingPositions}get keepAspectRatio(){return this._keepAspectRatio}get forcedUpdates(){return this._forcedUpdates}get repeatMode(){return this._repeatMode}get frameRate(){return 1/this._frameRate}get value(){const t=this._source;return t instanceof HTMLVideoElement&&!t.src&&!t.srcObject?.active?Pattern.PLACEHOLDER_COLOR:((this._forcedUpdates||t instanceof HTMLVideoElement||t instanceof HTMLCanvasElement)&&this.update(),this._value??Pattern.PLACEHOLDER_COLOR)}get naturalSize(){return ImageDisplay.getNaturalSize(this._source)}get video(){return this._source}get image(){return this._source}get paused(){return this._source?.paused}get isPaused(){return this.paused}get playbackRate(){return this._source?.playbackRate}get speed(){return this.playbackRate}get currentTime(){return this._source?.currentTime}get loop(){return this._source?.loop}get isLooping(){return this.loop}set paused(t){try{t?this._source.pause():ImageDisplay.playMedia(this._source)}catch(t){}}set isPaused(t){this.paused=t}set playbackRate(t){this._source.playbackRate=t}set speed(t){this.playbackRate=t}set currentTime(t){this._source.currentTime=t}set loop(t){this._source.loop=t}set isLooping(t){this.loop=t}set source(t){ImageDisplay.initializeDataSource(t,t=>{this._source=t,this.update(2)})}set sourceCroppingPositions(t){if(t){const e=t[0],i=t[1],s=this.naturalSize;this._sourceCroppingPositions=[["string"==typeof e[0]?+e[0].replace("%","").trim()/100*s[0]:null==e[0]?0:e[0],"string"==typeof e[1]?+e[1].replace("%","").trim()/100*s[1]:null==e[1]?0:e[1]],["string"==typeof i[0]?+i[0].replace("%","").trim()/100*s[0]:null==i[0]?s[0]:i[0],"string"==typeof i[1]?+i[1].replace("%","").trim()/100*s[1]:null==i[1]?s[1]:i[1]]],this.update(2)}else this._sourceCroppingPositions=null}set keepAspectRatio(t){this._keepAspectRatio=t,this.update(2)}set forcedUpdates(t){this._forcedUpdates=t,this.update(2)}set repeatMode(t){this._repeatMode=t,this.update(2)}set frameRate(t){this._frameRate=1/Math.max(t,0)}set rotation(t){this._rotation=CDEUtils.round(t,2)%360,this.update(2)}}export class _Obj extends _BaseObj{static DEFAULT_RADIUS=5;static RADIUS_PRECISION=4;constructor(t,e,i,s,r,n,a){super(t,i,s,r,n,a),this._initRadius=e,this._radius=this._initRadius}initialize(){this._radius=this.getInitRadius()??_Obj.DEFAULT_RADIUS,super.initialize()}getInitRadius(){return CDEUtils.isFunction(this._initRadius)?this._initRadius(this._parent instanceof Canvas?this:this._parent,this):this._initRadius??null}isWithin(t,e){return super.isWithin(t,e)}getCenter(t){return super.getCenter(t)}getBounds(t,e,i,s,r){return super.getBounds(t,e,i,s,r)}get[Symbol.toStringTag](){return this.instanceOf}get instanceOf(){return"_Obj"}get radius(){return this._radius}get initRadius(){return this._initRadius}set radius(t){this._radius=CDEUtils.round(t<0?0:t,_Obj.RADIUS_PRECISION)}set initRadius(t){this._initRadius=t}}export class Shape extends _Obj{static DEFAULT_LIMIT=100;static DEFAULT_RATIO_POS=[Infinity,Infinity];constructor(t,e,i,s,r,n,a,o,l,h,_,c){super(t,i??_Obj.DEFAULT_RADIUS,s||Color.DEFAULT_COLOR,o,l,h,_),this._limit=r||Shape.DEFAULT_LIMIT,this._initDots=e,this._dots=[],this._ratioPos=[...Shape.DEFAULT_RATIO_POS],this._drawEffectCB=n,this._ratioPosCB=a,this._fragile=c||!1}initialize(){this._pos=this.getInitPos(),this.setAnchoredPos(),Array.isArray(this._initDots)||this._initDots instanceof Dot?this.add(this._initDots):CDEUtils.isFunction(this._initDots)?this.add(this._initDots(this,this._parent)):"string"==typeof this._initDots&&this.add(this.createFromString(this._initDots)),this.setRadius(this.getInitRadius(),!0),this.setColor(this.getInitColor(),!0),this._visualEffects&&this.setVisualEffects(this._visualEffects,!0),this.initialized=!0,CDEUtils.isFunction(this._setupCB)&&(this._setupResults=this._setupCB(this,this?.parent))}draw(t,e,i){super.draw(e,i),CDEUtils.isFunction(this._ratioPosCB)&&(this._ratioPos=this._ratioPosCB(this))}add(t){this._dots.push(...[t].flat().filter(t=>t).map(t=>(null==t.initColor&&(t.initColor=this.colorRaw),null==t.initRadius&&(t.initRadius=this._radius),t.activationMargin==Canvas.DEFAULT_CANVAS_ACTIVE_AREA_PADDING&&(t.activationMargin=this._activationMargin),null==t.visualEffect&&(t.visualEffect=this.visualEffects_),t._parent=this,t.initialize(),t))),this._parent.updateCachedAllEls()}remove(t=null){t?this._dots=this._dots.filter(e=>e.id!=(t?.id??t)):this._parent.remove(this._id),this._parent.updateCachedAllEls()}static generate(t,e,i,s,r,n){t??=()=>0,e??=[0,0],i??=100,s??=1,r??=[-50,50];let a=[],o=null,l=CDEUtils.isFunction(n);for(let h=0;h<=i;h+=CDEUtils.getValueFromRange(s)){const i=new Dot([e[0]+h,e[1]+CDEUtils.getValueFromRange(r)+t(h)]);(o||i)&&l&&n(i,o),a.push(i),o=i}return a}createFromString(t,e=[0,0],i=[25,25],s="o"){const r=[];return t.split("\n").filter(t=>t).forEach((t,n)=>{let[a,o]=e;o+=n*i[1],[...t].forEach(t=>{t==s&&r.push(new Dot([a+i[0]/2,o+i[1]/2])),a+=i[0]})}),r}setRadius(t=this._radius,e){this._radius=t;const i=this._dots.length;for(let s=0;s<i;s++){const i=this._dots[s];e&&null==i.initRadius?(i.radius=t,i.initRadius=t):e||(i.radius=t,i.initRadius||(i.initRadius=t))}}setColor(t=this._color,e){this.color=t;const i=this._dots.length;for(let s=0;s<i;s++){const i=this._dots[s];e&&!i.initColor?(i.color=t,i.initColor=t):e||(i.color=t,i.initColor||(i.initColor=t))}}setVisualEffects(t=this._visualEffects,e){this._visualEffects=t;const i=this._dots.length;for(let s=0;s<i;s++){const i=this._dots[s];e&&!i.visualEffect?i.visualEffects=t:e||(i.visualEffects=t)}}setActivationMargin(t=this._activationMargin,e){this._activationMargin=t;const i=this._dots.length;for(let s=0;s<i;s++){const i=this._dots[s];e&&i.activationMargin===_BaseObj.DEFAULT_ACTIVATION_MARGIN?i.activationMargin=t:e||(i.activationMargin=t)}}addForce(t,e,i=1e3,s=Anim.easeInOutQuad,r=!0,n=!0){const a=CDEUtils.toRad(e),o=this.x,l=this.y,h=CDEUtils.getAcceptableDiff(t*Math.cos(a),CDEUtils.DEFAULT_ACCEPTABLE_DIFFERENCE),_=CDEUtils.getAcceptableDiff(t*Math.sin(a),CDEUtils.DEFAULT_ACCEPTABLE_DIFFERENCE);return this.playAnim(new Anim(t=>{this.moveAt([o+h*t,l-_*t])},i,s),r,n)}rotateBy(t,e=this.getCenter()){const[i,s]=e;this._dots.forEach(e=>{const r=e.x-i,n=e.y-s,a=Math.cos(CDEUtils.toRad(t)),o=Math.sin(CDEUtils.toRad(t));e.x=r*a-n*o+i,e.y=r*o+n*a+s}),this._rotation=(this._rotation+t)%360}rotateAt(t,e=this.getCenter()){this.rotateBy(360-(this._rotation-t),e)}rotateTo(t,e=1e3,i=Anim.easeInOutQuad,s=this.getCenter(),r=!0,n=!0){const a=this._rotation,o=t-this._rotation;return this.playAnim(new Anim(t=>{this.rotateAt(a+o*t,s)},e,i),r,n)}scaleBy(t,e=this.getCenter()){const[i,s]=t,[r,n]=e,a=this._dots,o=a.length;for(let t=0;t<o;t++){const e=a[t];e.x=(e.x-r)*i+r,e.y=(e.y-n)*s+n}this._scale=[this._scale[0]*i,this._scale[1]*s]}scaleAt(t,e=this.getCenter()){const i=t[0]/this._scale[0],s=t[1]/this._scale[1];this.scaleBy([i||1,s||1],e)}scaleTo(t,e=1e3,i=Anim.easeInOutQuad,s=this.getCenter(),r=!0,n=!0){const a=this._scale,o=t[0]-this._scale[0],l=t[1]-this._scale[1];return this.playAnim(new Anim(t=>{this.scaleAt([a[0]+o*t,a[1]+l*t],s)},e,i),r,n)}isWithin(t,e){return super.isWithin(t,this.getBounds(e),e)}isWithinAccurate(t){if(this._dots.length>2){const e=this.cvs.viewPos;return this.ctx.isPointInPath(this.getBoundsAccurate(),t[0]+e[0],t[1]+e[1])}return!1}#st(){const t=CDEUtils.getMinMax(this._dots,"x"),e=CDEUtils.getMinMax(this._dots,"y");return[[t[0],e[0]],[t[1],e[1]]]}getBoundsAccurate(){const t=this._dots,e=t.length,i=new Path2D,s=t[0].pos;i.moveTo(s[0],s[1]);for(let s=1;s<e;s++){const e=t[s].pos;i.lineTo(e[0],e[1])}return i.closePath(),i}getCenter(){return super.getCenter(this.#st())}getBounds(t=this._radius,e,i,s){const r=this.#st();return super.getBounds(r,t,e,i,s)}clear(){this._dots=[],this._parent.updateCachedAllEls()}reset(){this._initDots&&(this.clear(),this.initialize())}enableDotsPathCaching(){const t=this._dots,e=t.length;for(let i=0;i<e;i++)t[i].updateCachedPath()}disableDotsPathCaching(){const t=this._dots,e=t.length;for(let i=0;i<e;i++)t[i].disablePathCaching()}disable(){const t=this._dots,e=t.length;for(let i=0;i<e;i++)t[i].disable()}enable(){const t=this._dots,e=t.length;for(let i=0;i<e;i++)t[i].enable()}duplicate(t=this.pos_,e=this._dots.map(t=>t.duplicate()),i=this._radius,s=this._color,r=this._limit,n=this._drawEffectCB,a=this._ratioPosCB,o=this._setupCB,l=this._loopCB,h=this._anchorPos,_=this._activationMargin,c=this._fragile){const u=s,E=u.colorRaw,d=new Shape(t,e,i,(t,e)=>E instanceof Gradient||E instanceof Pattern?E.duplicate(Array.isArray(E.initPositions)?null:e):u.duplicate(),r,n,a,o,l,h,_,c);return d._scale=CDEUtils.unlinkArr2(this._scale),d._rotation=this._rotation,d._visualEffects=this.visualEffects_,this.initialized?d:null}[Symbol.toPrimitive](){return this.id}*[Symbol.iterator](){const t=this._dots,e=t.length;for(let i=0;i<e;i++)yield t[i]}get[Symbol.toStringTag](){return this.instanceOf}get instanceOf(){return"Shape"}get cvs(){return this._parent}get ctx(){return this.cvs.ctx}get render(){return this.cvs.render}get dots(){return this._dots}get limit(){return this._limit}get initDots(){return this._initDots}get drawEffectCB(){return this._drawEffectCB}get ratioPos(){return this._ratioPos}get ratioPosCB(){return this._ratioPosCB}get lastDotsPos(){return this._lastDotsPos}get dotsPositions(){let t="",e=this.dots.length;for(let i=0;i<e;i++)t+=this.dots[i].stringPos;return t}get firstDot(){return this._dots[0]}get secondDot(){return this._dots[1]}get thirdDot(){return this._dots[2]}get lastDot(){return CDEUtils.getLast(this._dots,0)}get asSource(){return this._dots}get top(){return CDEUtils.getMinMax(this._dots,"y")[0]}get bottom(){return CDEUtils.getMinMax(this._dots,"y")[1]}get height(){const t=CDEUtils.getMinMax(this._dots,"y");return t[1]-t[0]}get left(){return CDEUtils.getMinMax(this._dots,"x")[0]}get right(){return CDEUtils.getMinMax(this._dots,"x")[1]}get width(){const t=CDEUtils.getMinMax(this._dots,"x");return t[1]-t[0]}set dots(t){this._ratioPos=t}set ratioPos(t){this._ratioPos=t}set drawEffectCB(t){this._drawEffectCB=t}set ratioPosCB(t){this._ratioPosCB=t}set lastDotsPos(t){this._lastDotsPos=t}set limit(t){this._limit=t}}export class Gradient extends _DynamicColor{static TYPES={LINEAR:"Linear",RADIAL:"Radial",CONIC:"Conic"};static DEFAULT_TYPE=Gradient.TYPES.LINEAR;static SERIALIZATION_SEPARATOR="*";static SERIALIZATION_COLOR_STOPS_SEPARATOR="$";#Ot=null;#Pt=null;constructor(t,e,i,s,r){super(e,r),this._ctx=t.ctx??t,this._type=s||Gradient.DEFAULT_TYPE,this._colorStops=i.map(([t,e])=>[t,Color.uniquify(e)]),this.update()}getAutomaticPositions(t=this._initPositions){if(t instanceof Shape){if(this.#ft()||this.#Ct(t)){const e=CDEUtils.getMinMax(t.dots,"x"),i=CDEUtils.getMinMax(t.dots,"y"),s=e[0],r=i[0],n=e[1],a=i[1],o=s+(n-s)/2,l=r+(a-r)/2;return this._type==Gradient.TYPES.LINEAR?this.#Lt(s-o,r-l,n-o,a-l,o,l):this._type==Gradient.TYPES.RADIAL?this.#yt(o,l,Math.max(n-s,a-r)):t.getCenter()}return this._positions}if(t instanceof Dot){if(this.#ft()||this.#Dt(t)){const e=t.pos[0],i=t.pos[1];return this._type==Gradient.TYPES.LINEAR?this.#Lt(t.left-e,t.top-i,t.right-e,t.bottom-i,e,i):this._type==Gradient.TYPES.RADIAL?this.#yt(e,i,t.radius):t.pos_}return this._positions}if(t instanceof TextDisplay){if(this.#ft()||this.#It(t)){const[e,i]=t.trueSize,[s,r]=t.pos,n=s-e/2,a=s+e/2,o=r-i/2,l=r+i/2;return this._type==Gradient.TYPES.LINEAR?this.#Lt(n-s,o-r,a-s,l-r,s,r):this._type==Gradient.TYPES.RADIAL?this.#yt(s,r,Math.max(a-n,l-o)):t.pos_}return this._positions}if(t instanceof AudioDisplay)return t.getBounds();if(this._type==Gradient.TYPES.LINEAR){const[[e,i],[s,r]]=t,n=e+(s-e)/2,a=i+(r-i)/2;return this.#Lt(e-n,i-a,s-n,r-a,n,a)}return this._positions}#Lt(t,e,i,s,r,n){const a=Math.cos(CDEUtils.toRad(this._rotation)),o=Math.sin(CDEUtils.toRad(this._rotation)),l=CDEUtils.round;return[[l(t*a-e*o+r),l(t*o+e*a+n)],[l(i*a-s*o+r),l(i*o+s*a+n)]]}#yt(t,e,i){return[[t,e,i],[t,e,.25*i]]}#ft(){return(this.#Ot!==this._rotation||this.#Pt!==this._type)&&(this.#Ot=this._rotation,this.#Pt=this._type,!0)}#Ct(t){const e=t.dotsPositions;return e!==this._lastChangeValue&&(this._lastChangeValue=e,!0)}#Dt(t){const e=t.stringPos;return e!==this._lastChangeValue&&(this._lastChangeValue=e,!0)}#It(t){const e=t.trueSize+t.pos;return e!==this._lastChangeValue&&(this._lastChangeValue=e,!0)}update(t){if(this._initPositions!=_DynamicColor.PLACEHOLDER){const e=this.getAutomaticPositions();if(!t&&Array.isArray(this._positions)&&CDEUtils.positionsEquals(e,this._positions))return;return this._value=Gradient.getCanvasGradient(this._ctx,this._positions=e,this._colorStops,this._type,this._rotation)}}duplicate(t=this._positions,e=this._ctx,i=this._colorStops,s=this._type,r=this._rotation){return new Gradient(e,CDEUtils.unlinkPositions(t),[...i],s,r)}toString(){const t=Gradient.SERIALIZATION_SEPARATOR;return this._positions+t+this._colorStops.flat().join(Gradient.SERIALIZATION_COLOR_STOPS_SEPARATOR)+t+this._type+t+this._rotation}static getCanvasGradient(t,e,i,s,r){const n=s==Gradient.TYPES.CONIC?t.createConicGradient(CDEUtils.toRad(r),e[0],e[1]):t[`create${s}Gradient`](...e[0],...e[1]),a=i.length;for(let t=0;t<a;t++)n.addColorStop(i[t][0],Color.getColorValue(i[t][1]));return n}static getCanvasGradientFromString(t,e){let[i,s,r,n]=e.split(Gradient.SERIALIZATION_SEPARATOR),a=i.split(","),o=s.split(Gradient.SERIALIZATION_COLOR_STOPS_SEPARATOR),l=o.length;i=2==a.length?[+a[0],+a[1]]:[[+a[0],+a[1]],[+a[2],+a[3]]],s=[];for(let t=0;t<l;t+=2)s.push([+o[t],o[t+1]]);return Gradient.getCanvasGradient(t,i,s,r,+n)}[Symbol.toPrimitive](){return this.toString()}*[Symbol.iterator](){const t=this._colorStops,e=t.length;for(let i=0;i<e;i++)yield t[i]}get[Symbol.toStringTag](){return this.instanceOf}get instanceOf(){return"Gradient"}get ctx(){return this._ctx}get type(){return this._type}get colorStops(){return this._colorStops}set colorStops(t){this._colorStops=t.map(([t,e])=>[t,Color.uniquify(e)]),this.isDynamic||this.update()}set type(t){this._type=t,this.isDynamic||this.update()}}export class FilledShape extends Shape{#Nt=null;constructor(t,e=!1,i,s,r,n,a,o,l,h,_,c,u,E){super(i,s,r,n,a,o,l,h,_,c,u,E),this._initFillColor=t,this._fillColor=this._initFillColor,this._dynamicUpdates=e,this._path=null}initialize(){super.initialize(),CDEUtils.isFunction(this._initFillColor)&&this._dots.length?this.fillColor=this._initFillColor(this.render,this):this.fillColor=this._initFillColor,this.updatePath()}draw(t,e,i){super.draw(t,e,i),this.dots.length>2&&(this._dynamicUpdates&&this.updatePath(),t.fill(this._path,this._fillColor,this.visualEffects))}updatePath(){const t=this.dots.length;if(t){const e=this.dotsPositions;if(e!==this.#Nt){this.#Nt=e,this._path=new Path2D;const i=this.dots[0].pos;this._path.moveTo(i[0],i[1]);for(let e=1;e<t;e++){const t=this.dots[e].pos;this._path.lineTo(t[0],t[1])}this._path.closePath()}}}duplicate(t=this._fillColor,e=this._dynamicUpdates,i=this.pos_,s=this._dots.map(t=>t.duplicate()),r=this._radius,n=this._color,a=this._limit,o=this._drawEffectCB,l=this._ratioPosCB,h=this._setupCB,_=this._loopCB,c=this._anchorPos,u=this._activationMargin,E=this._fragile){const d=t,T=d.colorRaw,S=n,A=S.colorRaw,p=new FilledShape((t,e)=>T instanceof Gradient||T instanceof Pattern?T.duplicate(Array.isArray(T.initPositions)?null:e):d.duplicate(),e,i,s,r,(t,e)=>A instanceof Gradient||A instanceof Pattern?A.duplicate(Array.isArray(A.initPositions)?null:e):S.duplicate(),a,o,l,h,_,c,u,E);return p._scale=CDEUtils.unlinkArr2(this._scale),p._rotation=this._rotation,p._visualEffects=this.visualEffects_,this.initialized?p:null}[Symbol.toPrimitive](){return this.id}get[Symbol.toStringTag](){return this.instanceOf}get instanceOf(){return"FilledShape"}get fillColorObject(){return this._fillColor}get fillColorRaw(){return this._fillColor.colorRaw}get fillColor(){return this._fillColor.color}get initFillColor(){return this._initFillColor}get path(){return this._path}get dynamicUpdates(){return this._dynamicUpdates}set fillColor(t){const e=this._fillColor;if(!e||e?.colorRaw?.toString()!==t?.toString()){const i=t?.colorRaw||t;i?.positions==_DynamicColor.PLACEHOLDER&&((t=t.isChannel?i:i.duplicate()).initPositions=this),e instanceof Color?e.color=t:this._fillColor=Color.uniquify(t)}}set dynamicUpdates(t){return this._dynamicUpdates=t}}export class Grid extends Shape{static DEFAULT_KEYS="";static DEFAULT_GAPS=[10,10];static DEFAULT_SOURCE=GridAssets.DEFAULT_SOURCE;static DEFAULT_SPACING=t=>t._source.width*t._gaps[0]+t._gaps[0]-t._source.width+t._radius;static DELETION_VALUE=null;static SAME_VALUE=void 0;#bt=[];constructor(t,e,i,s,r,n,a,o,l,h,_,c,u,E,d){super(r,null,n,a,o,l,h,_,c,u,E,d),this._keys=t+""||Grid.DEFAULT_KEYS,this._gaps=e??Grid.DEFAULT_GAPS,this._source=s??Grid.DEFAULT_SOURCE,this._spacing=i??Grid.DEFAULT_SPACING(this)}initialize(){if(this._pos=this.getInitPos(),this.setAnchoredPos(),this._keys){const t=this.createGrid();this.add(t.flat()),this.#Ut(t)}this.setRadius(this.getInitRadius(),!0),this.setColor(this.getInitColor(),!0),this.initialized=!0,CDEUtils.isFunction(this._setupCB)&&(this._setupResults=this._setupCB(this,this?.parent))}createGrid(t=this._keys,e=[0,0],i=this._gaps,s=this._spacing,r=this._source){let[n,a]=e,o=!0,l=[],h=t.length;for(let _=0;_<h;_++){const h=t[_],c=this.createSymbol(h,[n="\n"==h?e[0]:n+s*!o,a+="\n"==h&&r.width*i[1]+this.radius]);o="\n"==h,l.push(c)}return l}createSymbol(t,e=super.relativePos,i=this._source){let s=[],r=[0,0],n=0,a=i[t],o=Math.sqrt(i.width*i.height),l=GridAssets.D.places;return t===Grid.DELETION_VALUE||t===Grid.SAME_VALUE?t:(a&&a.map((t,i)=>[new Dot([e[0]+(r[0]=t[0]??r[0]+1,(isNaN(Math.abs(t[0]))?r[0]:Math.abs(t[0]))*this._gaps[0]),e[1]+(n+=r[0]<=r[1]||!i||-1==Math.sign(1/r[0]))*this._gaps[1]]),t[1],n*o+(r[1]=Math.abs(r[0]))]).forEach(([t,e,i],r,n)=>{isFinite(i)&&(l.forEach(s=>e&s[0]&&t.addConnection(n.find(t=>t[2]==i+s[1](o))?.[0])),s.push(t))}),s)}#Ut(t){const e=t.length;for(let i=0;i<e;i++){const e=t[i];if(e!=Grid.SAME_VALUE){const t=e.length,s=new Array(t);for(let i=0;i<t;i++)s[i]=e[i].id;this.#bt[i]=s}else e===Grid.DELETION_VALUE&&delete this.#bt[i]}}deleteKey(t){if("number"==typeof t&&(t=this.getKey(t)),t){const e=t.length;for(let i=0;i<e;i++)t[i].remove()}}getKey(t){const e=this.#bt[t]??[],i=e.length,s=new Array(i),r=this.parent;for(let t=0;t<i;t++)s[t]=r.get(e[t]);return s}duplicate(t=this._keys,e=CDEUtils.unlinkArr2(this._gaps),i=this._spacing,s=this._source,r=this.pos_,n=this._radius,a=this._color,o=this._limit,l=this._drawEffectCB,h=this._ratioPosCB,_=this._setupCB,c=this._loopCB,u=this._anchorPos,E=this._activationMargin,d=this._fragile){const T=a,S=T.colorRaw,A=new Grid(t,e,i,s,r,n,(t,e)=>S instanceof Gradient||S instanceof Pattern?S.duplicate(Array.isArray(S.initPositions)?null:e):T.duplicate(),o,l,h,_,c,u,E,d);return A._dots=this._dots.map(t=>t.duplicate()),A._scale=CDEUtils.unlinkArr2(this._scale),A._rotation=this._rotation,A._visualEffects=this.visualEffects_,this.initialized?A:null}[Symbol.toPrimitive](){return this.id}get[Symbol.toStringTag](){return this.instanceOf}get instanceOf(){return"Grid"}get keys(){return this._keys}get gaps(){return this._gaps}get spacing(){return this._spacing}get source(){return this._source}set keys(t){const e=t.length>this._keys.length?t.length:this._keys.length,i=new Array(e);for(let s=0;s<e;s++){const e=t[s],r=this._keys[s];r!=e||"\n"==r?(i[s]=e||Grid.DELETION_VALUE,this.deleteKey(s)):i[s]=Grid.SAME_VALUE}this._keys=t;const s=this.createGrid(i);this.#Ut(s),super.add(s.flat())}set gaps(t){super.clear(),this._gaps=t,super.add(this.createGrid().flat())}set spacing(t){t??=this._source.width*this._gaps[0]+this._gaps[0]-this._source.width+this._radius;const e=this._spacing,i=this._keys,s=i.length,r=this.parent;if(e!=t){for(let n=0,a=0;n<s;n++,a="\n"==i[n]?-1:a+1){const i=this.#bt[n],s=i.length;for(let n=0;n<s;n++)r.get(i[n]).moveBy([(t-e)*a])}this._spacing=t}}set source(t){super.clear(),this._source=t??Grid.DEFAULT_SOURCE,super.add(this.createGrid())}}export class Dot extends _Obj{constructor(t,e,i,s,r,n,a=!1){super(t,e,i,s,null,r,n),this._connections=[],this._cachedPath=!a}draw(t,e,i){if(this.initialized){const e=this.drawEffectCB;if(e){const i=this.getDistance(),s=this.getRatio(i),r=s<1,n=this._parent;e(t,this,r?s:1,n.setupResults,n.parent.mouse,i,n,r,s)}if(this._radius&&(this.a??1)>Color.OPACITY_VISIBILITY_THRESHOLD){const e=t.ctx,i=this._scale[0],s=this._scale[1],r=1!==i||1!==s;if(r||this._visualEffects?.[0]?.indexOf("#")+1||this._rotation){let n,a;if(r){const t=this._pos[0],r=this._pos[1],o=this.cvs;n=o.viewPos,a=o.zoom,e.translate(t,r),this._rotation&&e.rotate(CDEUtils.toRad(this._rotation)),e.scale(i,s),e.translate(-t,-r)}t.fill(this._cachedPath||Render.getArc(this._pos,this._radius),this._color,this.visualEffects),r&&e.setTransform(a,0,0,a,n[0],n[1])}else t.batchFill(this._cachedPath||Render.getArc(this._pos,this._radius),this._color,this.visualEffects)}}else this.initialized=!0,this._cachedPath&&this.updateCachedPath();super.draw(e,i)}getDistance(t=this.ratioPos){const e=this._pos;return CDEUtils.getDist(t[0],t[1],e[0],e[1])}getRatio(t){return t/this.limit}addConnection(t){t instanceof Dot&&this._connections.push(t)}removeConnection(t){this._connections=this._connections.filter(e=>"number"==typeof t?e.id!==t:e.id!==t.id)}remove(){this._parent.remove(this._id)}getLinearIntersectPoints(t=this._connections[0],e=t.radius??5,i=this,s=this.radius??5){const r=t.pos??t,n=r[0],a=r[1],o=i.pos??i,l=o[0],h=o[1],_=CDEUtils.getLinearFn_coords(l,h,n,a),c=_[0],u=_[1],E=_[2],d=e**2,T=s**2,S=2*(1+c**2),A=-(2*c*(u-h)-2*l),p=Math.sqrt(A**2-S/2*4*((u-h)**2+l**2-T)),g=-(2*c*(u-a)-2*n),R=Math.sqrt(g**2-S/2*4*((u-a)**2+n**2-d)),C=(A+p)/S,D=(A-p)/S,I=(g+R)/S,m=(g-R)/S,O=E(C),P=E(D),f=E(I),L=E(m);return CDEUtils.getDist(C,O,m,L)<CDEUtils.getDist(D,P,I,f)?[[[C,O],[D,P]],[[m,L],[I,f]]]:[[[D,P],[C,O]],[[I,f],[m,L]]]}updateCachedPath(){this._cachedPath=Render.getArc(this._pos,this._radius)}disablePathCaching(){this._cachedPath=null}duplicate(t=this.getInitPos(),e=this._radius,i=this._color,s=this._setupCB,r=this._anchorPos,n=this._activationMargin,a=!this._cachedPath){const o=i,l=o?.colorRaw,h=new Dot(t,e,(l instanceof Gradient||l instanceof Pattern)&&null!=l._initPositions.id&&null!=this._parent.id&&l._initPositions.id==this._parent.id?null:(t,e)=>l instanceof Gradient||l instanceof Pattern?l.duplicate(Array.isArray(l.initPositions)?null:e):o.duplicate(),s,r,n,a);return h._scale=CDEUtils.unlinkArr2(this._scale),h._rotation=this._rotation,h._visualEffects=this.visualEffects_,h}isWithin(t,e,i,s){return super.isWithin(t,this.getBounds(e,i,s))}isWithinAccurate(t,e,i,s){const r=this.cvs.viewPos;return this.ctx.isPointInPath(this.getBoundsAccurate(e,i,s),t[0]+r[0],t[1]+r[1])}#st(){const t=this._pos,e=this._radius;return[[t[0]-e,t[1]-e],[t[0]+e,t[1]+e]]}getBoundsAccurate(t,e=this._rotation,i=this._scale){const s=this._radius;return t??=0,t="number"==typeof t?[t,t]:[t[0],t[1]??t[0]],Render.getEllispe(this._pos,s*i[0]+t[0],s*i[1]+t[1],CDEUtils.toRad(e))}getCenter(){return this._pos}getBounds(t,e=this._rotation,i=this._scale){const s=this.#st();return super.getBounds(s,t,i[0]==i[1]||1==i[0]&&1==i[1]?0:e,i,super.getCenter(s))}[Symbol.toPrimitive](){return this.id}*[Symbol.iterator](){const t=this._connections,e=t.length;for(let i=0;i<e;i++)yield t[i]}get[Symbol.toStringTag](){return this.instanceOf}get instanceOf(){return"Dot"}get ctx(){return this.cvs.ctx}get cvs(){return this._parent.parent||this._parent}get render(){return this.cvs.render}get limit(){return this._parent.limit}get drawEffectCB(){return this._parent?.drawEffectCB}get mouse(){return this.cvs.mouse}get ratioPos(){return this._parent.ratioPos}get connections(){return this._connections}get parentSetupResults(){return this._parent?.setupResults}get top(){return this.y-this._radius*this._scale[1]}get bottom(){return this.y+this._radius*this._scale[1]}get right(){return this.x+this._radius*this._scale[0]}get left(){return this.x-this._radius*this._scale[0]}get width(){return 2*this._radius*this._scale[0]}get height(){return 2*this._radius*this._scale[1]}get x(){return super.x}get y(){return super.y}get pos(){return this._pos}get relativeX(){return super.relativeX}get relativeY(){return super.relativeY}get relativePos(){return super.relativePos}get radius(){return this._radius}get cachedPath(){return this._cachedPath}set x(t){t=CDEUtils.round(t,_BaseObj.POSITION_PRECISION),this._pos[0]!=t&&(this._pos[0]=t,this._cachedPath&&this.updateCachedPath())}set y(t){t=CDEUtils.round(t,_BaseObj.POSITION_PRECISION),this._pos[1]!=t&&(this._pos[1]=t,this._cachedPath&&this.updateCachedPath())}set pos(t){CDEUtils.posEquals(t,this._pos)||(this.x=t[0],this.y=t[1],this._cachedPath&&this.updateCachedPath())}set relativeX(t){this.x=this.anchorPos[0]+t}set relativeY(t){this.y=this.anchorPos[1]+t}set relativePos(t){this.relativeX=CDEUtils.round(t[0],_BaseObj.POSITION_PRECISION),this.relativeY=CDEUtils.round(t[1],_BaseObj.POSITION_PRECISION)}set radius(t){t=CDEUtils.round(t<0?0:t,_Obj.RADIUS_PRECISION),this._radius!=t&&(this._radius=t,this._cachedPath&&this.updateCachedPath())}set limit(t){this._parent.limit=t}set connections(t){return this._connections=t}set cachedPath(t){this._cachedPath=t}}export const SETTINGS={MATERIALS:{AIR:0,SAND:1,WATER:2,STONE:4,GRAVEL:8,INVERTED_WATER:16,CONTAMINANT:32,LAVA:64,ELECTRICITY:128,COPPER:256},MATERIAL_GROUPS:{TRANSPIERCEABLE:null,LIQUIDS:null,CONTAMINABLE:null,MELTABLE:null,HAS_VISUAL_EFFECTS:null,REVERSE_LOOP_CONTAINED_SKIPABLE:null,FOWARD_LOOP_CONTAINED_SKIPABLE:null},MATERIAL_NAMES:[],MATERIAL_STATES:{EMPTY:0,COPPER:{LIT:1,ORIGIN:2,DISABLED:4}},MATERIAL_STATES_GROUPS:{COPPER:{ACTIVATED:null,SOURCEABLE:null}},D:{b:1,r:2,l:4,br:8,bl:16,t:32,tr:64,tl:128},SIDE_PRIORITIES:{RANDOM:0,LEFT:1,RIGHT:2,MAP_DEPENDANT:3},SIDE_PRIORITY_NAMES:[],DEFAULT_BACK_STEP_SAVING_COUNT:500,EXPORT_STATES:{RAW:0,COMPACTED:1},EXPORT_SEPARATOR:"x",BRUSH_TYPES:{PIXEL:1,VERTICAL_CROSS:2,LINE3:4,ROW3:8,BIG_DOT:16,X3:32,X5:64,X15:128,X25:256,X55:512,X99:1024},BRUSH_TYPE_NAMES:[],BRUSH_GROUPS:{},BRUSHES_X_VALUES:[],WORKER_RELATIVE_PATH:new URL("./RemotePhysicsUnit.min.js",import.meta.url).href,WORKER_MESSAGE_TYPES:{INIT:0,STEP:1,START_LOOP:4,STOP_LOOP:8,SIDE_PRIORITY:16,MAP_SIZE:32,PIXELS:64},WORKER_MESSAGE_GROUPS:{GIVES_PIXELS_TO_MAIN:null,GIVES_PIXELS_TO_WORKER:null},PHYSICS_UNIT_TYPE:{LOCAL:0,WORKER:1},INITIALIZED_STATES:{NOT_INITIALIZED:0,READY:1,INITIALIZED:2},FILE_SERVED_WARN:"Web workers are disabled when serving with file:// protocol.\n  Serve this page over http(s):// to enable them.",STANDALONE_KEYBIND_WARN:"The keybind pressed is not linked to any function.",NOT_INITIALIZED_LOAD_WARN:"Tried loading with 'load()' while simulation is not yet initialized.\n Use the 'readyCB' callback to load a save on launch.",NOT_INITIALIZED_MAP_SIZE_WARN:"Tried updating map size with 'updateMapSize()' while simulation is not yet initialized.\n Use the 'readyCB' callback to update map size on launch.",NOT_INITIALIZED_PIXEL_SIZE_WARN:"Tried updating pixel size with 'updateMapPixelSize()' while simulation is not yet initialized.\n Use the 'readyCB' callback to update pixel size on launch.",NOT_INITIALIZED_PHYSICS_TYPE_WARN:"Tried updating physics unit type with 'updatePhysicsUnitType()' while simulation is not yet initialized.\n Use the 'readyCB' callback to update physics unit type on launch.",DEFAULT_WORLD_START_SETTINGS:{autoStart:!0,usesWebWorkers:!0,aimedFPS:60,zoom:null,cameraCenterPos:void 0,mapWidth:null,mapHeight:null,mapPixelSize:null},DEFAULT_USER_SETTINGS:{autoSimulationSizing:null,dragAndZoomCanvasEnabled:!0,minZoomThreshold:.1,maxZoomThreshold:Infinity,zoomInIncrement:.25,zoomOutIncrement:-.2,warningsDisabled:!1,showBorder:!0,showGrid:!0,smoothDrawingEnabled:!0,visualEffectsEnabled:!0},DEFAULT_COLOR_SETTINGS:{grid:[240,248,255,.2],border:[240,248,255,1],AIR:[0,0,0,0],SAND:[235,235,158,1],WATER:[0,15,242,.7],STONE:[100,100,100,1],GRAVEL:[188,188,188,1],INVERTED_WATER:[55,75,180,.75],CONTAMINANT:[30,95,65,.75],LAVA:[255,132,0,.88],ELECTRICITY:[255,235,0,.9],COPPER:[121,65,52,1]},DEFAULT_MAP_RESOLUTIONS:{HIGH:2,MEDIUM:10,SMALL:18,DEFAULT:10}};null===SETTINGS.DEFAULT_USER_SETTINGS.autoSimulationSizing&&(SETTINGS.DEFAULT_USER_SETTINGS.autoSimulationSizing=SETTINGS.DEFAULT_MAP_RESOLUTIONS.DEFAULT),SETTINGS.MATERIAL_GROUPS={TRANSPIERCEABLE:SETTINGS.MATERIALS.WATER|SETTINGS.MATERIALS.INVERTED_WATER|SETTINGS.MATERIALS.AIR|SETTINGS.MATERIALS.CONTAMINANT,LIQUIDS:SETTINGS.MATERIALS.WATER|SETTINGS.MATERIALS.INVERTED_WATER|SETTINGS.MATERIALS.CONTAMINANT,CONTAMINABLE:SETTINGS.MATERIALS.WATER|SETTINGS.MATERIALS.INVERTED_WATER,MELTABLE:SETTINGS.MATERIALS.SAND|SETTINGS.MATERIALS.GRAVEL,HAS_VISUAL_EFFECTS:SETTINGS.MATERIALS.ELECTRICITY|SETTINGS.MATERIALS.COPPER,REVERSE_LOOP_CONTAINED_SKIPABLE:SETTINGS.MATERIALS.SAND|SETTINGS.MATERIALS.WATER|SETTINGS.MATERIALS.GRAVEL|SETTINGS.MATERIALS.CONTAMINANT|SETTINGS.MATERIALS.LAVA|SETTINGS.MATERIALS.ELECTRICITY,FORWARDS_LOOP_CONTAINED_SKIPABLE:SETTINGS.MATERIALS.INVERTED_WATER},SETTINGS.MATERIAL_STATES_GROUPS={COPPER:{ACTIVATED:SETTINGS.MATERIAL_STATES.COPPER.LIT|SETTINGS.MATERIAL_STATES.COPPER.ORIGIN,SOURCEABLE:SETTINGS.MATERIAL_STATES.COPPER.LIT|SETTINGS.MATERIAL_STATES.COPPER.DISABLED}},SETTINGS.WORKER_MESSAGE_GROUPS={GIVES_PIXELS_TO_MAIN:SETTINGS.WORKER_MESSAGE_TYPES.STEP|SETTINGS.WORKER_MESSAGE_TYPES.PIXELS,GIVES_PIXELS_TO_WORKER:SETTINGS.WORKER_MESSAGE_TYPES.STEP|SETTINGS.WORKER_MESSAGE_TYPES.PIXELS|SETTINGS.WORKER_MESSAGE_TYPES.START_LOOP},SETTINGS.BRUSH_GROUPS={SMALL_OPTIMIZED:SETTINGS.BRUSH_TYPES.PIXEL|SETTINGS.BRUSH_TYPES.VERTICAL_CROSS|SETTINGS.BRUSH_TYPES.LINE3|SETTINGS.BRUSH_TYPES.ROW3,X:SETTINGS.BRUSH_TYPES.X3|SETTINGS.BRUSH_TYPES.X5|SETTINGS.BRUSH_TYPES.X15|SETTINGS.BRUSH_TYPES.X25|SETTINGS.BRUSH_TYPES.X55|SETTINGS.BRUSH_TYPES.X99};const M=SETTINGS.MATERIALS,materials=Object.keys(M),m_ll=materials.length;for(let t=0,e=0;e<m_ll;t=t?2*t:1,e++)SETTINGS.MATERIAL_NAMES[t]=materials[e];const B=SETTINGS.BRUSH_TYPES,brushTypes=Object.keys(B),bt_ll=brushTypes.length;for(let t=1,e=0;e<bt_ll;t=t?2*t:1,e++)SETTINGS.BRUSH_TYPE_NAMES[t]=brushTypes[e];SETTINGS.SIDE_PRIORITY_NAMES=Object.keys(SETTINGS.SIDE_PRIORITIES);const brushesX=Object.keys(SETTINGS.BRUSH_TYPES).filter(t=>t.startsWith("X")),b_ll=brushesX.length;for(let t=SETTINGS.BRUSH_TYPES[brushesX[0]],e=0;e<b_ll;t=t?2*t:1,e++)SETTINGS.BRUSHES_X_VALUES[t]=+brushesX[e].slice(1);export const DEFAULT_KEYBINDS={MY_CUSTOM_SIZE_KEYBIND:{requiredKeys:[TypingDevice.KEYS.CONTROL,TypingDevice.KEYS.SHIFT],keys:[TypingDevice.KEYS.G],triggerType:TypingDevice.TRIGGER_TYPES.ONCE,preventDefault:!0},STEP:{defaultFunction:"step",keys:[TypingDevice.KEYS.ARROW_RIGHT],triggerType:TypingDevice.TRIGGER_TYPES.MEDIUM_REPEATING},BACK_STEP:{defaultFunction:"backStep",keys:[TypingDevice.KEYS.ARROW_LEFT],triggerType:TypingDevice.TRIGGER_TYPES.MEDIUM_REPEATING},STEP_FAST:{defaultFunction:"step",keys:[TypingDevice.KEYS.ARROW_UP],triggerType:TypingDevice.TRIGGER_TYPES.FAST_REPEATING},BACK_STEP_FAST:{defaultFunction:"backStep",keys:[TypingDevice.KEYS.ARROW_DOWN],triggerType:TypingDevice.TRIGGER_TYPES.FAST_REPEATING},START:{defaultFunction:"start",keys:[TypingDevice.KEYS.SPACE],triggerType:TypingDevice.TRIGGER_TYPES.ONCE},STOP:{defaultFunction:"stop",defaultParams:["test"],keys:[TypingDevice.KEYS.ESCAPE],triggerType:TypingDevice.TRIGGER_TYPES.ONCE},CLEAR:{defaultFunction:"clear",requiredKeys:[TypingDevice.KEYS.CONTROL],keys:[TypingDevice.KEYS.BACKSPACE],triggerType:TypingDevice.TRIGGER_TYPES.ONCE,preventDefault:!0},DISABLE_WORKERS:{defaultFunction:"updatePhysicsUnitType",defaultParams:[!1],requiredKeys:[TypingDevice.KEYS.CONTROL],keys:[TypingDevice.KEYS.O],triggerType:TypingDevice.TRIGGER_TYPES.ONCE,preventDefault:!0},ENABLE_WORKERS:{defaultFunction:"updatePhysicsUnitType",defaultParams:[!0],requiredKeys:[TypingDevice.KEYS.CONTROL],keys:[TypingDevice.KEYS.P],triggerType:TypingDevice.TRIGGER_TYPES.ONCE,preventDefault:!0},SELECT_SAND:{defaultFunction:"updateSelectedMaterial",defaultParams:[SETTINGS.MATERIALS.SAND],cancelKeys:[TypingDevice.KEYS.CONTROL],keys:[TypingDevice.KEYS.DIGIT_1,TypingDevice.KEYS.NUMPAD_1],triggerType:TypingDevice.TRIGGER_TYPES.ONCE,preventDefault:!0},SELECT_WATER:{defaultFunction:"updateSelectedMaterial",defaultParams:[SETTINGS.MATERIALS.WATER],cancelKeys:[TypingDevice.KEYS.CONTROL],keys:[TypingDevice.KEYS.DIGIT_2,TypingDevice.KEYS.NUMPAD_2],triggerType:TypingDevice.TRIGGER_TYPES.ONCE,preventDefault:!0},SELECT_STONE:{defaultFunction:"updateSelectedMaterial",defaultParams:[SETTINGS.MATERIALS.STONE],cancelKeys:[TypingDevice.KEYS.CONTROL],keys:[TypingDevice.KEYS.DIGIT_3,TypingDevice.KEYS.NUMPAD_3],triggerType:TypingDevice.TRIGGER_TYPES.ONCE,preventDefault:!0},SELECT_GRAVEL:{defaultFunction:"updateSelectedMaterial",defaultParams:[SETTINGS.MATERIALS.GRAVEL],cancelKeys:[TypingDevice.KEYS.CONTROL],keys:[TypingDevice.KEYS.DIGIT_4,TypingDevice.KEYS.NUMPAD_4],triggerType:TypingDevice.TRIGGER_TYPES.ONCE,preventDefault:!0},SELECT_INVERTED_WATER:{defaultFunction:"updateSelectedMaterial",defaultParams:[SETTINGS.MATERIALS.INVERTED_WATER],cancelKeys:[TypingDevice.KEYS.CONTROL],keys:[TypingDevice.KEYS.DIGIT_5,TypingDevice.KEYS.NUMPAD_5],triggerType:TypingDevice.TRIGGER_TYPES.ONCE,preventDefault:!0},SELECT_CONTAMINANT:{defaultFunction:"updateSelectedMaterial",defaultParams:[SETTINGS.MATERIALS.CONTAMINANT],cancelKeys:[TypingDevice.KEYS.CONTROL],keys:[TypingDevice.KEYS.DIGIT_6,TypingDevice.KEYS.NUMPAD_6],triggerType:TypingDevice.TRIGGER_TYPES.ONCE,preventDefault:!0},SELECT_LAVA:{defaultFunction:"updateSelectedMaterial",defaultParams:[SETTINGS.MATERIALS.LAVA],cancelKeys:[TypingDevice.KEYS.CONTROL],keys:[TypingDevice.KEYS.DIGIT_7,TypingDevice.KEYS.NUMPAD_7],triggerType:TypingDevice.TRIGGER_TYPES.ONCE,preventDefault:!0},SELECT_ELECTRICITY:{defaultFunction:"updateSelectedMaterial",defaultParams:[SETTINGS.MATERIALS.ELECTRICITY],cancelKeys:[TypingDevice.KEYS.CONTROL],keys:[TypingDevice.KEYS.DIGIT_8,TypingDevice.KEYS.NUMPAD_8],triggerType:TypingDevice.TRIGGER_TYPES.ONCE,preventDefault:!0},SELECT_COPPER:{defaultFunction:"updateSelectedMaterial",defaultParams:[SETTINGS.MATERIALS.COPPER],cancelKeys:[TypingDevice.KEYS.CONTROL],keys:[TypingDevice.KEYS.DIGIT_9,TypingDevice.KEYS.NUMPAD_9],triggerType:TypingDevice.TRIGGER_TYPES.ONCE,preventDefault:!0},SELECT_AIR:{defaultFunction:"updateSelectedMaterial",defaultParams:[SETTINGS.MATERIALS.AIR],cancelKeys:[TypingDevice.KEYS.CONTROL],keys:[TypingDevice.KEYS.DIGIT_0,TypingDevice.KEYS.NUMPAD_0],triggerType:TypingDevice.TRIGGER_TYPES.ONCE,preventDefault:!0},BRUSH_PIXEL:{defaultFunction:"updateBrushType",defaultParams:[SETTINGS.BRUSH_TYPES.PIXEL],requiredKeys:[TypingDevice.KEYS.CONTROL],keys:[TypingDevice.KEYS.DIGIT_1,TypingDevice.KEYS.NUMPAD_1],triggerType:TypingDevice.TRIGGER_TYPES.ONCE,preventDefault:!0},BRUSH_VERTICAL_CROSS:{defaultFunction:"updateBrushType",defaultParams:[SETTINGS.BRUSH_TYPES.VERTICAL_CROSS],requiredKeys:[TypingDevice.KEYS.CONTROL],keys:[TypingDevice.KEYS.DIGIT_2,TypingDevice.KEYS.NUMPAD_2],triggerType:TypingDevice.TRIGGER_TYPES.ONCE,preventDefault:!0},BRUSH_X3:{defaultFunction:"updateBrushType",defaultParams:[SETTINGS.BRUSH_TYPES.X3],requiredKeys:[TypingDevice.KEYS.CONTROL],keys:[TypingDevice.KEYS.DIGIT_3,TypingDevice.KEYS.NUMPAD_3],triggerType:TypingDevice.TRIGGER_TYPES.ONCE,preventDefault:!0},BRUSH_BIG_DOT:{defaultFunction:"updateBrushType",defaultParams:[SETTINGS.BRUSH_TYPES.BIG_DOT],requiredKeys:[TypingDevice.KEYS.CONTROL],keys:[TypingDevice.KEYS.DIGIT_4,TypingDevice.KEYS.NUMPAD_4],triggerType:TypingDevice.TRIGGER_TYPES.ONCE,preventDefault:!0},BRUSH_X5:{defaultFunction:"updateBrushType",defaultParams:[SETTINGS.BRUSH_TYPES.X5],requiredKeys:[TypingDevice.KEYS.CONTROL],keys:[TypingDevice.KEYS.DIGIT_5,TypingDevice.KEYS.NUMPAD_5],triggerType:TypingDevice.TRIGGER_TYPES.ONCE,preventDefault:!0},BRUSH_X15:{defaultFunction:"updateBrushType",defaultParams:[SETTINGS.BRUSH_TYPES.X15],requiredKeys:[TypingDevice.KEYS.CONTROL],keys:[TypingDevice.KEYS.DIGIT_6,TypingDevice.KEYS.NUMPAD_6],triggerType:TypingDevice.TRIGGER_TYPES.ONCE,preventDefault:!0},BRUSH_X25:{defaultFunction:"updateBrushType",defaultParams:[SETTINGS.BRUSH_TYPES.X25],requiredKeys:[TypingDevice.KEYS.CONTROL],keys:[TypingDevice.KEYS.DIGIT_7,TypingDevice.KEYS.NUMPAD_7],triggerType:TypingDevice.TRIGGER_TYPES.ONCE,preventDefault:!0},BRUSH_X55:{defaultFunction:"updateBrushType",defaultParams:[SETTINGS.BRUSH_TYPES.X55],requiredKeys:[TypingDevice.KEYS.CONTROL],keys:[TypingDevice.KEYS.DIGIT_8,TypingDevice.KEYS.NUMPAD_9],triggerType:TypingDevice.TRIGGER_TYPES.ONCE,preventDefault:!0},BRUSH_X99:{defaultFunction:"updateBrushType",defaultParams:[SETTINGS.BRUSH_TYPES.X99],requiredKeys:[TypingDevice.KEYS.CONTROL],keys:[TypingDevice.KEYS.DIGIT_0,TypingDevice.KEYS.NUMPAD_0],triggerType:TypingDevice.TRIGGER_TYPES.ONCE,preventDefault:!0}};export class LocalPhysicsUnit{constructor(){this._physicsCore=new PhysicsCore}step(t,e,i,s,r,n){const[a,o]=this._physicsCore.step(t,e,i,s,r,n,Simulation.MATERIALS,Simulation.MATERIAL_GROUPS,Simulation.D,Simulation.MATERIAL_STATES,Simulation.MATERIAL_STATES_GROUPS,Simulation.SIDE_PRIORITIES);t=a,i=o}}export class PhysicsCore{static D={b:1,r:2,l:4,br:8,bl:16,t:32,tr:64,tl:128};static#Mt=0;static#vt=null;static#Ft=65536;static#xt=0;static#Bt={I:0,B:1,R:2,L:3,BR:4,BL:5,T:6,TR:7,TL:8};static#Gt=PhysicsCore.D.bl<<1;static#wt=new Uint8Array(PhysicsCore.#Gt<<1);static#Vt=PhysicsCore.D.bl<<1;static#Ht=new Uint8Array(PhysicsCore.#Vt<<1);static#Yt=PhysicsCore.D.tl<<1;static#kt=new Uint8Array(PhysicsCore.#Yt<<1);static{const t=PhysicsCore.D,e=PhysicsCore.#Ft,i=PhysicsCore.#vt=new Float32Array(e);for(let t=0;t<e;t++)i[t]=Math.random();const s=PhysicsCore.#wt,r=s.length;for(let e=0;e<r;e++)s[e]=PhysicsCore.#zt(t,e);const n=PhysicsCore.#Ht,a=n.length;for(let e=0;e<a;e++)n[e]=PhysicsCore.#Wt(t,e);const o=PhysicsCore.#kt,l=o.length;for(let e=0;e<l;e++)o[e]=PhysicsCore.#Kt(t,e)}step(t,e,i,s,r,n,a,o,l,h,_,c){function u(t){return!!I||!m&&(D?R[PhysicsCore.#xt++&C]<.5:t%r<d)}const E=t.length-1,d=r>>1,T=a.AIR,S=a.STONE,A=o.LIQUIDS,p=o.MELTABLE,g=o.REVERSE_LOOP_CONTAINED_SKIPABLE,R=PhysicsCore.#vt,C=PhysicsCore.#Ft-1,D=s===c.RANDOM,I=s===c.LEFT,m=s===c.RIGH,{B:O,R:P,L:f,BR:L,BL:y,T:N,TR:b,TL:U}=PhysicsCore.#Bt,M=PhysicsCore.#wt,v=PhysicsCore.#Gt,F=PhysicsCore.#Ht,x=PhysicsCore.#Vt,B=PhysicsCore.#kt,G=PhysicsCore.#Yt;e.fill(0);for(let s=E;s>=0;s--){const c=t[s];if(c===T||e[s]||c===S)continue;const E=s%r,d=s/r|0,D=E>0,I=E<r-1,m=d>0,w=d<n-1,V=w?s+r:s,H=m?s-r:s,Y=D?s-1:s,k=I?s+1:s,z=t[V],W=t[k],K=t[Y],X=t[H];if(c&g&&0===(z^c|W^c|K^c|X^c))continue;const Z=w&&D?s+r-1:s,q=w&&I?s+r+1:s,j=m&&D?s-r-1:s,Q=m&&I?s-r+1:s;let $=c,J=-1,tt=T;if(c===a.SAND){const e=z&o.TRANSPIERCEABLE,i=M[(z===T||0!==(z&o.TRANSPIERCEABLE))*l.b|(t[q]===T)*l.br|(t[Z]===T)*l.bl|u(s)*v];i===O?J=V:i===L?J=q:i===y&&(J=Z),-1!==J&&(K&A||W&A)&&(tt=e)}else if(c===a.WATER){const e=F[(z===T)*l.b|(t[q]===T)*l.br|(t[Z]===T)*l.bl|(W===T)*l.r|(K===T)*l.l|u(s)*x];e===O?J=V:e===L?J=q:e===y?J=Z:e===P?J=k:e===f&&(J=Y)}else if(c===a.GRAVEL){const t=z&A;z!==T&&0===(z&o.TRANSPIERCEABLE)||(J=V),t&&(K&A||W&A)&&(tt=t)}else if(c===a.INVERTED_WATER){const e=B[(X===T)*l.t|(t[Q]===T)*l.tr|(t[j]===T)*l.tl|(W===T)*l.r|(K===T)*l.l|u(s)*G];e===N?J=H:e===b?J=Q:e===U?J=j:e===P?J=k:e===f&&(J=Y)}else if(c===a.CONTAMINANT){let i=F[(z===T)*l.b];const r=.5;i===O?J=V:(i=F[(t[q]===T)*l.br|(t[Z]===T)*l.bl|(W===T)*l.r|(K===T)*l.l|u(s)*x],i===L?J=q:i===y?J=Z:i===P?J=k:i===f&&(J=Y),K&o.CONTAMINABLE&&R[PhysicsCore.#xt++&C]>r&&(t[Y]=c,e[Y]=1),W&o.CONTAMINABLE&&R[PhysicsCore.#xt++&C]>r&&(t[k]=c,e[k]=1),z&o.CONTAMINABLE&&R[PhysicsCore.#xt++&C]>r&&(t[V]=c,e[V]=1),X&o.CONTAMINABLE&&R[PhysicsCore.#xt++&C]>r&&(t[H]=c,e[H]=1))}else if(c===a.LAVA)if(K&A||W&A||X&A||z&A)t[s]=a.STONE,e[s]=1;else{let i=F[(z===T)*l.b];const r=.935,n=.9992;i===O?J=V:R[PhysicsCore.#xt++&C]>r?(i=F[(t[q]===T)*l.br|(t[Z]===T)*l.bl|(W===T)*l.r|(K===T)*l.l|u(s)*x],i===L?J=q:i===y?J=Z:i===P?J=k:i===f&&(J=Y)):(K&p||W&p||X&p||z&p)&&R[PhysicsCore.#xt++&C]>n&&(K&p?(t[Y]=c,e[Y]=1):W&p?(t[k]=c,e[k]=1):z&p?(t[V]=c,e[V]=1):X&p&&(t[H]=c,e[H]=1))}else if(c===a.ELECTRICITY){const t=h.COPPER.ORIGIN;if(z===T)J=V;else{let s,r,n,o,l=a.COPPER,h=_.COPPER.SOURCEABLE;z===l&&(0===(s=i[V])||s&h)&&(i[V]=t,e[V]=2),X===l&&(0===(r=i[H])||r&h)&&(i[H]=t,e[H]=2),W===l&&(0===(n=i[k])||n&h)&&(i[k]=t,e[k]=2),K===l&&(0===(o=i[Y])||o&h)&&(i[Y]=t,e[Y]=2)}}else if(c===a.COPPER){const t=i[s],r=_.COPPER.ACTIVATED,n=h.COPPER.ORIGIN,o=a.ELECTRICITY;t===n?z!==o&&X!==o&&W!==o&&K!==o&&(i[s]=h.COPPER.DISABLED,e[s]=2):t?t===h.COPPER.LIT?(z===c&&i[V]===h.COPPER.DISABLED&&(i[s]=h.COPPER.DISABLED,e[s]=2,e[H]=2,e[V]=2,e[k]=2,e[Y]=2),X===c&&i[H]===h.COPPER.DISABLED&&(i[s]=h.COPPER.DISABLED,e[s]=2,e[H]=2,e[V]=2,e[k]=2,e[Y]=2),W===c&&i[k]===h.COPPER.DISABLED&&(i[s]=h.COPPER.DISABLED,e[s]=2,e[H]=2,e[V]=2,e[k]=2,e[Y]=2),K===c&&i[Y]===h.COPPER.DISABLED&&(i[s]=h.COPPER.DISABLED,e[s]=2,e[H]=2,e[V]=2,e[k]=2,e[Y]=2)):t===h.COPPER.DISABLED&&((z!==c||i[V]!==n&&i[V])&&(X!==c||i[H]!==n&&i[H])&&(W!==c||i[k]!==n&&i[k])&&(K!==c||i[Y]!==n&&i[Y])||(i[s]=0)):(z===c&&i[V]&r&&(i[s]=h.COPPER.LIT,e[s]=2,e[H]=2,e[k]=2,e[Y]=2),X===c&&i[H]&r&&(i[s]=h.COPPER.LIT,e[s]=2,e[V]=2,e[k]=2,e[Y]=2),W===c&&i[k]&r&&(i[s]=h.COPPER.LIT,e[s]=2,e[H]=2,e[V]=2,e[Y]=2),K===c&&i[Y]&r&&(i[s]=h.COPPER.LIT,e[s]=2,e[H]=2,e[V]=2,e[k]=2))}-1!==J&&(e[J]=1,t[J]=$,t[s]=tt)}return[t,i]}static#zt(t,e){const i=e&PhysicsCore.#Gt,s=PhysicsCore.#Bt,r=e&t.b,n=e&t.br,a=e&t.bl;if(r)return s.B;if(i){if(a)return s.BL;if(n)return s.BR}else{if(n)return s.BR;if(a)return s.BL}return s.I}static#Wt(t,e){const i=e&PhysicsCore.#Vt,s=PhysicsCore.#Bt,r=e&t.b,n=e&t.r,a=e&t.l,o=e&t.br,l=e&t.bl;if(r)return s.B;if(i){if(l)return s.BL;if(o)return s.BR;if(a)return s.L;if(n)return s.R}else{if(o)return s.BR;if(l)return s.BL;if(n)return s.R;if(a)return s.L}return s.I}static#Kt(t,e){const i=e&PhysicsCore.#Yt,s=PhysicsCore.#Bt,r=e&t.t,n=e&t.r,a=e&t.l,o=e&t.tr,l=e&t.tl;if(r)return s.T;if(i){if(l)return s.TL;if(o)return s.TR;if(a)return s.L;if(n)return s.R}else{if(o)return s.TR;if(l)return s.TL;if(n)return s.R;if(a)return s.L}return s.I}}export class MapGrid{static DEFAULT_PIXEL_SIZE=18;static DEFAULT_MAP_WIDTH=50;static DEFAULT_MAP_HEIGHT=35;#Xt=null;constructor(t,e,i){this._pixelSize=this.#Xt=t||MapGrid.DEFAULT_PIXEL_SIZE,this._mapWidth=e||MapGrid.DEFAULT_MAP_WIDTH,this._mapHeight=i||MapGrid.DEFAULT_MAP_HEIGHT}getLocalMapPixel(t){const e=this._pixelSize,[i,s]=this.globalDimensions,[r,n]=t;for(let t=0;t<s;t+=e)for(let s=0;s<i;s+=e)if(r>=s&&r<s+e&&n>=t&&n<t+e)return[s/e,t/e]}getAdjacency(t,e,i=1){const s=Simulation.D,r=this._mapWidth,n=r*i,a=t%r,o=t/r|0,l=a>=i,h=a+i<r,_=o>=i,c=o+i<this._mapHeight;return e===s.b?c?t+n:t:e===s.t?_?t-n:t:e===s.l?l?t-i:t:e===s.r?h?t+i:t:e===s.bl?c&&l?t+n-i:t:e===s.br?c&&h?t+n+i:t:e===s.tl?_&&l?t-n-i:t:e===s.tr?_&&h?t-n+i:t:void 0}getDrawableGridLines(){const t=this._pixelSize,[e,i]=this.globalDimensions,s=[];for(let r=0;r<e;r+=t)s.push(Render.getLine([r,0],[r,i]));for(let r=0;r<i;r+=t)s.push(Render.getLine([0,r],[e,r]));return s}indexToMapPos(t){const e=this._mapWidth;return[t%e,t/e|0]}mapPosToIndex(t){return t[1]*this._mapWidth+t[0]}mapPosToIndexCoords(t,e){return e*this._mapWidth+t}getCenter(t){const e=this._mapWidth>>1,i=this._mapHeight>>1;return t?[e*this._pixelSize,i*this._pixelSize]:[e,i]}get globalWidth(){return this._mapWidth*this._pixelSize}get globalHeight(){return this._mapHeight*this._pixelSize}get globalDimensions(){return[this.globalWidth,this.globalHeight]}get arraySize(){return this._mapWidth*this._mapHeight}get displayDimensions(){return this._mapWidth+"x"+this._mapHeight}get lastPixelSize(){return this.#Xt}get pixelSize(){return this._pixelSize}get mapWidth(){return this._mapWidth}get mapHeight(){return this._mapHeight}get dimensions(){return[this._mapWidth,this._mapHeight]}set pixelSize(t){return this._pixelSize=t}set mapWidth(t){return this._mapWidth=t}set mapHeight(t){return this._mapHeight=t}set lastPixelSize(t){return this.#Xt=t}}export class Simulation{static MATERIALS=SETTINGS.MATERIALS;static MATERIAL_GROUPS=SETTINGS.MATERIAL_GROUPS;static MATERIAL_NAMES=SETTINGS.MATERIAL_NAMES;static MATERIAL_STATES=SETTINGS.MATERIAL_STATES;static MATERIAL_STATES_GROUPS=SETTINGS.MATERIAL_STATES_GROUPS;static D=SETTINGS.D;static SIDE_PRIORITIES=SETTINGS.SIDE_PRIORITIES;static SIDE_PRIORITY_NAMES=SETTINGS.SIDE_PRIORITY_NAMES;static EXPORT_STATES=SETTINGS.EXPORT_STATES;static EXPORT_SEPARATOR=SETTINGS.EXPORT_SEPARATOR;static BRUSH_TYPES=SETTINGS.BRUSH_TYPES;static BRUSH_TYPE_NAMES=SETTINGS.BRUSH_TYPE_NAMES;static#Zt=SETTINGS.BRUSHES_X_VALUES;static#qt=SETTINGS.BRUSH_GROUPS;static WORKER_RELATIVE_PATH=SETTINGS.WORKER_RELATIVE_PATH;static#jt=SETTINGS.WORKER_MESSAGE_TYPES;static#Qt=SETTINGS.WORKER_MESSAGE_GROUPS;static PHYSICS_UNIT_TYPE=SETTINGS.PHYSICS_UNIT_TYPE;static#$t=SETTINGS.INITIALIZED_STATES;static#Jt=[];static#te=null;static#ee=null;static DEFAULT_WORLD_START_SETTINGS=SETTINGS.DEFAULT_WORLD_START_SETTINGS;static DEFAULT_USER_SETTINGS=SETTINGS.DEFAULT_USER_SETTINGS;static DEFAULT_COLOR_SETTINGS=SETTINGS.DEFAULT_COLOR_SETTINGS;static DEFAULT_MATERIAL=Simulation.MATERIALS.SAND;static DEFAULT_BRUSH_TYPE=Simulation.BRUSH_TYPES.PIXEL;static DEFAULT_BACK_STEP_SAVING_COUNT=SETTINGS.DEFAULT_BACK_STEP_SAVING_COUNT;static DEFAULT_MAP_RESOLUTIONS=SETTINGS.DEFAULT_MAP_RESOLUTIONS;static DEFAULT_KEYBINDS=DEFAULT_KEYBINDS;#ie=!0;#se=null;constructor(t,e,i,s,r){this._CVS=t instanceof Canvas?t:new Canvas(t),this._worldStartSettings=this.getAdjustedSettings(i,Simulation.DEFAULT_WORLD_START_SETTINGS),this._CVS.fpsLimit=this._worldStartSettings.aimedFPS,this._initialized=this._worldStartSettings.autoStart?Simulation.#$t.NOT_INITIALIZED:Simulation.#$t.INITIALIZED,this._mapGrid=new MapGrid(this._worldStartSettings.mapPixelSize,this._worldStartSettings.mapWidth,this._worldStartSettings.mapHeight),this._pixels=new Uint16Array(this._mapGrid.arraySize),this._lastPixels=new Uint16Array(this._mapGrid.arraySize),this._pxStepUpdated=new Uint8Array(this._mapGrid.arraySize),this._pxStates=new Uint8Array(this._mapGrid.arraySize),this._backStepSavingMaxCount=Simulation.DEFAULT_BACK_STEP_SAVING_COUNT,this._backStepSaves=[],this._isMouseWithinSimulation=!0,this._isRunning=!1,this._selectedMaterial=Simulation.MATERIALS.SAND,this._sidePriority=Simulation.SIDE_PRIORITIES.RANDOM,this._lastStepTime=null,this._queuedBufferOperations=[],this.updatePhysicsUnitType(this._worldStartSettings.usesWebWorkers),this._userSettings=this.getAdjustedSettings(s,Simulation.DEFAULT_USER_SETTINGS),this._colorSettings=this.getAdjustedSettings(r,Simulation.DEFAULT_COLOR_SETTINGS),this._brushType=Simulation.BRUSH_TYPES.PIXEL,this._mapGridRenderStyles=this._CVS.render.profile1.update(this._colorSettings.grid,null,null,null,1),this._mapBorderRenderStyles=this._CVS.render.profile2.update(this._colorSettings.border,null,null,null,2),this._imgMap=this._CVS.ctx.createImageData(...this._mapGrid.globalDimensions),this._offscreenCanvas=new OffscreenCanvas(...this._mapGrid.globalDimensions),this._offscreenCtx=this._offscreenCanvas.getContext("2d"),this._loopExtra=null,this._stepExtra=null,this.#re(),this.#ne(),this.#ae(),this.setKeyBinds();const n=this._worldStartSettings.cameraCenterPos;void 0!==n&&this._CVS.centerViewAt(n||this._mapGrid.getCenter(!0)),this._worldStartSettings.zoom&&this._CVS.zoomAtPos(this._CVS.getCenter(),this._worldStartSettings.zoom),this._CVS.loopingCB=this.#oe.bind(this),this._CVS.setMouseMove(),this._CVS.setMouseLeave(),this._CVS.setMouseDown(this.#le.bind(this)),this._CVS.setMouseUp(this.#he.bind(this)),this._CVS.setKeyUp(null,!0),this._CVS.setKeyDown(null,!0),this._CVS.onResizeCB=()=>{const t=this.autoSimulationSizing;t&&this.autoFitSize(t)},this._CVS.start(),this._mouseListenerIds=[this._CVS.mouse.addListener([[0,0],this._mapGrid.globalDimensions],Mouse.LISTENER_TYPES.ENTER,()=>this._isMouseWithinSimulation=!0),this._CVS.mouse.addListener([[0,0],this._mapGrid.globalDimensions],Mouse.LISTENER_TYPES.MOVE,()=>this._isMouseWithinSimulation=!0),this._CVS.mouse.addListener([[0,0],this._mapGrid.globalDimensions],Mouse.LISTENER_TYPES.LEAVE,()=>this.#_e())],this._initialized=Simulation.#$t.READY,this.autoSimulationSizing&&this.autoFitSize(this.autoSimulationSizing),CDEUtils.isFunction(e)&&e(this),this._initialized=Simulation.#$t.NOT_INITIALIZED,this._worldStartSettings.autoStart&&this.start()}#oe(t){const e=this.mouse,i=this._userSettings,s=this._loopExtra;s&&s(t),e.clicked&&!this.keyboard.isDown(TypingDevice.KEYS.SHIFT)&&this.#ce(e),i.showGrid&&this.#ue(),i.showBorder&&this.#Ee(),this._isRunning&&this.useLocalPhysics&&this.step(),this._offscreenCtx.putImageData(this._imgMap,0,0),this.ctx.drawImage(this._offscreenCanvas,0,0),i.visualEffectsEnabled&&this.#de()}#de(){if(!this.#ie)return void this._queuedBufferOperations.push(()=>this.#de());const t=this._pixels,e=t.length,i=this._pxStates,s=this._mapGrid,r=Simulation.MATERIALS,n=Simulation.MATERIAL_GROUPS,a=(Simulation.MATERIAL_STATES_GROUPS,Simulation.D,s.mapWidth),o=s.pixelSize,l=o/4,h=Math.random(),_=(this.render.batchStroke.bind(this.render),this.render.batchFill.bind(this.render));for(let s=0;s<e;s++){const e=t[s];if(0===(e&n.HAS_VISUAL_EFFECTS))continue;const c=s/a|0,u=(s-c*a)*o,E=c*o,d=i[s];e===r.ELECTRICITY?_(Render.getPositionsRect([u-l,E-l],[u+o+l,E+o+l]),[255,235,0,.45*h]):e===r.COPPER&&d===Simulation.MATERIAL_STATES.COPPER.LIT?_(Render.getPositionsRect([u-l,E-l],[u+o+l,E+o+l]),[255,235,0,.35*h]):e===r.COPPER&&d===Simulation.MATERIAL_STATES.COPPER.ORIGIN?_(Render.getPositionsRect([u-l,E-l],[u+o+l,E+o+l]),[255,235,220,.4]):e===r.COPPER&&d===Simulation.MATERIAL_STATES.COPPER.DISABLED&&_(Render.getPositionsRect([u-l,E-l],[u+o+l,E+o+l]),[0,0,220,.3])}}#ue(){const t=Simulation.#te,e=t.length,i=this.render.batchStroke.bind(this.render),s=this._mapGridRenderStyles;for(let r=0;r<e;r++)i(t[r],s)}#Ee(){this.render.batchStroke(Simulation.#ee,this._mapBorderRenderStyles)}updateImgMapFromPixels(t){if(!this.#ie)return void this._queuedBufferOperations.push(()=>this.updateImgMapFromPixels(t));const e=this._pixels,i=this._lastPixels,s=e.length,r=this._mapGrid,n=!t&&i.length===s&&r.lastPixelSize===r.pixelSize,a=r.mapWidth;for(let t=0;t<s;t++){const s=e[t];if(n&&s===i[t])continue;const r=t/a|0;this.#Te(t-r*a,r,s)}n||(r.lastPixelSize=r.pixelSize),this._lastPixels=this.#Se()}#Te(t,e,i){const s=this._imgMap.data,r=this._mapGrid.pixelSize,n=this._imgMap.width,a=t*r,o=e*r,l=Simulation.#Jt[i];for(let t=0;t<r;t++)s.set(l,4*((o+t)*n+a))}step(){const t=Simulation.#jt,e=this._physicsUnit;if(this.useLocalPhysics&&this.#ie){const t=this._stepExtra;this.saveStep(),t&&t(),e.step(this._pixels,this._pxStepUpdated,this._pxStates,this._sidePriority,this._mapGrid.mapWidth,this._mapGrid.mapHeight),this.updateImgMapFromPixels()}else this.#ie&&this.#Ae(t.STEP)}backStep(){if(!this.#ie)return void this._queuedBufferOperations.push(()=>this.backStep());const t=this._backStepSaves,e=t.length;if(e){let i=t[e-1];const s=i[0],r=s.length,n=this.#Se();let a=r!==n.length;for(let t=0;t<r;t++)if(s[t]!==n[t]){a=!0;break}a||(i=t[e-2]),i&&this.load(i[0],i[1]),t.pop()}}saveStep(){if(this.backStepSavingEnabled){const t=this._backStepSaves,e=t.length,i=t[e-1]?.[0],s=i?.length,r=this.#Se();if(i){let t=s!==r.length;for(let e=0;e<s;e++)if(i[e]!==r[e]){t=!0;break}if(!t)return}t.push([r,this._mapGrid.dimensions]),e+1>this._backStepSavingMaxCount&&t.shift()}}start(t){this._initialized!==Simulation.#$t.INITIALIZED&&setTimeout(()=>this._initialized=Simulation.#$t.INITIALIZED),this._isRunning&&!t||(this._isRunning=!0,this.usesWebWorkers&&this.#Ae(Simulation.#jt.START_LOOP))}stop(){this._isRunning&&(this._isRunning=!1,this.usesWebWorkers&&this._physicsUnit.postMessage({type:Simulation.#jt.STOP_LOOP}))}updatePhysicsUnitType(t=!0){if(this.#pe(SETTINGS.NOT_INITIALIZED_PHYSICS_TYPE_WARN))return;const e=t&&!this.isFileServed;e&&this.usesWebWorkers||!e&&this.useLocalPhysics||(this._physicsUnit=e?new Worker(Simulation.WORKER_RELATIVE_PATH,{type:"module"}):new LocalPhysicsUnit,e?(this.#ie=!0,this._physicsUnit.onmessage=this.#ge.bind(this),this._physicsUnit.postMessage({type:Simulation.#jt.INIT,pixels:this._pixels,pxStepUpdated:this._pxStepUpdated,pxStates:this._pxStates,sidePriority:this._sidePriority,mapWidth:this._mapGrid.mapWidth,mapHeight:this._mapGrid.mapHeight,aimedFps:this._CVS.fpsLimit}),this._isRunning&&this.start(!0)):t&&this.isFileServed&&this.#Re(SETTINGS.FILE_SERVED_WARN))}autoFitSize(t=Simulation.DEFAULT_MAP_RESOLUTIONS.DEFAULT,e=this._CVS.width,i=this._CVS.height){!0!==t&&null!==t||(t=Simulation.DEFAULT_MAP_RESOLUTIONS.DEFAULT);const s=e/t|0,r=i/t|0;return this.updateMapPixelSize(t),this.updateMapSize(s,r),[s,r]}updateMapPixelSize(t=MapGrid.DEFAULT_PIXEL_SIZE){if(this.#pe(SETTINGS.NOT_INITIALIZED_PIXEL_SIZE_WARN))return;if(!this.#ie)return void this._queuedBufferOperations.push(()=>this.updateMapPixelSize(t));const e=this._mapGrid;t!==e.pixelSize&&(e.pixelSize=t,this._imgMap=this.ctx.createImageData(...e.globalDimensions),this._offscreenCanvas.width=e.globalDimensions[0],this._offscreenCanvas.height=e.globalDimensions[1],this.#ne(),this.#re(),this.updateImgMapFromPixels(),this.#Ce())}updateMapSize(t,e){if(this.#pe(SETTINGS.NOT_INITIALIZED_MAP_SIZE_WARN))return;if(!this.#ie)return void this._queuedBufferOperations.push(()=>this.updateMapSize(t,e));const i=this._mapGrid,s=i.mapWidth,r=i.mapHeight;if(t&&t!==s||e&&e!==r){const n=this.#Se();e=i.mapHeight=e||i.mapHeight,t=i.mapWidth=t||i.mapWidth,this.#De(s,r,t,e,n),this.#re(),this._imgMap=this.ctx.createImageData(...i.globalDimensions),this._offscreenCanvas.width=i.globalDimensions[0],this._offscreenCanvas.height=i.globalDimensions[1],this.updateImgMapFromPixels(),this.#Ce()}}updateSidePriority(t){return this.usesWebWorkers&&this._physicsUnit.postMessage({type:Simulation.#jt.SIDE_PRIORITY,sidePriority:t}),this._sidePriority=t}getPixelAtMapPos(t){const e=this._mapGrid.mapPosToIndex(t);return this.usesWebWorkers?this._lastPixels[e]:this._pixels[e]}updateSelectedMaterial(t){return t=+t,Simulation.MATERIAL_NAMES[t]?this._selectedMaterial=t:this._selectedMaterial}updateBrushType(t){return t=+t,Object.values(Simulation.BRUSH_TYPES).includes(t)?this._brushType=t:this._brushType}updateColors(t){this._colorSettings=this.getAdjustedSettings(t,this._colorSettings),t.grid&&this._mapGridRenderStyles.update(this._colorSettings.grid),t.border&&this._mapBorderRenderStyles.update(this._colorSettings.border),this.#ne(),this.updateImgMapFromPixels(!0)}#De(t,e,i,s,r){const n=this._mapGrid.arraySize,a=this._pixels=new Uint16Array(n),o=i-t,l=t<i?t:i,h=e<s?e:s;this._pxStepUpdated=new Uint8Array(n),this._pxStates=new Uint8Array(n),this.usesWebWorkers&&this._physicsUnit.postMessage({type:Simulation.#jt.MAP_SIZE,mapWidth:this._mapGrid.mapWidth,mapHeight:this._mapGrid.mapHeight,arraySize:n});for(let e=0,i=0,s=0;e<h;e++)a.set(r.subarray(s,s+l),i),s+=t,i+=t+o}getAdjustedSettings(t,e){const i={...e};return t&&Object.entries(t).forEach(([t,e])=>i[t]=e),i}#pe(t){if(this._userSettings&&this._initialized===Simulation.#$t.NOT_INITIALIZED)return this.#Re(t),!0}#Re(t){this.warningsDisabled||console.warn(t)}#ge(t){const e=t.data,i=e.type,s=Simulation.#jt,r=this._stepExtra;i&Simulation.#Qt.GIVES_PIXELS_TO_MAIN&&(this._pixels=new Uint16Array(e.pixels),this._pxStates=new Uint16Array(e.pxStates),this.#ie=!0),i===s.STEP&&(this.updateImgMapFromPixels(),this.#Ie(),r&&r(),this._isRunning&&(this.#ie=!1,this.#Ae(s.PIXELS)))}#Ae(t){const e=this._pixels,i=this._pxStates;this.saveStep(),this.usesWebWorkers?this._physicsUnit.postMessage({type:t,pixels:e,pxStates:i},[e.buffer,i.buffer]):this.#ie=!0}#Ie(){const t=this._queuedBufferOperations,e=t.length;for(let i=0;i<e;i++)t[0](),t.shift()}#ne(){const t=Object.entries(this._colorSettings).filter(t=>t[0].toUpperCase()===t[0]).map(t=>t[1]),e=t.length,i=4*this._mapGrid.pixelSize,s=Simulation.#Jt;for(let r=0,n=0;n<e;r=r?2*r:1,n++){const e=new Uint8ClampedArray(i),[a,o,l,h]=t[n],_=255*h;for(let t=0;t<i;t++){const i=4*t;e[i]=a,e[i+1]=o,e[i+2]=l,e[i+3]=_}s[r]=e}}#re(){Simulation.#te=this._mapGrid.getDrawableGridLines(),Simulation.#ee=Render.getRect([0,0],...this._mapGrid.globalDimensions)}#Ce(){const t=this.mouse,e=this._mapGrid.globalDimensions;t.updateListener(Mouse.LISTENER_TYPES.ENTER,this._mouseListenerIds[0],[[0,0],e]),t.updateListener(Mouse.LISTENER_TYPES.MOVE,this._mouseListenerIds[1],[[0,0],e]),t.updateListener(Mouse.LISTENER_TYPES.LEAVE,this._mouseListenerIds[2],[[0,0],e])}setKeyBinds(t=Simulation.DEFAULT_KEYBINDS){const e=this._CVS.typingDevice,i=TypingDevice.LISTENER_TYPES.DOWN;Object.entries(t).filter(t=>t[1].defaultFunction).forEach(([t,s])=>{const{defaultFunction:r,defaultParams:n,keys:a,triggerType:o}=s;e.addListener(i,a,(t,e)=>this.#me(t,e,()=>this[r](...n||[]),s),o)}),t.MY_CUSTOM_SIZE_KEYBIND&&e.addListener(i,t.MY_CUSTOM_SIZE_KEYBIND.keys,(e,i)=>this.#me(e,i,()=>{this.updateMapSize(48,38),this.updateMapPixelSize(18)},t.MY_CUSTOM_SIZE_KEYBIND),t.MY_CUSTOM_SIZE_KEYBIND.triggerType)}#me(t,e,i,s){const r=CDEUtils.isFunction(i),{requiredKeys:n,cancelKeys:a,preventDefault:o}=s;o&&void 0===e.target.value&&e.preventDefault(),r?n&&!t.isDown(n)||a&&t.isDown(a)||i.bind(this)():this.#Re(SETTINGS.STANDALONE_KEYBIND_WARN)}#le(t){t.rightClicked||this.#ce(t)}#he(){this.#se=null}#_e(){this.#se=null,this._isMouseWithinSimulation=!1}#ce(t){const e=this._mapGrid.getLocalMapPixel(t.pos);if(this._isMouseWithinSimulation&&e){const t=this._isRunning,[i,s]=e,[r,n]=this.#se||e,a=i-r,o=s-n,l=Math.max(Math.abs(a),Math.abs(o));if(this.smoothDrawingEnabled&&l)for(let t=0;t<l;t++){const e=(t+1)/l;this.placePixelsWithBrush(r+a*e|0,n+o*e|0)}else this.placePixelsWithBrush(i,s);this.#se=e,t||this.updateImgMapFromPixels()}}#Oe(t,e){const i=this._CVS.zoom+(e<0?this.zoomInIncrement:this.zoomOutIncrement);return i>this.minZoomThreshold&&i<this.maxZoomThreshold&&(this._CVS.zoomAtPos(t,i),t)}#ae(){const t=this._CVS;if(Canvas.preventNativeZoom((e,i)=>{this.dragAndZoomCanvasEnabled&&!i&&this.#Oe(t.getCenter(),e)}),this.dragAndZoomCanvasEnabled){const e=t.frame,i=t.mouse;let s=!1,r=[0,0];return e.addEventListener("wheel",t=>{this.dragAndZoomCanvasEnabled&&this.#Oe(i.rawPos,t.deltaY)&&(r=[...i.rawPos])}),e.addEventListener("mousedown",e=>{this.dragAndZoomCanvasEnabled&&(e.button===Mouse.BUTTON_TYPES.RIGHT?(s=!0,r=[e.clientX,e.clientY]):e.button===Mouse.BUTTON_TYPES.MIDDLE&&t.resetTransformations(!0))}),e.addEventListener("mousemove",e=>{if(this.dragAndZoomCanvasEnabled&&s){const{clientX:i,clientY:s}=e,[n,a]=t.viewPos,o=i-r[0],l=s-r[1];t.moveViewAt([n+o,a+l]),r=[i,s]}}),e.addEventListener("mouseup",t=>{s&&t.button===Mouse.BUTTON_TYPES.RIGHT&&(s=!1)}),e.addEventListener("contextmenu",t=>t.preventDefault()),!0}return!1}placePixel(t,e=this._selectedMaterial){if(!this.#ie)return void this._queuedBufferOperations.push(()=>this.placePixel(t,e));const i=this._mapGrid.mapPosToIndex(t);this._pixels[i]=e,this._pxStates[i]=0}placePixelAtCoords(t,e,i=this._selectedMaterial){if(!this.#ie)return void this._queuedBufferOperations.push(()=>this.placePixelAtCoords(t,e,i));const s=this._mapGrid.mapPosToIndexCoords(t,e);this._pixels[s]=i,this._pxStates[s]=0}placePixelAtIndex(t,e=this._selectedMaterial){this.#ie?(this._pixels[t]=e,this._pxStates[t]=0):this._queuedBufferOperations.push(()=>this.placePixelAtIndex(t,e))}placePixelsWithBrush(t,e,i=this._brushType){const s=Simulation.BRUSH_TYPES;if(i&Simulation.#qt.SMALL_OPTIMIZED)i!==s.LINE3&&i!==s.VERTICAL_CROSS||this.fillArea([t,e-1],[t,e+1]),i!==s.ROW3&&i!==s.VERTICAL_CROSS||(t&&this.placePixelAtCoords(t-1,e),t!==this._mapGrid.mapWidth-1&&this.placePixelAtCoords(t+1,e)),this.placePixelAtCoords(t,e);else if(i===s.BIG_DOT)t-2>=0&&this.placePixelAtCoords(t-2,e),t+2<this._mapGrid.mapWidth&&this.placePixelAtCoords(t+2,e),this.placePixelAtCoords(t,e-2),this.placePixelAtCoords(t,e+2),this.fillArea([t-1,e-1],[t+1,e+1]);else if(i&Simulation.#qt.X){const s=Simulation.#Zt[i]/2|0;this.fillArea([t-s,e-s],[t+s,e+s])}}clear(){this.fill(Simulation.MATERIALS.AIR)}fill(t=this._selectedMaterial){if(!this.#ie)return void this._queuedBufferOperations.push(()=>this.fill(t));const e=this._pixels,i=this._lastPixels,s=e.length;i.set(new Uint16Array(s).subarray(0,i.length).fill(t+1)),e.set(new Uint16Array(s).fill(t)),this._isRunning||this.updateImgMapFromPixels()}fillArea(t,e,i=this._selectedMaterial){if(!this.#ie)return void this._queuedBufferOperations.push(()=>this.fillArea(t,e,i));const s=this._pixels.length,r=this._mapGrid,n=r.mapWidth,a=t[0]<0?0:t[0],o=t[1]<0?0:t[1],l=e[0]<0?0:e[0],h=e[1]<0?0:e[1];for(let t=r.mapPosToIndex([a,o]);t<s;t++){let e=t/n|0,s=t-e*n,r=s>l,_=e>h,c=s<a,u=e<o;if(r&&!_&&(t+=n-(l-a+2)+1,e=t/n|0,s=t-e*n,r=s>l,_=e>h,c=s<a,u=e<o),c&&(t+=a,s=t-e*n,r=s>l,c=s<a),_)break;this.placePixelAtIndex(t,i)}this._isRunning||this.updateImgMapFromPixels()}#Se(){const t=this._mapGrid.arraySize,e=new Uint16Array(t);return e.set(this._pixels.subarray(0,t)),e}load(t,e=null){if(!this.#pe(SETTINGS.NOT_INITIALIZED_LOAD_WARN))if(this.#ie){if(t){if(t instanceof Uint16Array)this.#De(e[0],e[1],this._mapGrid.mapWidth,this._mapGrid.mapHeight,t);else if("string"==typeof t){const[i,s,r]=t.split(Simulation.EXPORT_SEPARATOR),n=r.split(","),[a,o,l]=s.split(",").map(t=>+t);let h=null;if(e&&(this.updateMapSize(a,o),this.updateMapPixelSize(l)),i==Simulation.EXPORT_STATES.RAW)h=new Uint16Array(n);else if(i==Simulation.EXPORT_STATES.COMPACTED){let t=n.length,e=0;h=new Uint16Array(a*o);for(let i=0;i<t;i+=2){const t=n[i+1];h.set(new Uint16Array(t).fill(n[i]),e),e+=+t}}this.#De(a,o,this._mapGrid.mapWidth,this._mapGrid.mapHeight,h)}else this._pixels=new Uint16Array(Object.values(t));this.updateImgMapFromPixels()}}else this._queuedBufferOperations.push(()=>this.load(t,e))}exportAsText(t,e){if(!this.#ie)return void this._queuedBufferOperations.push(()=>e&&e(this.exportAsText(t)));let i=this._pixels,s=i.length,r=Simulation.EXPORT_STATES.COMPACTED,n="";if(t)r=Simulation.EXPORT_STATES.RAW,n+=i.toString();else{let t,e=-1;n=[];for(let r=0;r<s;r++){const s=i[r];t===s?n[e][1]++:n[++e]=[s,1],t=s}n=n.toString()}return r+Simulation.EXPORT_SEPARATOR+this._mapGrid.dimensions+","+this._mapGrid.pixelSize+Simulation.EXPORT_SEPARATOR+n}PERF_TEST_FUN(){this.updateMapPixelSize(2),this.updateMapSize(400,300),this.fill(Simulation.MATERIALS.AIR)}PERF_TEST_FULL_WATER_REG(){this._userSettings.showGrid=!1,this.updateMapPixelSize(1),this.updateMapSize(700,600),this.fill(Simulation.MATERIALS.WATER)}PERF_TEST_FULL_WATER_HIGH(){this._userSettings.showGrid=!1,this.updateMapPixelSize(1),this.updateMapSize(1e3,1e3),this.fill(Simulation.MATERIALS.WATER)}get CVS(){return this._CVS}get render(){return this._CVS._render}get ctx(){return this._CVS._ctx}get mouse(){return this._CVS.mouse}get keyboard(){return this._CVS.keyboard}get mapGrid(){return this._mapGrid}get loopExtra(){return this._loopExtra}get stepExtra(){return this._stepExtra}get pxStepUpdated(){return this._pxStepUpdated}get pxStates(){return this._pxStates}get lastPixels(){return this._lastPixels}get lastStepTime(){return this._lastStepTime}get pixels(){return this._pixels}get mapGridRenderStyles(){return this._mapGridRenderStyles}get mapBorderRenderStyles(){return this._mapBorderRenderStyles}get offscreenCanvas(){return this._offscreenCanvas}get imgMap(){return this._imgMap}get isMouseWithinSimulation(){return this._isMouseWithinSimulation}get selectedMaterial(){return this._selectedMaterial}get sidePriority(){return this._sidePriority}get isRunning(){return this._isRunning}get backStepSavingMaxCount(){return this._backStepSavingMaxCount}get backStepSaves(){return this._backStepSaves}get brushType(){return this._brushType}get worldStartSettings(){return this._worldStartSettings}get userSettings(){return this._userSettings}get colorSettings(){return this._colorSettings}get initialized(){return this._initialized}get queuedBufferOperations(){return this._queuedBufferOperations}get aimedFPS(){return this._CVS.fpsLimit}get backStepSavingEnabled(){return Boolean(this._backStepSavingMaxCount)}get useLocalPhysics(){return this._physicsUnit instanceof LocalPhysicsUnit}get usesWebWorkers(){return Boolean(this._physicsUnit)&&!(this._physicsUnit instanceof LocalPhysicsUnit)}get isFileServed(){return location.href.startsWith("file")}get showGrid(){return this._userSettings.showGrid}get showBorder(){return this._userSettings.showBorder}get smoothDrawingEnabled(){return this._userSettings.smoothDrawingEnabled}get visualEffectsEnabled(){return this._userSettings.visualEffectsEnabled}get warningsDisabled(){return this._userSettings.warningsDisabled}get dragAndZoomCanvasEnabled(){return this._userSettings.dragAndZoomCanvasEnabled}get autoSimulationSizing(){return this._userSettings.autoSimulationSizing}get zoomInIncrement(){return this._userSettings.zoomInIncrement}get zoomOutIncrement(){return this._userSettings.zoomOutIncrement}get minZoomThreshold(){return this._userSettings.minZoomThreshold}get maxZoomThreshold(){return this._userSettings.maxZoomThreshold}set loopExtra(t){this._loopExtra=t}set stepExtra(t){this._stepExtra=t}set selectedMaterial(t){return this.updateSelectedMaterial(t)}set isRunning(t){this._isRunning=t}set brushType(t){return this.updateBrushType(t)}set sidePriority(t){return this.updateSidePriority(t)}set backStepSavingMaxCount(t){this._backStepSavingMaxCount=t}set mapGridRenderStyles(t){this._mapGridRenderStyles=t}set mapBorderRenderStyles(t){return this._mapBorderRenderStyles=t}set showGrid(t){this._userSettings.showGrid=t}set showBorder(t){this._userSettings.showBorder=t}set smoothDrawingEnabled(t){this._userSettings.smoothDrawingEnabled=t}set visualEffectsEnabled(t){this._userSettings.visualEffectsEnabled=t}set warningsDisabled(t){this._userSettings.warningsDisabled=t}set aimedFPS(t){this._CVS.fpsLimit=t}set autoSimulationSizing(t){this._userSettings.autoSimulationSizing=t,t&&this.autoFitSize(t)}set dragAndZoomCanvasEnabled(t){this._userSettings.dragAndZoomCanvasEnabled=t,t||CVS.resetTransformations(!0)}set minZoomThreshold(t){this._userSettings.minZoomThreshold=t}set maxZoomThreshold(t){this._userSettings.maxZoomThreshold=t}set zoomInIncrement(t){this._userSettings.zoomInIncrement=t}set zoomOutIncrement(t){this._userSettings.zoomOutIncrement=t}}